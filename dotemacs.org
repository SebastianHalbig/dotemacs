#+TITLE: Emacs literate configuration
#+AUTHOR: Sebastian Halbig
#+DATE: 03/2024
#+STARTUP: show2levels indent hidestars
#+PROPERTY: header-args :tangle (let ((org-use-tag-inheritance t)) (if (member "INACTIVE" (org-get-tags))  "no" "~/.emacs.d/init.el")))

* Documentation
** Forewords

This document is a literate configuration for GNU Emacs written in [[https://orgmode.org/][org]] format. Its main sources of inspiration are
- [[https://github.com/rougier/dotemacs][Nicolas Rougier]] (main reference point),
- [[https://protesilaos.com/emacs/dotemacs#][Protesilaos Stavrou]], and
- [[https://gitlab.com/slotThe/dotfiles/-/tree/master/emacs][Tony Zorman]] (from whom I learnt about emacs).

Its aim is to make emacs my digital companion for my everyday life. That means
 + Offering a comprehensive (La)TeX ecosystem
   - Efficient LaTeX writing in a semi wysiwyg-envirnoment
     + AucTeX with synctex enabled (compilation via latexmk)
     + cdlatex and lsp-server for faster input of formulas
     + Snippets (yasnippet) to handle insertion of "phrases" such as section, and environments
     + Many other small helpers (for details see below)
   - Handling bibliographies (also see below)
     + Reftex and citar for citation and reference insertions
     + Biblio (with a zbMath backend) to fetch citation-sources from zbMath.
     + Bibtex for formatting citations in a uniform way
     + ebib for managing citations
     + zotra for downloading pdfs with a naming scheme derived from bibtex-related parameters.
 + Handling emails (mu4e in conjunction with org-mode)
 + Capturing and organising tasks (org-agenda and org-capture)
 + Writing sketches (org and its export functionalities)
 + Many big and small goodies such as being able to control spotify from within emacs.

To extract the init.el and early-init.el files from this document, execute ~C-c C-v C-t~ ([[help:org-babel-tangle][org-babel-tangle]]). We will make use of the [[https://github.com/jwiegley/use-package][use-package]] ecosystem for the configuration of packages. In order to present the code-snippets in readable sizes, we will use the [[https://orgmode.org/manual/Noweb-Reference-Syntax.html][noweb-syntax]].

Each subsection may be tagged with:

  * =:BINDING:=  The section defines some key binding
  * =:FACE:=     The section modifies some face
  * =:HOOK:=     The section installs some hook

Aside from these standard tags, there are two more tags, indicating some kind of unintended behaviour.

  * =:BUGFIX:=   The section contains (temporary) bug fix code
  * =:INACTIVE:= The content of the section won't be exported


The documentation of each package-based (sub-)section is build like follows:
+ A link to the repository containing the package (optional)
+ A short descriptive summary of the package (often being a quote from the readme of the package).
+ A link to a blog or webpage the current setup is derived from.
+ Optionally some explanations why (but not how) things are done in a certain way.

This philosophy results in relatively short explanations and at least tries to avoid that the actual code and its description are out-of-sync.
** [1/18] Open Tasks
- [ ] Write a transient for elpaca.
- [ ] Modify elpacs keybindings.
- [ ] Integrate Werner's nomenclature into rainbow mode. A possible starting point is this pull request integrating [[https://github.com/a13/open-color.el/pull/1][rainbow colours in open colour]].
- [ ] Use Werner's nomenclature in colour-coding instead of the hex values.
- [ ] Change colour of org blocks. For example purplish-white (#f4f6fb).
- [ ] Modify the Victor mono font to be compatible with Roboto mono.
- [ ] Write a transient (i.e. 21st century) date-picker.
- [ ] Create/use a template system for latex-based projects.
- [X] Move the early-loading of org to a later stage.
- [ ] Org agenda align tags.
- [ ] BUGFIX: Only in some situations does org-gtd expand "inbox" to "inbox.org". this is weird.
- [ ] Org caldav integration
- [ ] Modify org-timeblock colours.
- [ ] BUGFIX: org-timeblock columns has a wrong width.(See the subsection)
- [ ] BUGFIX: org-timeblock-quit close all agenda buffers.
- [ ] BUGFIX: mu4e execute "make-symbolic-link" in pre-build as sudo
- [ ] Switch from lsp to eglot for texlab and ltex.
- [ ] Mu4e: Do not hardcode the tags for refiling:
  - [ ] my-prettify-tag-alist -> plist whose entries are ("tag-as-string" "tag-refile-folder" "tag-as-unicode-symbol")
  - [ ] Remove mu4e-tagging-tags
  - [ ] Remove hard-coded references to message tags.
** Header

This will generate a header at the top of the tangled file to indicate it is generated and is not meant to be modified directly.

#+begin_src emacs-lisp :epilogue (format-time-string ";; Last generated on %c")

;; -*- lexical-binding: t -*-
;; This file has been generated from dotemacs.org file. DO NOT EDIT.
;; Based on from https://github.com/rougier/dotemacs

;; Copyright (C) 2024 Sebastian Halbig

;; This file is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 3, or (at your option)
;; any later version.

;; This file is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; For a full copy of the GNU General Public License
;; see <https://www.gnu.org/licenses/>.

#+end_src
* Early init :HOOK:
:PROPERTIES:
:header-args:emacs-lisp: :tangle "~/.emacs.d/early-init.el"
:END:

The [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Early-Init-File.html][early-init]] code is taken almost verbatim from [[https://protesilaos.com/emacs/dotemacs#h:7b7b5898-09f7-4128-8af0-4041f67cb729][Prot's config]] and combined with the early-init of [[https://github.com/rougier/dotemacs/blob/master/dotemacs.org][Rougier]].

#+begin_src emacs-lisp
(setq frame-title-format '("%b")                ; We put the frame title into the "header"
      ring-bell-function 'ignore                ; We do not want any bells
      use-short-answers t                       ; y/n instead of yes/no
      inhibit-splash-screen t                   ; Disable the splash screen
      inhibit-startup-screen t                  ; Disable the startup screen
      inhibit-startup-echo-area-message t       ; Disable initial echo message
      initial-scratch-message ""                ; Empty the initial *scratch* buffer
      initial-buffer-choice nil                 ; Open *scratch* buffer at init
      site-run-file nil                         ; No site-wide run-time initializations.
      inhibit-default-init t                    ; No site-wide default library
      gc-cons-threshold most-positive-fixnum    ; Very large threshold for garbage
                                                ; collector during init
      package-enable-at-startup nil             ; We'll use elpaca.el
      native-comp-async-report-warnings-errors nil ; Skip compilation error buffers
      ad-redefinition-action 'accept            ; Silence warnings for redefinition
      read-process-output-max (* 1024 1024)     ; Increase read size per process
      confirm-kill-processes nil)               ; Emacs should not ask for confiration to
                                                ; kill a process

(menu-bar-mode -1)   ; Disable menu-bar
(scroll-bar-mode -1) ; Disable scroll-bar
(tool-bar-mode -1)   ; Disable tool-bar
(tooltip-mode -1)    ; Disable tooltips


(add-hook 'after-init-hook (lambda () (set-frame-name "home"))) ; First frame is "home"

;; List of directories to look for natively-compiled *.eln files.
(setq native-comp-eln-load-path
      (list (expand-file-name "eln-cache" user-emacs-directory)))

;;As suggested in the manual, we disable the standard package manager at startup.
(setq package-enable-at-startup nil)

;; Reset garbage collector limit after init process has ended (8Mo)
(add-hook 'after-init-hook
          #'(lambda () (setq gc-cons-threshold (* 8 1024 1024))))
#+end_src
* Emacs-internal configurations
We specify the skeleton for our fundamental emacs configurations such as our choice of package manager here.
The actual code-blocks will be found in different sections and inserted once the document is tangled.

#+begin_src emacs-lisp :noweb yes
<<elpaca-bootstrap>>

(use-package emacs
  :demand t
  :config
  <<elpaca-use-package-integration>>
  <<emacs-defaults>>
  <<no-custom-files>>
  <<enable-disable-commands>>
  <<encoding>>
  <<auto-save>>
  <<unpropertise-kill-ring>>
  <<savehistory-settings>>
  <<savehistory-duplicates>>
  <<start-savehistory-mode>>
  <<save-vistited-mode>>
  <<save-buffers>>
  <<recursive-minibuffers>>
  <<server>>
  <<cus-edit>>
  <<todo-faces>>
  (elpaca-wait)
  )
#+end_src
* Elpaca :HOOK:

We will use [[https://github.com/progfolio/elpaca][Elpaca]] as the package manager for this config.
A short summary of its functionality taken from its documentation is as follows:

#+BEGIN_quote
Elpaca is an elisp package manager. It allows users to find, install, update, and remove third-party packages for Emacs. It is a replacement for the built-in Emacs package manager, package.el.

Elpaca:

+ Installs packages asynchronously, in parallel for fast, non-blocking installations.
+ Includes a flexible UI for finding and operating on packages.
+ Downloads packages from their sources for convenient elisp development.
+ Supports thousands of elisp packages out of the box (MELPA, NonGNU/GNU ELPA, Org/org-contrib).
+ Makes it easy for users to create their own ELPAs.
#+end_quote

Like straight, one needs to bootstrap elpaca.
#+NAME: elpaca-bootstrap
#+begin_src emacs-lisp :tangle no
(defvar elpaca-installer-version 0.6)
(defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
(defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
(defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
(defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                              :ref nil
                              :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                              :build (:not elpaca--activate-package)))
(let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
       (build (expand-file-name "elpaca/" elpaca-builds-directory))
       (order (cdr elpaca-order))
       (default-directory repo))
  (add-to-list 'load-path (if (file-exists-p build) build repo))
  (unless (file-exists-p repo)
    (make-directory repo t)
    (when (< emacs-major-version 28) (require 'subr-x))
    (condition-case-unless-debug err
        (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                 ((zerop (call-process "git" nil buffer t "clone"
                                       (plist-get order :repo) repo)))
                 ((zerop (call-process "git" nil buffer t "checkout"
                                       (or (plist-get order :ref) "--"))))
                 (emacs (concat invocation-directory invocation-name))
                 ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                       "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                 ((require 'elpaca))
                 ((elpaca-generate-autoloads "elpaca" repo)))
            (progn (message "%s" (buffer-string)) (kill-buffer buffer))
          (error "%s" (with-current-buffer buffer (buffer-string))))
      ((error) (warn "%s" err) (delete-directory repo 'recursive))))
  (unless (require 'elpaca-autoloads nil t)
    (require 'elpaca)
    (elpaca-generate-autoloads "elpaca" repo)
    (load "./elpaca-autoloads")))
(add-hook 'after-init-hook #'elpaca-process-queues)
(elpaca `(,@elpaca-order))
#+end_src
** use-package integration

We will use elpaca in conjunction with use-package.
The elpaca-documentation suggests the following piece of code for the integration of elpaca into use-package.

#+NAME: elpaca-use-package-integration
#+begin_src emacs-lisp :tangle no
(elpaca elpaca-use-package
  ;; Enable :elpaca use-package keyword.
  (elpaca-use-package-mode)
  ;; Assume :elpaca t unless otherwise specified.
  (setq elpaca-use-package-by-default t))
#+end_src
* Early-loading of org
We use the main branch of org. Due to the high dependence of other packages on org, one needs to load it as soon as possible. The real configuration of org is in the section called "[[Org mode][Org mode]]". We ensure that it is tangled "here" by using [[https://orgmode.org/manual/Noweb-Reference-Syntax.html][noweb]] syntax.
#+begin_src emacs-lisp :noweb yes
<<org-config>>
#+end_src
* Fundamental and early settings :HOOK:

Many of the ideas here are a mix of [[https://protesilaos.com/emacs/dotemacs#h:dae63bd9-93a8-41c4-af1b-d0f39ba50974][Prot's config]] and [[https://github.com/rougier/dotemacs][Rougier's config]].
If other sources are used, they are specifically mentioned.
** Emacs defaults

#+NAME: emacs-defaults
#+begin_src emacs-lisp :noweb yes :tangle no
(setq-default indent-tabs-mode nil        ; Stop using tabs to indent
              tab-always-indent 'complete ; Indent first then try completions
              tab-width 2)                ; Smaller width for tab characters

(setq-default fill-column 100                         ; Default line width
              sentence-end-double-space nil           ; Use a single space after dots
              bidi-paragraph-direction 'left-to-right ; Faster
              truncate-string-ellipsis "…")           ; Nicer ellipsis
#+end_src
** Keeping emacs.d clean: Recentf and no-littering

[[https://vincent.demeester.fr/articles/emacs_keep_it_clean][Vincent Demeester]] is, according to his bio, a developer working at "Red Hat". He has probably forgotten more about good code that what I will ever know so I will follow his advice.

*** Recentf

The following code will allow for an integration between dired and recentf.

#+NAME: my-recentf-rename-notify
#+begin_src emacs-lisp :tangle no
(defun my-recentf-rename-notify (oldname newname &rest args)
  "Change file or directory OLDNAME in the recentf list to NEWNAME"
  (if (file-directory-p newname)
      (my-recentf-rename-directory oldname newname)
    (my-recentf-rename-file oldname newname)))
#+end_src

#+NAME: my-recentf-rename-file
#+begin_src emacs-lisp :tangle no
(defun my-recentf-rename-file (oldname newname)
  "Change the OLDNAME of a file in the recentf list to NEWNAME"
  (setq recentf-list
        (--map (if (string-equal it oldname)
                   newname
                 oldname)
               recentf-list))
  recentf-cleanup)
#+end_src

#+NAME: my-recentf-rename-directory
#+begin_src emacs-lisp :tangle no
(defun my-recentf-rename-directory (oldname newname)
  "Chage OLDNAME to NEWNAME"
  ;; oldname, newname and all entries of recentf-list should already
  ;; be absolute and normalised so I think this can just test whether
  ;; oldname is a prefix of the element.
  (setq recentf-list
        (--map (if (string-prefix-p oldname it)
                   (concat newname (substring it (length oldname)))
                 it)
               recentf-list))
  recentf-cleanup)
#+end_src
We can now configure recentf.

#+begin_src emacs-lisp :noweb yes
(use-package recentf
  :elpaca nil
  :config
  <<my-recentf-rename-notify>>
  <<my-recentf-rename-file>>
  <<my-recentf-rename-directory>>
  (setq recentf-max-saved-items 200           ; length of the "recent list"
        recentf-max-menu-items 20             ; length of the "recentf menu list"
        recentf-auto-cleanup 360              ; Clean up recentf if emacs was idle
                                              ; for 6 minutes
        recentf-show-file-shortcuts-flag nil) ; show "[N]" for the Nth item
  (recentf-mode 1)                            ; turn on recentf
  ;; Do not save ssh, su or sudo commands.
  (add-to-list 'recentf-exclude "^/\\(?:ssh\\|su\\|sudo\\)?:")
  ;; Magic advice to rename entries in recentf when moving files in
  ;; dired.
  (advice-add 'dired-rename-file :after #'my-recentf-rename-notify))

#+end_src

*** No littering

#+begin_src emacs-lisp
(use-package no-littering
  :elpaca (:type git :host github :repo "emacscollective/no-littering")
  :after recentf
  :demand t
  :init
  (setq no-littering-etc-directory ; Directory of config files of packages.
        (expand-file-name "config/" user-emacs-directory)
        no-littering-var-directory ; Directory of persistent files of packages.
        (expand-file-name "data/" user-emacs-directory))
  :config
  (add-to-list 'recentf-exclude no-littering-etc-directory) ; Recentf exculdes the etc dir
  (add-to-list 'recentf-exclude no-littering-var-directory) ; Recentf excludes the var dir
  (setq create-lockfiles nil   ; I do not need lock files since I do not use mult. editors
        make-backup-files t    ; Backup of a file the first time it is saved.
        backup-by-copying t    ; Don't clobber symlinks
        delete-by-moving-to-trash t  ; Delete files to trash
        delete-old-versions t  ; I have version controll and do not need excess old versions
        kept-new-versions 6    ; Newest versions to keep when new backup is made
        kept-old-versions 2    ; Oldest versions to keep when new backup is made
        vc-make-backup-files t ; No backup of files under version contr
        version-control t)     ; Make numeric backup versions
  (setq backup-directory-alist ; Alist of file name patterns and backup directory names
        `((".*" . ,(no-littering-expand-var-file-name "backups/")))))
#+end_src
** No custom files

#+NAME: no-custom-files
#+begin_src emacs-lisp :tangle no
;; Disable the emacs custom block by making it disposable.
(setq custom-file (make-temp-file "emacs-custom-"))
#+end_src
** Default input method, ergoemacs and and multilingual environments

We use [[https://ergoemacs.github.io/][ergoemacs]] to change many keybindings to a more modern version.
It provides a complete overhaul of the standard keybindings and therefore has to be loaded prior to any other module.
Additionally, we combine it with a multilingual input setup.
To switch between input methods use [[help:toggle-input-method][toggle-input-method]] which is bound to "C-\".

#+begin_src emacs-lisp
(use-package ergoemacs-mode
  :config
  (setq ergoemacs-theme nil)            ; Uses Standard Ergoemacs keyboard theme
  (setq ergoemacs-keyboard-layout "us") ; Assumes QWERTY keyboard layout
  (ergoemacs-mode 1)                    ; Globally enables ergoemacs-mode
  (set-language-environment "English")  ; Set up multilingual environment
  (setq default-input-method "german"   ; need an umlaut? get an umlaut.
        default-transient-input-method "german")
  )
(elpaca-wait)
#+end_src
** Enable and disable certain commands

#+NAME: enable-disable-commands
#+begin_src emacs-lisp :tangle no
;; Enable these
(mapc
 (lambda (command)
   (put command 'disabled nil))
 '(list-timers narrow-to-region narrow-to-page upcase-region downcase-region))

;; And disable these
(mapc
 (lambda (command)
   (put command 'disabled t))
 '(eshell project-eshell overwrite-mode iconify-frame diary))
#+end_src
** Encoding

We tell emacs to use UTF-8 encoding as much as possible.

#+NAME: encoding
#+begin_src emacs-lisp :tangle no

(set-default-coding-systems 'utf-8)     ; Default to utf-8 encoding
(prefer-coding-system       'utf-8)     ; Add utf-8 at the front for automatic detection.
(set-terminal-coding-system 'utf-8)     ; Set coding system of terminal output
(set-keyboard-coding-system 'utf-8)     ; Set coding system for keyboard input on TERMINAL

#+end_src
** Auto-save

If Emacs or the computer crashes, you can recover the files you were editing at the time of the crash from their auto-save files. To do this, start Emacs again and type the command ~M-x recover-session~. Here, we parameterise how files are saved in the background.

#+Name: auto-save
#+begin_src emacs-lisp :tangle no
(setq auto-save-list-file-prefix ; Prefix for generating auto-save-list-file-name
      (expand-file-name ".auto-save-list/.saves-" user-emacs-directory)
      auto-save-default t        ; Auto-save every buffer that visits a file
      auto-save-timeout 30       ; Number of seconds between auto-save
      auto-save-interval 200)    ; Number of keystrokes between auto-saves
#+end_src
** History

Remove text properties for kill ring entries (see https://emacs.stackexchange.com/questions/4187). This saves a lot of time when loading it.

#+NAME: unpropertise-kill-ring
#+begin_src emacs-lisp :tangle no

(defun unpropertise-kill-ring ()
  "Save string in the kill-ring without text properties"
  (setq kill-ring (mapcar 'substring-no-properties kill-ring)))

(add-hook 'kill-emacs-hook 'unpropertise-kill-ring)

#+end_src

We save every possible history we can think of.

#+NAME: savehistory-settings
#+begin_src emacs-lisp :tangle no

(setq kill-ring-max 50      ; Maximum length of kill-ring
      history-length 50)    ; Maximum length of history before truncation starts

(setq savehist-additional-variables ; Additionally save these
      '(kill-ring
        command-history
        set-variable-value-history
        custom-variable-history
        query-replace-history
        read-expression-history
        minibuffer-history
        read-char-history
        face-name-history
        bookmark-history
        file-name-history))

;; Length of some histories

(put 'minibuffer-history         'history-length 50)
(put 'file-name-history          'history-length 50)
(put 'set-variable-value-history 'history-length 25)
(put 'custom-variable-history    'history-length 25)
(put 'query-replace-history      'history-length 25)
(put 'read-expression-history    'history-length 25)
(put 'read-char-history          'history-length 25)
(put 'face-name-history          'history-length 25)
(put 'bookmark-history           'history-length 25)

#+end_src

No duplicates in history

#+NAME: savehistory-duplicates
#+begin_src emacs-lisp :tangle no

(setq history-delete-duplicates t) ; No duplicates

#+end_src

Start history mode.

#+NAME: start-savehistory-mode
#+begin_src emacs-lisp :tangle no
(let (message-log-max)
  (savehist-mode)) ;start history mode

(setq savehist-file (concat user-emacs-directory "history.el")) ; specify the savehist file
#+end_src

Enable auto-save-visited-mode

#+NAME: save-vistited-mode
#+begin_src emacs-lisp :tangle no

(auto-save-visited-mode) ; start auto-save-visited mode

#+end_src

A buffer can get out of sync with respect to its visited file on disk if that file is changed by another program. This is prevented by auto revert mode

#+begin_src emacs-lisp

(use-package autorevert
  :elpaca nil
  :config
  (setq auto-revert-verbose t) ; Generates a message whenever a buffer is reverted
  (global-auto-revert-mode))   ; Start global-auto-revert-mode

#+end_src
** Saving buffers

#+NAME: save-buffers
#+begin_src emacs-lisp :tangle no

(add-hook 'before-save-hook 'delete-trailing-whitespace) ; On save, delete trailing whitespaces
(setq require-final-newline t)                           ; Require a final newline—POSIX BOIS

#+end_src
** Restoring buffer positions on load.

Record cursor position using [[https://github.com/emacs-mirror/emacs/blob/master/lisp/saveplace.el][saveplace]].

#+begin_src emacs-lisp

(use-package saveplace
  :elpaca nil
  :config
  (setq save-place-file (expand-file-name "saveplace" user-emacs-directory))
                                              ; Location of the saveplace file
  (setq save-place-forget-unreadable-files t) ; Ignore unreadable files
  (save-place-mode 1))                        ; Start save-place-mode

#+end_src
** Allow for recursive minibuffers

We want to use [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Recursive-Mini.html][recursive minibuffers]].

#+NAME: recursive-minibuffers
#+begin_src emacs-lisp :tangle no
(setq enable-recursive-minibuffers t)
#+end_src
** Server

We run emacs as a [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html][server]].

#+NAME: server
#+begin_src emacs-lisp :tangle no

(require 'server)

(unless (server-running-p)
  (server-start))

#+end_src
* Helpers
** Cus edit

[[https://github.com/emacs-mirror/emacs/blob/master/lisp/cus-edit.el][Cus edit]] implements the code to create and edit customize buffers.

#+NAME: cus-edit
#+begin_src emacs-lisp :tangle no
(setq-default
 custom-unlispify-menu-entries nil       ; Prefer kebab-case for titles
 custom-unlispify-tag-names nil)         ; Prefer kebab-case for symbols
#+end_src
** Dash
[[https://github.com/magnars/dash.el][
Dash]] makes working with lists better.

#+begin_src emacs-lisp
(use-package dash
  :demand t)
#+end_src
* Design :FACE:HOOK:BIND:
The design is based on a variant of [[https://github.com/rougier/nano-emacs][nano-emacs]] called [[https://github.com/Lambda-Emacs/lambda-themes][lambda-themes]].

#+begin_quote
Lambda-themes is a collection of four higher and lower contrast light and dark themes. The color palette is limited, and organized according to function and salience. Here I largely agree with Nicolas Rougier that attentional constraints matter when thinking about the color palette. Lambda-themes tries to use color in a way to provide for a reasonable compromise between aesthetics and readability.

In general the theme aims to use as few highly distinct colors as possible without crossing over into full “monochrome” territory. It also means that the themes use various devices other than foreground face color to capture meaningful differences in text. Different text weights are used throughout, as are subtle differences in background coloring. Colored headlines are largely avoided.
#+end_quote
** Lambda theme :BIND:
*** Prelude: Werner's nomenclature

[[https://en.wikipedia.org/wiki/Werner%27s_Nomenclature_of_Colours][Werner's nomenclature of colours]] is a book of named colour samples compiled by the geologist Abraham Gottlob Werner(1749-1817), and subsequently amended by Patrick Syme.
We will use these colours at various places.
#+NAME: werner-colours
#+begin_src emacs-lisp :tangle no
;; whites
(defvar snow-white
  "#f9faf8" "snow-drop")
(defvar reddish-white
  "#faf9fa" "back of the christmas rose")
(defvar purplish-white
  "#f4f6fb" "white geranium or storks bill")
(defvar yellowish-white
  "#fbfbf6" "hawthorn blossom")
(defvar orange-white
  "#fcfaf5" "large wild convolvulus")
(defvar greenish-white
  "#fbfdf8" "polyanthus narcissus")
(defvar skimmed-milk-white
  "#edf0f2" "back of the petals of blue hepatica")
(defvar greyish-white
  "#e7ecef" "white hamburgh grapes")
;; greys
(defvar ash-grey
  "#d1d8dd" "french wood ashes")
(defvar smoke-grey
  "#c0c7d3")
(defvar french-grey
  "#c1cad8")
(defvar pearl-grey
  "#b8c0ce" "back of petals of purple hepatica")
(defvar yellowish-grey
  "#b9bba9" "stems of the barberry")
(defvar bluish-grey
  "#9aa3b7")
(defvar greenish-grey
  "#828d96" "bark of ash tree")
(defvar blackish-grey
  "#494f67" "old stems of hawthorn")
;; blacks
(defvar greyish-black
  "#424451")
(defvar bluish-black
  "#2c2e3e" "crowberry")
(defvar greenish-black
  "#30343e")
(defvar pitch-or-brownish-black
  "#2b272e")
(defvar reddish-black
  "#2b242a" "berry of fuchsia coccinea")
(defvar ink-black
  "#0b0b13" "berry of deadly night shade")
(defvar velvet-black
  "#0a0a0f" "black of red and black west-indian peas")
;; blues
(defvar scotch-blue
  "#110d32" "stamina of single purple anemone")
(defvar prussian-blue
  "#060740" "stamina of bluish purple anemone")
(defvar indigo-blue
  "#475da0")
(defvar china-blue
  "#262a6b" "back parts of gentian flowers")
(defvar azure-blue
  "#5465a5" "grape hyacinth. gentian")
(defvar ultramarine-blue
  "#6077e2" "borrage")
(defvar flax-flower-blue
  "#6d8ad2" "flax flower")
(defvar berlin-blue
  "#7b99dc" "hepatica")
(defvar verditter-blue
  "#80c0d6")
(defvar greenish-blue
  "#78a2c0" "great fennel flower")
(defvar greyish-blue
  "#8da9c6" "small fennel flower")
;; purples
(defvar bluish-lilac-purple
  "#d9ebfe" "blue lilac")
(defvar bluish-purple
  "#7b8eca" "parts of white and purple crocus")
(defvar violet-purple
  "#1e1753" "purple aster")
(defvar pansy-purple
  "#1e1b48" "sweet-scented violet")
(defvar campanula-purple
  "#5b61a8" "canterbury bell. campanula persicifolia")
(defvar imperial-purple
  "#3f3982" "deep parts of flower ofsaffron crocus")
(defvar auricula-purple
  "#361e53" "largest purple auricula")
(defvar plum-purple
  "#29205a" "plum")
(defvar red-lilac-purple
  "#c1c9e8" "red lilac. pale purple primrose")
(defvar lavendar-purple
  "#686c8e" "dried lavendar flowers")
(defvar pale-bluish-purple
  "#32335f")
;; greens
(defvar celandine-green
  "#b6bdae" "back of tussilage leaves")
(defvar mountain-green
  "#aeb197" "thick leaved cudweed, silver leaved almond")
(defvar leek-green
  "#919682" "sea kale, leaves of leeks in winter")
(defvar blackish-green
  "#4b5059" "dark streaks on leaves of cayenne pepper")
(defvar verdigris-green
  "#71aa89")
(defvar bluish-green
  "#a4b3a6" "under disk of wild rose leaves")
(defvar apple-green
  "#abb796")
(defvar emerald-green
  "#97b578")
(defvar grass-green
  "#86996d" "general appearance of grass fields. sweet sugar pear")
(defvar duck-green
  "#334429" "upper disk of yew leaves")
(defvar sap-green
  "#829249" "upper disk of leaves of woody night shade")
(defvar pistachio-green
  "#98a760" "ripe pound pear. hypnum like saxifrage")
(defvar asparagus-green
  "#d0d9b9" "variegated horse-shoe geranium")
(defvar olive-green
  "#6d7f75" "foliage of lignum vitæ")
(defvar oil-green
  "#ad9f61" "nonpareil apple from the wall")
(defvar siskin-green
  "#d7e090" "ripe coalmar pear. irish pitcher apple")
;; yellows
(defvar sulphur-yellow
  "#e2d943" "various coloured snap dragon")
(defvar primrose-yellow
  "#fffeb2" "wild primrose")
(defvar wax-yellow
  "#bd9e32" "greenish parts of nonpareil apple")
(defvar lemon-yellow
  "#f0dd5d" "shrubby goldylocks")
(defvar gamboge-yellow
  "#fbef4e" "yellow jasmine")
(defvar kings-yellow
  "#fff762" "yellow tulip. cinque foil")
(defvar saffron-yellow
  "#dea916" "anthers of saffron crocus")
(defvar gallstone-yellow
  "#a56700" "marigold apple")
(defvar honey-yellow
  "#ad8404")
(defvar straw-yellow
  "#fdf096" "oat straw")
(defvar wine-yellow
  "#e5db75" "white currants")
(defvar sienna-yellow
  "#fdec85" "stamina of honey-suckle")
(defvar ochre-yellow
  "#fbe573")
(defvar cream-yellow
  "#fff6ba")
;; orange
(defvar dutch-orange
  "#f3af00" "common marigold. seedpod of spindle-tree")
(defvar buff-orange
  "#fecf19" "stamina of the large white cistus")
(defvar orpiment-orange
  "#e27000" "indian cress")
(defvar brownish-orange
  "#a62500" "style of the orange lily")
(defvar reddish-orange
  "#d16200" "hemimeris buff hibiscus")
(defvar deep-reddish-orange
  "#cc4700" "scarlet leadington apple")
;; red
(defvar tile-red
  "#d05438" "shrubby pimpernel")
(defvar hyacinth-red
  "#af3b23" "red on the golden rennette apple")
(defvar scarlet-red
  "#ba1f21" "large red oriental poppy, red parts of red and black indian peas")
(defvar vermillion-red
  "#bc2d27" "love apple")
(defvar aurora-red
  "#d65848" "red on the naked apple")
(defvar arterial-blood-red
  "#730004" "corn poppy. cherry")
(defvar flesh-red
  "#fed0a4" "larkspur")
(defvar rose-red
  "#fff2dc" "common garden rose")
(defvar peach-blossom-red
  "#ffe1d6" "peach blossom")
(defvar carmine-red
  "#ec153e" "raspberry, cocks comb, carnation pink")
(defvar lake-red
  "#da0d44" "red tulip, rose officinalus")
(defvar crimson-red
  "#e03d55")
(defvar purplish-red
  "#8b0013" "dark crimson officinal garden rose")
(defvar cochineal-red
  "#a70c17" "under disk of decayed leaves of none-so-pretty")
(defvar veinous-blood-red
  "#630108" "musk flower or dark purple scaious")
(defvar brownish-purple-red
  "#c03c45" "flower of deadly nightshade")
(defvar chocolate-red
  "#750209" "brown disk of common marigold")
(defvar brownish-red
  "#9a0407")
;; browns
(defvar deep-orange-coloured-brown
  "#723b16" "female spike of catstail reed")
(defvar deep-reddish-brown
  "#4d2a17" "dead leaves of green panic grass")
(defvar umber-brown
  "#443116" "disk of rubeckia")
(defvar chesnut-brown
  "#69411d" "chesnuts")
(defvar yellowish-brown
  "#87662a")
(defvar wood-brown
  "#c0a666" "hazel nuts")
(defvar liver-brown
  "#3f3114")
(defvar hair-brown
  "#827748")
(defvar broccoli-brown
  "#958762")
(defvar olive-brown
  "#6b5c3d" "stems of black currant bush")
(defvar blackish-brown
  "#342e14")

#+end_src
*** The theme itself
We use the [[https://github.com/Lambda-Emacs/lambda-themes][lambda theme]]. It comes in four variants:
- light,
- faded light,
- dark, and
- faded dark.

As a slight variant, we use muted colours.
This has to be done in the package itself due to internal reasons.
- lambda-fg dark:  #d1d8dd "french wood ashes"
- lambda-fg light: #424451 "greyish-black"
- lambda-bg dark:  #494f67 "blackish-grey"
- lambda-bg light: #fbfdf8 "greenish-white"


We want less colours and less stress for the eyes both in the light and dark mode.

#+NAME: my-lambda-light-werner
#+begin_src emacs-lisp :tangle no
(defun my-lambda-light-werner ()
  "Load the light variant of a modified lambda theme."
  (progn
    (load-theme 'lambda-light t)
    (set-face-attribute 'lambda-purple nil :foreground "#686c8e");;lavendar-purple
    (set-face-attribute 'lambda-crucial nil :foreground "#686c8e")
    (set-face-attribute 'minibuffer-prompt nil :foreground "#686c8e")
    (set-face-attribute 'header-line nil :background "#fbfdf8") ;;greenish-white
    (set-face-attribute 'lambda-line-active nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-hspace-active nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-hspace-inactive nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-name nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-name nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-primary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-primary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-secondary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-secondary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-tertiary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-tertiary nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-status-RO nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-status-RO nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-status-RW nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-status-RW nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-active-status-MD nil :background "#fbfdf8")
    (set-face-attribute 'lambda-line-inactive-status-MD nil :background "#fbfdf8")))
#+end_src

#+NAME: my-lambda-dark-werner
#+begin_src emacs-lisp :tangle no

(defun my-lambda-dark-werner ()
  "Load the dark variant of a modified lambda theme."
  (progn
    (load-theme 'lambda-dark t)
    (set-face-attribute 'lambda-purple nil :foreground "#686c8e");;lavendar-purple
    (set-face-attribute 'lambda-crucial nil :foreground "#686c8e")
    (set-face-attribute 'minibuffer-prompt nil :foreground "#686c8e")
    (set-face-attribute 'header-line nil :background "#424451") ;;greyish-black
    (set-face-attribute 'lambda-line-active nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive nil :background "#424451")
    (set-face-attribute 'lambda-line-hspace-active nil :background "#424451")
    (set-face-attribute 'lambda-line-hspace-inactive nil :background "#424451")
    (set-face-attribute 'lambda-line-active-name nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-name nil :background "#424451")
    (set-face-attribute 'lambda-line-active-primary nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-primary nil :background "#424451")
    (set-face-attribute 'lambda-line-active-secondary nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-secondary nil :background "#424451")
    (set-face-attribute 'lambda-line-active-tertiary nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-tertiary nil :background "#424451")
    (set-face-attribute 'lambda-line-active-status-RO nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-status-RO nil :background "#424451")
    (set-face-attribute 'lambda-line-active-status-RW nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-status-RW nil :background "#424451")
    (set-face-attribute 'lambda-line-active-status-MD nil :background "#424451")
    (set-face-attribute 'lambda-line-inactive-status-MD nil :background "#424451")))
#+end_src

Finally, a small fun which lets us switch between our settings.
This is an adaptation of the toggle-theme functionality built into lambda-themes.

#+NAME: my-toggle-theme
#+begin_src emacs-lisp :tangle no
(defun my-toggle-theme ()
  "Toggle between dark and light variants."
  (interactive)
  (if (eq lambda-themes-active-theme 'light)     ; Detect whether the light theme is used
      (progn
        (lambda-themes--disable-all-themes)      ; Disable the current theme
        (my-lambda-dark-werner)                  ; Load the dark theme
        (setq lambda-themes-active-theme 'dark)  ; Set the theme-variable to 'dark
        (run-hooks 'lambda-themes-after-load-theme-hook)) ; Execute hooks
    (progn
      (lambda-themes--disable-all-themes)        ; Disable the current theme
      (my-lambda-light-werner)                   ; Load the light theme
      (setq lambda-themes-active-theme 'light)   ; Set the theme-variable to 'light
      (run-hooks 'lambda-themes-after-load-theme-hook) ; Execute hooks
      )))
#+end_src

We load the theme-code with a few configurations here.
Choosing this theme is done when we set up the modeline due to the fact that we modify the theme and modeline simultaneously.

#+begin_src emacs-lisp :noweb yes
(use-package lambda-themes
  :elpaca (:type git :host github :repo "lambda-emacs/lambda-themes")
  :after dash
  :init
  <<werner-colours>>
  :demand t
  :custom
  (lambda-themes-set-italic-comments t)  ; Italic comments.
  (lambda-themes-set-italic-keywords t)  ; Italic keywords
  (lambda-themes-set-variable-pitch nil) ; Fixed pitch looks better to me.
  :bind (:map ergoemacs-override-keymap
              ("<f6>" . my-toggle-theme))
  :config
  ;; theme-specific function
  <<my-lambda-light-werner>>
  <<my-lambda-dark-werner>>
  <<my-toggle-theme>>
  ;; load preferred theme
  (setq initial-scratch-message "")      ; Why would I ever want a scratch message?
  ;; Default frame settings (taken from N.Rougier)
  (setq default-frame-alist '((min-height . 1)  '(height . 45)
                              (min-width  . 1)  '(width  . 81)
                              (vertical-scroll-bars . nil)
                              (internal-border-width . 24)
                              (left-fringe . 0)
                              (right-fringe . 0)))
  (setq initial-frame-alist default-frame-alist)
  ;; Some font specifications
  <<font-stack>>
  <<nerd-font-settings>>
  :custom-face
  (outline-1 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-2 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-3 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-4 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-5 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-6 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-7 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  (outline-8 ((t (:height 1.0 :foreground unspecified :inherit lambda-strong))))
  )
#+end_src
** TODO The font stack

This is the font stack we install:

- Default font:  Roboto Mono 14pt Light    [[https://fonts.google.com/specimen/Roboto+Mono][   ]]
- /Italic font/:   Victor Mono 14pt Semilight [[https://github.com/rubjo/victor-mono][  ]]
- *Bold font*:     Roboto Mono 14pt Regular     [[https://fonts.google.com/specimen/Roboto+Mono][]]
- Icon font:     Roboto Mono Nerd 14pt Light  [[https://www.nerdfonts.com/][]]

Text excerpt using a /gorgeous/ and true italic font (Victor Mono),
chosen to really *stand out* from the default font (Roboto Mono).
┌─────────────────────────────────────────────────────────────────┐
│  The quick brown fox jumps over the lazy dog                   │
│  /The quick brown fox jumps over the lazy dog/                   ┼─ Victor Mono Italic
│  *The quick brown fox jumps over the lazy dog*                   ├─ Inconsolata
└──┼────────────────────────────────────────────┼─────────────────┘
Roboto Mono Nerd                           Roboto Mono

Note that the Victor Mono needs to be hacked such as to have the same line height as Roboto Mono. To do that, you can use the [[https://github.com/source-foundry/font-line][font-line]] utility (github.com/source-foundry/font-line): copy all the italic faces from the Victor Mono ttf file into a directoy and type: =font-line percent 10 *.ttf=. This will create a new set of files that you can use to replace the Victor Mono italic faces on your system.

#+NAME: font-stack
#+begin_src emacs-lisp :tangle no

(set-face-attribute 'default nil
                    :family "Roboto Mono "
                    :weight 'light
                    :height 140)

(set-face-attribute 'bold nil
                    :family "Roboto Mono"
                    :weight 'regular)

(set-face-attribute 'default nil
                    :family "Roboto Mono"
                    :weight 'light
                    :height 140)

(set-face-attribute 'bold nil
                    :family "Roboto Mono"
                    :weight 'regular)

(set-face-attribute 'italic nil
                    :family "Victor Mono"
                    :weight 'semilight
                    :slant 'italic
                    :height (lambda (x)
                              (cond ((< x 100) (+ x 5))
                                    ((and (>= x 100) (< x 110)) 110)
                                    ((and (>= x 110) (< x 120)) 132)
                                    ((and (>= x 120) (< x 130)) 132)
                                    ((and (>= x 130) (< x 140)) 140)
                                    ((and (>= x 140) (< x 150)) 150)
                                    ((and (>= x 150) (< x 160)) 170)
                                    ((and (>= x 160) (< x 170)) 180)
                                    ((and (>= x 170) (< x 180)) 190)
                                    ((and (>= x 180) (< x 190)) 200)
                                    ((>= x 190) (round(* x 1.1)))))
                    )
#+end_src


We additionally define some fonts for common character sets.
To get a list of all character sets type "M-x list-character-sets"

#+NAME: nerd-font-settings
#+begin_src emacs-lisp :tangle no
(--map (set-fontset-font t (-first-item it) (-second-item it))
  '((unicode "Roboto Mono Nerd Font")
    (symbol  "Roboto Mono Nerd Font")
    (emoji   "Roboto Mono Nerd Font")))
#+end_src
** Lambda modeline

The modeline is [[https://github.com/Lambda-Emacs/lambda-line][lambda-line]].
#+begin_quote
Lambda-line is a custom status-line (or “mode-line) for Emacs. It is configurable for use either as a header-line or as a footer-line.

The status-line has the structure:

[ status name (primary) tertiary secondary ]

Information displayed depends on major mode. Not all segments display in every mode.
#+end_quote

We customise it at bit.

*** Prelude: A thin (bottom) modeline
We will have a status line at the top of the frames and therefore disable the modeline at the bottom (except for a thin seperator line).

#+NAME: my-thin-modeline
#+begin_src emacs-lisp :tangle no
(defun my-thin-modeline ()
  "Transform the modeline in a thin faded line"
  (lambda-line-face-clear 'mode-line)
  (lambda-line-face-clear 'mode-line-inactive)
  (setq mode-line-format (list ""))
  (setq-default mode-line-format (list ""))
  (set-face-attribute 'mode-line nil
                      :box nil
                      :inherit nil
                      )
  (set-face-attribute 'mode-line-inactive nil
                      :box nil
                      :inherit nil
                      ))
#+end_src
*** The modeline itself
#+begin_src emacs-lisp :noweb yes
(use-package lambda-line
  :elpaca (:type git :host github :repo "lambda-emacs/lambda-line")
  :after lambda-themes
  :init
  <<my-thin-modeline>>
  :demand t
  :hook (lambda-line-mode-hook . my-thin-modeline)
  :custom
  (lambda-line-position 'top)   ; Set position of status-line
  (lambda-line-abbrev t)        ; abbreviate major modes
  (lambda-line-hspace "   ")    ; add some cushion
  (lambda-line-prefix nil)      ; I do not care about the RW/RO status.
  (lambda-line-vc-symbol "  ") ; A more specious variant of the "git-branch" symbol
  (lambda-line-visual-bell nil) ; No visual bell.
  :custom-face                  ; The status line should NOT! be based on the modeline
  (lambda-line-active ((t (:inherit nil))))
  (lambda-line-inactive ((t (:inherit nil))))
  (lambda-line-hspace-active ((t (:inherit nil))))
  (lambda-line-hspace-inactive ((t (:inherit nil))))
  (lambda-line-active-name ((t (:inherit nil))))
  (lambda-line-inactive-name ((t (:inherit nil))))
  (lambda-line-active-primary ((t (:inherit nil))))
  (lambda-line-inactive-primary ((t (:inherit nil))))
  (lambda-line-active-secondary ((t (:inherit nil))))
  (lambda-line-inactive-secondary ((t (:inherit nil))))
  (lambda-line-active-tertiary ((t (:inherit nil))))
  (lambda-line-inactive-tertiary ((t (:inherit nil))))
  :config
  ;; activate lambda-line and the theme
  (lambda-line-mode)
  (my-thin-modeline)
  (my-lambda-light-werner)
  )
#+end_src
* Completion :BIND:FACE:HOOK:

Emacs has many completion-at-point functionalities.
We use the eco-system:

+ cape
+ corfu
+ consult
+ vertico
+ embark
+ marginalia
+ orderless

On top-for some specific settings, we have
+ LSP-mode
+ YASnippet
** Cape :BIND:HOOK:

[[https://github.com/minad/cape][Cape: completion at point]] is a package by [[https://github.com/minad][Minad]] that enhances the completion ecosystem.
Our configuration is based on a [[https://kristofferbalintona.me/posts/202203130102/][blog post]] by Kristoffer Balintona.

#+begin_quote
Cape provides Completion At Point Extensions which can be used in combination with Corfu, Company or the default completion UI. The completion backends used by completion-at-point are so called completion-at-point-functions (Capfs).

You can register the cape-* functions in the completion-at-point-functions list. This makes the backends available for completion, which is usually invoked by pressing TAB or M-TAB. The functions can also be invoked interactively to trigger the respective completion at point. You can bind them directly to a key in your user configuration. Notable commands/Capfs are cape-line for completion of a line from the current buffer, cape-history for history completion in shell or Comint modes and cape-file for completion of file names. The commands cape-elisp-symbol and cape-elisp-block are useful for documentation of Elisp packages or configurations, since they complete Elisp anywhere.
#+end_quote


#+begin_src emacs-lisp
(use-package cape
  :elpaca (:type git :host github :repo "minad/cape")
  :bind (("C-c p p" . completion-at-point) ; capf
         ("C-c p t" . complete-tag)         ; etags
         ("C-c p d" . cape-dabbrev)         ; or dabbrev-completion
         ("C-c p h" . cape-history)
         ("C-c p f" . cape-file)
         ("C-c p k" . cape-keyword)
         ("C-c p s" . cape-elisp-symbol)
         ("C-c p a" . cape-abbrev)
         ("C-c p l" . cape-line)
         ("C-c p w" . cape-dict)
         ("C-c p \\" . cape-tex)
         ("C-c p _" . cape-tex)
         ("C-c p ^" . cape-tex)
         ("C-c p &" . cape-sgml)
         ("C-c p r" . cape-rfc1345))
  :init
  (setq cape-dict-file "/usr/share/dict/en_GB.txt")
  (defun my-cape-org-mode ()
    "Specify org capes."
    (progn
      (setq-local completion-at-point-functions '(cape-dabbrev cape-tex))
      (add-to-list 'completion-at-point-functions (cape-company-to-capf #'company-org-block))
      (add-to-list 'completion-at-point-functions (cape-company-to-capf #'company-yasnippet))))
  (defun my-cape-latex-mode ()
    "Specify LaTeX capes."
    (progn
      (setq-local completion-at-point-functions '(cape-dabbrev cape-tex))))
  (defun my-cape-lisp-mode ()
    "Specify lisp capes."
    (progn
      (setq-local completion-at-point-functions '(cape-elisp-symbol cape-line))
      (add-to-list 'completion-at-point-functions (cape-company-to-capf #'company-yasnippet))))
  :custom
  (cape-dabbrev-min-length 3)
  :hook ((latex-mode LaTeX-mode) . my-cape-latex-mode)
  (org-mode               . my-cape-org-mode)
  (lisp-mode              . my-cape-lisp-mode)
  )

#+end_src
*** Company and its backends

We will use the power of [[https://company-mode.github.io/][company]] but hide it under a cape.
#+begin_src emacs-lisp
(use-package company-org-block
  :elpaca(company-org-block :type git :host github :repo "xenodium/company-org-block"))
#+end_src

#+begin_src emacs-lisp
(use-package company-yasnippet
  :elpaca(company-yasnippet :type git :host github :repo "company-mode/company-mode"))
#+end_src
** Consult :BIND:
We replace some of emacs functions with their [[https://github.com/minad/consult][consult]] equivalent.

#+begin_quote
Consult provides search and navigation commands based on the Emacs completion function completing-read. Completion allows you to quickly select an item from a list of candidates. Consult offers asynchronous and interactive consult-grep and consult-ripgrep commands, and the line-based search command consult-line. Furthermore Consult provides an advanced buffer switching command consult-buffer to switch between buffers, recently opened files, bookmarks and buffer-like candidates from other sources. Some of the Consult commands are enhanced versions of built-in Emacs commands. For example the command consult-imenu presents a flat list of the Imenu with live preview, grouping and narrowing. Please take a look at the full list of commands.
#+end_quote

The available commands are:

| [[https://github.com/minad/consult?tab=readme-ov-file#search][Search]]              | [[https://github.com/minad/consult?tab=readme-ov-file#navigation][Navigation]]          | [[https://github.com/minad/consult?tab=readme-ov-file#grep-and-find][Grep and Find]]    | [[https://github.com/minad/consult?tab=readme-ov-file#editing][Editing]]                |
|---------------------+---------------------+------------------+------------------------|
| consult line        | consult-goto-line   | consult-grep     | consult-yank-kill-ring |
| consult-line-multi  | consult-mark        | consult-ripgrep  | consult-yank-pop       |
| consult-keep-lines  | consult-global-mark | consult-git-grep | consult-yank-replace   |
| consult-focus-lines | consult-outline     | consult-find     | consult-kmacro         |
|                     | consult-imenu       | consult-fd       |                        |
|                     | consult-imenu-multi | consult-locate   |                        |


| [[https://github.com/minad/consult?tab=readme-ov-file#virtual-buffers][Virtual Buffers]]        | [[https://github.com/minad/consult?tab=readme-ov-file#help][Help]]         | [[https://github.com/minad/consult?tab=readme-ov-file#org-mode][Org Mode]]            | [[https://github.com/minad/consult?tab=readme-ov-file#compilation][Compilation]]           |
|------------------------+--------------+---------------------+-----------------------|
| consult-buffer         | consult-man  | consult-org-heading | consult-compile-error |
| consult-project-buffer | consult-info | consult-org-agenda  | consult-flymake       |
| consult-bookmark       |              |                     | consult-xref          |
| consult-recent-file    |              |                     |                       |

| [[https://github.com/minad/consult?tab=readme-ov-file#modes][Modes]]                   | [[https://github.com/minad/consult?tab=readme-ov-file#histories][Histories]]               | [[https://github.com/minad/consult?tab=readme-ov-file#register][Register]]                |
|-------------------------+-------------------------+-------------------------|
| consult-minor-mode-menu | consult-complex-command | consult-register        |
| consult-mode-command    | consult-history         | consult-register-format |
|                         | consult-isearch-history | consult-register-window |
|                         | consult-minor-mode-menu | consult-register-load   |
|                         |                         | consult-register-store  |

#+begin_src emacs-lisp
(use-package consult
  :elpaca (:type git :host github :repo "minad/consult")
  :init
  (bind-key "M-g" nil 'ergoemacs-override-keymap)
  :bind-keymap
  ("M-g" . goto-map)
  :bind (:map ergoemacs-override-keymap
              ;; Search
              ("C-f"     . consult-line)
              ("M-f"     . consult-line-multi)
              ("C-M-f"   . consult-focus-lines)
              ;; Navigation
              ("C-l"     . consult-goto-line)
              ("M-h"     . consult-outline)
              ;; Grep and find
              ("C-S-f"   . consult-fd)
              ;; Editing
              ("C-S-v"   . consult-yank-from-kill-ring)
              ;; Buffers
              ("C-x b"   . consult-buffer)
              ("C-x r"   . consult-recent-file)
              ;; Help
              ("C-c i" . consult-info)
              ;; Modes
              ;; History
              ("C-c h"   . consult-history)
              ;; Register
              :map goto-map
              ;; Compilation
              ("e" . consult-compile-error)
              ("f" . consult-flymake)
              ;; Navigation
              ("l" . consult-line)
              ("o" . consult-outline)
              ;;Org-specific
              :map org-mode-map
              ("M-h"     . consult-org-heading)
              )
  :config
  (setq consult-preview-key nil)      ; No live preview
  (setq consult-fontify-preserve nil) ; No fontification (e.g. in consult-lines).
  (setq consult-narrow-key "C-+")
  (consult-customize
   consult-theme :preview-key nil ;; Disable preview for `consult-theme' completely.
   consult-buffer :preview-key "M-p"  ;; Set preview for `consult-buffer' to key `M-.'
   consult-line :prompt "Search: "
                 :initial (when (use-region-p)
                            (buffer-substring-no-properties (mark) (point))
                            )
                :preview-key '("<down>" "<up>"))
)

#+end_src
If you use the grepping commands from the Consult package, consult-grep, consult-git-grep or consult-ripgrep, then you should install the embark-consult package, which adds support for exporting a list of grep results to an honest grep-mode buffer, on which you can even use wgrep if you wish.

Consult and embark functionalities can be integrated into each other, as described in the embark [[https://github.com/oantolin/embark/tree/master][manual]].

#+begin_quote
[Embark-consult] provides exporters for several Consult commands and also tweaks the behavior of many Consult commands when used as actions with embark-act in subtle ways that you may not even notice, but make for a smoother experience. You need only install it to get these benefits: Embark will automatically load it after Consult if found.

The embark-consult package provides the following exporters:

+ You can use embark-export from consult-line, consult-outline, or consult-mark to obtain an occur-mode buffer. As with the built-in occur command you use that buffer to jump to a match and after that, you can then use next-error and previous-error to navigate to other matches. You can also press e to activate occur-edit-mode and edit the matches in place!
+ You can export from any of the Consult asynchronous search commands, consult-grep, consult-git-grep, or consult-ripgrep to get a grep-mode buffer. Here too you can use next-error and previous-error to navigate among matches, and, if you install the wgrep package, you can use it to edit the matches in place.

In both cases, pressing g will rerun the Consult command you had exported from and re-enter the input you had typed (which is similar to reverting but a little more flexible). You can then proceed to re-export if that’s what you want, but you can also edit the input changing the search terms or simply cancel if you see you are done with that search.

The embark-consult also contains some candidates collectors that allow you to run embark-live to get a live-updating table of contents for your buffer:

+ embark-consult-outline-candidates produces the outline headings of the current buffer, using consult-outline.
+ embark-consult-imenu-candidates produces the imenu items of the current buffer, using consult-imenu.
+ embark-consult-imenu-or-outline-candidates is a simple combination of the two previous functions: it produces imenu items in buffers deriving from prog-mode and otherwise outline headings.
#+end_quote

#+begin_src emacs-lisp
(use-package embark-consult
  :elpaca(:type git :host github :repo "oantolin/embark")
  :ensure t ; only need to install it, embark loads it after consult if found
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src
** Corfu :BIND:HOOK:

[[https://github.com/minad/corfu][Corfu]] enhances completion at point with a small completion popup.
The following code is inspired by a [[https://kristofferbalintona.me/posts/202202270056/][blog post]] of Kristoffer Balintona.

#+begin_quote
orfu enhances in-buffer completion with a small completion popup. The current candidates are shown in a popup below or above the point. The candidates can be selected by moving up and down. Corfu is the minimalistic in-buffer completion counterpart of the Vertico minibuffer UI.

Corfu is a small package, which relies on the Emacs completion facilities and concentrates on providing a polished completion UI. In-buffer completion UIs in Emacs can hook into completion-in-region, which implements the interaction with the user. Completions at point are either provided by commands like dabbrev-completion or by pluggable backends (completion-at-point-functions, Capfs) and are then passed to completion-in-region. Many programming, text and shell major modes implement a Capf. Corfu does not include its own completion backends. The Emacs built-in Capfs and the Capfs provided by third-party programming language packages are often sufficient. Additional Capfs and completion utilities are provided by the Cape package.
#+end_quote


#+begin_src emacs-lisp
(use-package corfu
  :elpaca (corfu :type git
                 :host github
                 :repo "minad/corfu"
                 :files (:defaults "extensions/*")
                 :includes (corfu-info corfu-history corfu-popupinfo))
  :bind (:map corfu-map
              ("<escape>" . corfu-quit)
              ("<return>" . corfu-insert)
              ("M-d" . corfu-show-documentation)
              ("M-l" . corfu-show-location))
  :custom
  ;; Works with `indent-for-tab-command'. Make sure tab doesn't indent when you
  ;; want to perform completion
  (tab-always-indent 'complete)       ; Allows for indetation AND completion on <tab>.
  (completion-cycle-threshold nil)    ; Always show candidates in menu
  (corfu-auto t)                      ; Enable autocompletion
  (corfu-auto-prefix 2)               ; Minimum length of prefix before completion.
  (corfu-auto-delay 20)               ; Delay before auto-completion shows up
  (corfu-min-width 60)                ; Minimal width of corfu popup.
  (corfu-max-width corfu-min-width)   ; Always have the same width
  (corfu-count 10)                    ; Maximal number of candidates.
  (corfu-scroll-margin 5)             ; Use scroll margins
  (read-extended-command-predicate
   #'command-completion-default-include-p) ; Hide corfu commands from  being used via M-x

  (corfu-cycle t)
  (completion-cycle-threshold 3)      ; If there are only 3 candidates, no poup is shown.
  (corfu-quit-at-boundary 'seperator) ; Quits at boundary unless a seperator is used.
  (corfu-separator ?\s)               ; Use space
  (corfu-quit-no-match 'separator)    ; Don't quit if there is `corfu-separator' inserted
  (corfu-preview-current 'insert)     ; Preview first candidate. Insert on input if only one
  (corfu-preselect-first t)           ; Preselect first candidate
  (corfu-popupinfo-delay 0.1)           ; Show some documentation about the candidates.
  (add-to-list 'savehist-additional-variables 'corfu-history)
  ;; Other
  (corfu-echo-documentation nil)      ; Already use corfu-doc
  (lsp-completion-provider :none)     ; Use corfu instead for lsp completions
  :init
  (global-corfu-mode)
  (corfu-popupinfo-mode)
  (corfu-history-mode)
  :hook (lsp-completion-mode . my-corfu-setup-lsp)
  :init
  ;; Setup lsp to use corfu for lsp completion
  (defun my-corfu-setup-lsp ()
    "Use orderless completion style with lsp-capf instead of the
default lsp-passthrough."
    (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
          '(orderless)))
  )
#+end_src
** TODO Embark :BIND:
The following code is taken from the literate config of [[https://protesilaos.com/emacs/dotemacs][Protesilaos Stavrou]].
It could use a lot(!) of work to optimise [[https://github.com/oantolin/embark/tree/master][embark]].

A short description taken from the manual is:

#+begin_quote
Embark makes it easy to choose a command to run based on what is near point, both during a minibuffer completion session (in a way familiar to Helm or Counsel users) and in normal buffers. Bind the command embark-act to a key and it acts like prefix-key for a keymap of actions (commands) relevant to the target around point. With point on an URL in a buffer you can open the URL in a browser or eww or download the file it points to. If while switching buffers you spot an old one, you can kill it right there and continue to select another. Embark comes preconfigured with over a hundred actions for common types of targets such as files, buffers, identifiers, s-expressions, sentences; and it is easy to add more actions and more target types. Embark can also collect all the candidates in a minibuffer to an occur-like buffer or export them to a buffer in a major-mode specific to the type of candidates, such as dired for a set of files, ibuffer for a set of buffers, or customize for a set of variables.
#+end_quote

#+begin_src emacs-lisp
(use-package embark
  :elpaca(:type git :host github :repo "oantolin/embark")
  :bind (("C-." . embark-act)
         :map minibuffer-local-completion-map
         ("C-." . embark-act)
         ("C->" . embark-become)
         :map embark-region-map
         ("a" . align-regexp)
         ("C" . capitalize-dwim)
         ("SPC" . whitespace-cleanup-region)
         ("RET" . fill-region)
         :map embark-symbol-map
         ("." . embark-find-definition)
         ("k" . describe-keymap)
         )
  :config
  (setq prefix-help-command #'embark-prefix-help-command)
  (setq embark-quit-after-action t)     ; XXX: Read the doc string!
  (setq embark-confirm-act-all nil)
  (setq embark-indicators
        '(embark-mixed-indicator
          embark-highlight-indicator))
  (setq embark-verbose-indicator-excluded-actions
        '("\\`customize-" "\\(local\\|global\\)-set-key"
          set-variable embark-cycle embark-keymap-help embark-isearch))
  (setq embark-verbose-indicator-buffer-sections '(bindings))
  (setq embark-verbose-indicator-excluded-actions
        '(embark-cycle embark-act-all embark-collect embark-export embark-insert))
  (setq embark-cycle-key "<XF86Travel>")
  (setq embark-mixed-indicator-both nil)
  (setq embark-mixed-indicator-delay 1.5)

  ;;  NOTE 2021-07-28: This is used when `embark-indicator' is set to
  ;;  `embark-mixed-indicator' or `embark-verbose-indicator'.  We can
  ;;  specify the window parameters here, but I prefer to do that in my
  ;;  `display-buffer-alist' (search this document) because it is easier
  ;;  to keep track of all my rules in one place.
  (setq embark-verbose-indicator-display-action nil)
  )
#+end_src
** Marginalia :BIND:

[[https://github.com/minad/marginalia][Marginalia]] offers annotations for the minibuffer.
Our configuration is based on a [[https://kristofferbalintona.me/posts/202202211546/#marginalia][blog post]] by Kristoffer Balintona.

#+begin_quote
This package provides marginalia-mode which adds marginalia to the minibuffer completions. Marginalia are marks or annotations placed at the margin of the page of a book or in this case helpful colorful annotations placed at the margin of the minibuffer for your completion candidates. Marginalia can only add annotations to the completion candidates. It cannot modify the appearance of the candidates themselves, which are shown unaltered as supplied by the original command.

The annotations are added based on the completion category. For example find-file reports the file category and M-x reports the command category. You can cycle between more or less detailed annotators or even disable the annotator with command marginalia-cycle.
#+end_quote

#+begin_src emacs-lisp
(use-package marginalia
  :elpaca(:type git :host github :repo "minad/marginalia")
  :init (marginalia-mode)
  :bind (:map minibuffer-local-map
              ("M-A" . marginalia-cycle))
  :custom
  (marginalia--ellipsis "…")      ; Nicer ellipsis
  (marginalia-align 'right)       ; right alignment
  (marginalia-align-offset -1)    ; one space on the right
  (marginalia-max-relative-age 0) ; Supresses showing the file age
  )
#+end_src
** Orderless :FACE:

[[https://github.com/oantolin/orderless][Orderless]] allows for completions based on space-separated tokens, in any order.
Config inspired by a [[https://kristofferbalintona.me/posts/202202211546/#orderless][blog post]] of Kristoffer Balintona.

#+begin_quote
This package provides an orderless completion style that divides the pattern into space-separated components, and matches candidates that match all of the components in any order. Each component can match in any one of several ways: literally, as a regexp, as an initialism, in the flex style, or as multiple word prefixes. By default, regexp and literal matches are enabled.

A completion style is a back-end for completion and is used from a front-end that provides a completion UI. Any completion style can be used with the default Emacs completion UI (sometimes called minibuffer tab completion), with the built-in Icomplete package (which is similar to the more well-known Ido Mode), the icomplete-vertical variant from Emacs 28 (see the external icomplete-vertical package to get that functionality on earlier versions of Emacs), or with some third party minibuffer completion frameworks such as Mct or Vertico.
#+end_quote

#+begin_src emacs-lisp
(use-package orderless
  :elpaca (:type git :host github :repo "oantolin/orderless")
  :custom-face
  (isearch ((t (:foreground "#71aa89" :background unspecified)))) ; verdiris-green
  (match ((t (:foreground "#71aa89" :background unspecified)))) ; verdiris-green
  (completions-common-part ((t (:foreground "#71aa89" :background unspecified)))) ; verdiris-green
  (orderless-match-face-0 ((t (:foreground "#71aa89" :background unspecified)))) ; verdiris-green
  (orderless-match-face-1 ((t (:foreground "#97b578" :background unspecified)))) ; emerald-green
  (orderless-match-face-2 ((t (:foreground "#98a760" :background unspecified)))) ; pistachio-green
  (orderless-match-face-3 ((t (:foreground "#86996d" :background unspecified)))) ; grass-green
  :custom
  (completion-styles '(orderless))
  (completion-category-defaults nil) ; I want to be in control!
  (orderless-component-separator 'orderless-escapable-split-on-space)
  (orderless-matching-styles
   '(orderless-prefixes
     orderless-literal
     orderless-regexp
     orderless-initialism
     ))
  (orderless-style-dispatchers
   '(orderless-affix-dispatch))
  (orderless-affix-dispatch-alist
   '((33  . orderless-without-literal) ; "!" at start/end excludes this word from the search
     (37  . char-fold-to-regexp)       ; "%" at start/end ignores inflections of the word
     (44  . orderless-initialism)      ; "," at start/end activates initalism
     (61  . orderless-literal)         ; "=" at start/end makes the word match literally
     (126 . orderless-flex)))          ; "~" at start/end activate flexible matching.
  (read-file-name-completion-ignore-case t)
  (read-buffer-completion-ignore-case t)
  (completion-ignore-case t)
  (completion-category-overrides '((file (styles . (partial-completion)))))
  )
#+end_src
** Eglot :INACTIVE:

#+begin_src emacs-lisp
(use-package eglot-ltex
  :elpaca (:type git :host github :repo "emacs-languagetool/eglot-ltex")
  :defer t
  :hook (text-mode . (lambda ()
                       (require 'eglot-ltex)
                       (eglot-ensure)))
  :init
  (setq eglot-ltex-server-path "/usr/share/ltex-ls/"
        eglot-ltex-communication-channel 'tcp))
#+end_src
** LSP-Mode :BIND:HOOK:INACTIVE:

A few more niceties for our completion setup are provided by using the [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]].
It has a nice and quite useful [[https://emacs-lsp.github.io/lsp-mode/][wiki]].The following config is derived from Tony Zorman's settings.

#+begin_src emacs-lisp
(use-package lsp-mode
  :elpaca(:type git :host github :repo "emacs-lsp/lsp-mode")
  :preface
  (defun my-lsp-shutdown-last-workspaces ()
    "Shut down the `lsp--last-active-workspaces'."
    (interactive)
    (mapc (lambda (ws)
            (lsp--warn "Stopping %s" (lsp--workspace-print ws))
            (with-lsp-workspace ws (lsp--shutdown-workspace)))
          lsp--last-active-workspaces))
  :hook
  ((latex-mode LaTeX-mode) . lsp-deferred)
  (lsp-mode . (lambda ()
                (setq-local read-process-output-max (* 1024 1024))))
  (lsp-completion-mode ; for corfu compatibility
   . (lambda ()
       (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
             '(flex))))
  :commands (lsp-deferred lsp)
  :bind (:map lsp-mode-map
              ("C-c l i" . lsp-ui-imenu)
              ("C-c C-r" . lsp-execute-code-action)
              ("C-c C-d" . lsp-ui-doc-show)
              ("C-c l s" . (lambda ()
                             (interactive)
                             (lsp-ui-sideline-enable (not lsp-ui-sideline-mode))))
              ("C-c h"   . (lambda ()
                             (interactive)
                             (when lsp-lens-mode
                               (lsp-lens-mode -1))
                             (lsp-lens-hide)))
              ("C-c d"   . (lambda ()
                             (interactive)
                             (when (not lsp-lens-mode)
                               (lsp-lens-mode 1))
                             (lsp-lens-show))))
  :custom
  (lsp-use-plists t)
  (lsp-completion-provider :none)       ; Corfu
  (lsp-keymap-prefix "C-c l")
  (lsp-idle-delay 0.6)
  ;; Disable things I don't care about
  (lsp-headerline-breadcrumb-enable nil)
  (lsp-modeline-code-actions-enable nil)
  (lsp-modeline-diagnostics-enable nil)
  (lsp-enable-symbol-highlighting nil)
  )
#+end_src

#+begin_src emacs-lisp
(use-package lsp-ui
  :after lsp-mode
  :commands lsp-ui-mode
  :custom
  (lsp-ui-doc-show-with-mouse nil)
  (lsp-ui-sideline-enable nil)
  (lsp-ui-peek-always-show t)
  (lsp-ui-sideline-show-hover t)
  )
#+end_src
** Vertico :BIND:HOOK:FACE:

[[https://github.com/minad/vertico][Vertico]] is the minibuffer UI for our completion system.

#+begin_quote
Vertico provides a performant and minimalistic vertical completion UI based on the default completion system. The focus of Vertico is to provide a UI which behaves correctly under all circumstances. By reusing the built-in facilities system, Vertico achieves full compatibility with built-in Emacs completion commands and completion tables. Vertico only provides the completion UI but aims to be highly flexible, extendable and modular. Additional enhancements are available as extensions or complementary packages. The code base is small and maintainable. The main vertico.el package is only about 600 lines of code without white space and comments.
#+end_quote

For informations on completion-at-point and completion-in-region see:
https://github.com/minad/vertico#completion-at-point-and-completion-in-region
The pointer for the currrent line is derived from: [[https://github.com/minad/vertico/wiki#prefix-current-candidate-with-arrow]]


#+begin_src emacs-lisp
(use-package vertico
  :elpaca (vertico :files (:defaults "extensions/*") ; Special recipe to load extensions
                   :includes (vertico-indexed
                              vertico-flat
                              vertico-grid
                              vertico-mouse
                              vertico-quick
                              vertico-buffer
                              vertico-repeat
                              vertico-reverse
                              vertico-directory
                              vertico-multiform
                              vertico-unobtrusive
                              ))
  :bind (("M-." . vertico-repeat)
         :map vertico-map
         ("<tab>"      . vertico-insert)
         ("<escape>"   . minibuffer-keyboard-quit)
         ("?"          . minibuffer-completion-help)
         ("<backtab>"  . minibuffer-complete)
         ("<down>"     . vertico-next)
         ("<up>"       . vertico-previous)
         ("C-M-n"      . vertico-next-group)
         ("C-M-p"      . vertico-previous-group)
         ("C-<backspace>" . vertico-directory-delete-word)
         )
  :hook ((rfn-eshadow-update-overlay . vertico-directory-tidy) ; Clean up file path when typing
         (minibuffer-setup . vertico-repeat-save) ; Make sure vertico state is saved
         )
  :custom
  (vertico-count 10)             ; At most 10 entries are shown
  (vertico-count-format nil)     ; But we do not count them
  (vertico-resize nil)           ; The size of the minbuffer is fixed
  (vertico-cycle t)
  ;; Extensions
  (vertico-grid-separator "       ")
  (vertico-grid-lookahead 55)
  (vertico-buffer-display-action '(display-buffer-reuse-window))
  (vertico-multiform-categories
   '((file grid)
     (consult-grep buffer)
     )
   )
  (completion-in-region-function
   (lambda (&rest args)
     (apply (if vertico-mode
                #'consult-completion-in-region
              #'completion--in-region)
            args)))
  :config
  (vertico-mode)
  ;; Extensions
  (vertico-multiform-mode)
  ;; Prefix the current candidate with “ ”. From
  ;; https://github.com/minad/vertico/wiki#prefix-current-candidate-with-arrow
  (advice-add #'vertico--format-candidate :around
              (lambda (orig cand prefix suffix index _start)
                (setq cand (funcall orig cand prefix suffix index _start))
                (concat
                 (when (= vertico--index index)
                   (propertize " " 'face 'vertico-current))
                 cand)))
  :custom-face
  (vertico-group-separator ((t (:strike-through t))))
  (vertico-current ((t (:inherit 'nano-strong 'nano-subtle))))
  (completions-first-difference ((t (:inherit 'nano-default))))
  )
#+end_src



*** Vertico truncate

#+begin_src emacs-lisp
(use-package vertico-truncate
  :elpaca (:type git :host github :repo "jdtsmith/vertico-truncate")
  :config
  (vertico-truncate-mode 1)
  )
#+end_src
** YASnippet

We use [[https://github.com/joaotavora/yasnippet][yasnippet]] mostely for Latex.
#+begin_quote
YASnippet is a template system for Emacs. It allows you to type an abbreviation and automatically expand it into function templates. Bundled language templates include: C, C++, C#, Perl, Python, Ruby, SQL, LaTeX, HTML, CSS and more. The snippet syntax is inspired from TextMate's syntax, you can even import most TextMate templates to YASnippet.
#+end_quote

#+begin_src emacs-lisp

(use-package yasnippet
  :elpaca (:type git :host github :repo "oaotavora/yasnippet")
  :config (yas-global-mode)
  :custom
  (yas-inhibit-overlay-modification-protection nil))

#+end_src
* Org mode

[[https://orgmode.org/][Org mode]] is arguably one of the best features of emacs.

#+begin_quote
A GNU Emacs major mode for keeping notes, authoring documents, computational notebooks, literate programming, maintaining to-do lists, planning projects, and more — in a fast and effective plain text system.
#+end_quote

A extensive documentation can be found [[https://orgmode.org/org.html][here]].
** General settings

#+NAME: org-config
#+begin_src emacs-lisp :noweb yes :tangle no
(use-package org
  :elpaca ( :package "org"
            :local-repo "org"
            :repo "https://git.savannah.gnu.org/git/emacs/org-mode.git"
            :pre-build (progn (require 'elpaca-menu-org) (elpaca-menu-org--build))
            :autoloads "org-loaddefs.el"
            :build (:not elpaca--generate-autoloads-async)
            :files (:defaults ("etc/styles/"
                               "etc/styles/*" "doc/*.texi")))
  :config
  (setq-default org-directory "~/Documents/org-files"
                org-tags-column 0                    ; Tags next to header title
                org-hide-emphasis-markers t          ; Hide markers
                org-cycle-separator-lines 1          ; Number of empty lines between sections
                org-use-tag-inheritance t            ; Tags ARE inherited
                org-use-property-inheritance t       ; Properties ARE inherited
                org-indent-indentation-per-level 2   ; Indentation per level
                org-src-fontify-natively t           ; Fontify code in code blocks.
                org-adapt-indentation nil            ; No adaptive indentation
                org-src-tab-acts-natively t          ; Tab acts as in source editing
                org-confirm-babel-evaluate nil       ; No confirmation before executing code
                org-edit-src-content-indentation 0   ; No relative indentation for code blocks
                org-fontify-whole-block-delimiter-line t     ; Fontify whole block
                org-link-use-indirect-buffer-for-internals t ; Indirect buffer for internal
                                        ; links
                org-fontify-quote-and-verse-blocks t ; Specific face for quote and verse blocks
                org-return-follows-link nil          ; Follow links when hitting return
                org-image-actual-width nil           ; Resize image to window width
                org-indirect-buffer-display 'other-window    ; Tab on a task expand it in a
                                        ; new window
                org-outline-path-complete-in-steps nil       ; No steps in path display
                org-refile-targets                   ; where to refile to
                '(
                  ("~/Documents/org-files/agenda/archive.org"  :maxlevel . 2)
                  ("~/Documents/org-files/agenda/maths.org"    :maxlevel . 3)
                  ("~/Documents/org-files/agenda/leisure.org"  :maxlevel . 2)
                  ("~/Documents/org-files/agenda/calendar.org" :maxlevel . 2)
                  )
                org-fold-catch-invisible-edits 'smart        ; Check if in invisible region
                org-insert-heading-respect-content nil       ; Insert new heading at point.
                org-pretty-entities t                        ; Show entities as UTF-8
                                        ; characters
                org-ellipsis " …"                            ; Short ellipsis
                org-emphasis-alist                           ; Faces used for the emphasise
                '(("*" (:weight bold :inherit lambda-focus)) ; characters.
                  ("/" italic)                               ; Note that no other characters
                  ("_" underline)                            ; can be added.
                  ("=" (:weight bold :inherit lambda-urgent))
                  ("~" (lambda-meek))
                  ("+" (:box t :inverse-video t))))
                <<org-html-export-settings>>                ; Export settings
  <<org-faces>>
  :hook
  <<org-hooks>>
  :custom-face
  (org-document-title ((t (:height 1.0 :weight  unspecified :foreground unspecified :inherit lambda-strong))))
  )
#+end_src


We want code-blocks and quotations to stand out.

#+NAME: org-faces
#+begin_src emacs-lisp :tangle no
(defun my-org-blocks-light ()
  "Colourise org-blocks in a light theme."
  (progn
    (set-face-attribute 'org-block nil :background "#f9f7f0");;large wild conv.(slight darker)
    (set-face-attribute 'org-quote nil :background "#f9f7f0");;large wild conv.(slight darker)
    ))

(defun my-org-blocks-dark ()
  "Colourise org-blocks in a dark theme."
  (progn
    (set-face-attribute 'org-block nil :background "#424451") ;;greyish-black
    (set-face-attribute 'org-quote nil :background "#424451") ;;greyish-black
    ))

(defun my-org-colourise ()
  "Coulourise org-blocks depending on dark or light theme"
  (progn
    (if (eq lambda-themes-active-theme 'light) (my-org-blocks-light) (my-org-blocks-dark))))

(add-hook 'lambda-themes-after-load-theme-hook #'my-org-colourise)
#+end_src

Finally, we have some hooks to add.

#+NAME: org-hooks
#+begin_src emacs-lisp :tangle no
(org-mode . org-indent-mode)                              ; use indentations
(org-mode . my-org-colourise)                             ; colourise blocks
(lambda-themes-after-load-theme-hook .my-org-colourise)   ; change colours if the theme changes
#+end_src


*** A short elisp helper

A shortcut for emacs-lisp source blocks. Type "<S" (in org-mode) then press tab.

#+begin_src emacs-lisp
(use-package org-tempo
  :elpaca nil
  :custom
  (add-to-list 'org-structure-template-alist
             '("S" . "src emacs-lisp")))
#+end_src
** Modern Org mode
#+begin_src emacs-lisp

(use-package org-modern
  :elpaca (:type git :host github :repo "minad/org-modern")
  :config
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d)" "CANCELED(c)")
          (sequence "WAIT(p)" "|")))
  (global-org-modern-mode)
  :custom
  org-modern-todo-faces
  '(("TODO"     . todo-face)
    ("NEXT"     . next-face)
    ("DONE"     . done-face)
    ("WAIT"   . wait-face)
    ("CANCELED" . canceled-face)))
#+end_src
*** Org appear mode

We use [[https://github.com/awth13/org-appear][org-appear]] in order to dynamically display certain symbols, such as emphasis-markers, depending on the position of the coursor.
#+begin_quote
Org mode provides a way to toggle visibility of hidden elements such as emphasis markers, links, etc. by customising specific variables, e.g., org-hide-emphasis-markers. However, it is currently not possible to do this interactively and on an element-by-element basis. This package, inspired by org-fragtog, enables automatic visibility toggling depending on cursor position. Hidden element parts appear when the cursor enters an element and disappear when it leaves.
#+end_quote

#+begin_src emacs-lisp
(use-package org-appear
  :elpaca (org-appear :type git :host github :repo "awth13/org-appear")
  :hook (org-modern-mode . org-appear-mode)
  :custom
  (org-appear-autoemphasis t)  ;
  (org-appear-autolinks t)     ;
  (org-appear-autosubmarkers t);
  (org-appear-autoentities t)  ;
  (org-appear-autokeywords t)  ;
  (org-appear-inside-latex t)  ;
  )
#+end_src
** TODO HTML-Export

We treat ~code~ and =verbatim= faces differently among export.

Hereto we require the newest version of htmlize.
#+NAME: org-html-export-settings
#+begin_src emacs-lisp :noweb yes :tangle no
(setq org-export-with-broken-links t) ; Export even with broken links
<<org-html-markup-alist>>
<<my-org-theme-css-dir>>
<<my-org-current-html-theme>>
<<my-set-org-html-style>>
(add-hook 'org-export-before-parsing-hook 'my-set-org-html-style)
#+end_src

Our exporter needs a new version of htmlize.

#+begin_src emacs-lisp
(use-package htmlize
  :elpaca (:type git :host github :repo "hniksic/emacs-htmlize")
  )
#+end_src

Alist of HTML expressions to convert text markup.

The key must be a symbol among bold, code, italic,
strike-through, underline and verbatim.  The value is
a formatting string to wrap fontified text with.

#+NAME: org-html-markup-alist
#+begin_src emacs-lisp :tangle no
(setq org-html-text-markup-alist '(
                                   (bold           . "<b>%s</b>")
                                   (code           . "<span class=\"meek\">%s</span>")
                                   (italic         . "<i>%s</i>")
                                   (strike-through . "<span class=\"boxed-text\">%s</del>")
                                   (underline      . "<span class=\"underline\">%s</span>")
                                   (verbatim       . "<span class=\"urgent\">%s</span>")))

#+end_src

In order to have a nice page after exporting, we want to include some css code.

#+NAME: my-org-theme-css-dir
#+begin_src emacs-lisp :tangle no
(defvar my-org-theme-css-dir "~/.emacs.org/org-css/") ; location of the css files
#+end_src

Retrieve the theme.

#+NAME: my-org-current-html-theme
#+begin_src emacs-lisp :tangle no
(defun my-org-current-html-theme ()
  "Retrieve the css-file for org export."
  (interactive)
  (let* ((cssdir my-org-theme-css-dir)
         (css-choices (directory-files cssdir nil ".css$"))
         (css (completing-read "theme: " css-choices nil t)))
    (concat cssdir css)))
#+end_src

Set the style for the file.

#+NAME: my-set-org-html-style
#+begin_src emacs-lisp :tangle no
(defun my-set-org-html-style (&optional backend)
  "Include the css-file in the exportet html file."
  (interactive)
  (when (or (null backend) (eq backend 'html))
    (let ((f (or (and (boundp 'org-theme-css) org-theme-css) (my-org-current-html-theme))))
      (if (file-exists-p f)
          (progn
            (set (make-local-variable 'org-theme-css) f)
            (set (make-local-variable 'org-html-head)
                 (with-temp-buffer
                   (insert "<style type=\"text/css\">\n<!--/*--><![CDATA[/*><!--*/\n")
                   (insert-file-contents f)
                   (goto-char (point-max))
                   (insert "\n/*]]>*/-->\n</style>\n")
                   (buffer-string)))
            (set (make-local-variable 'org-html-head-include-default-style)
                 nil)
            (message "Set custom style from %s" f))
        (message "Custom header file %s doesnt exist")))))


#+end_src
** GTD
In this subsection, we set up our variant of the "getting things done"-ecosystem.
This involves:
- the org agenda
- the task-capturing ecosystem
- the org-gtd package

*** org-agenda

Quoted from the manual of [[https://orgmode.org/manual/Agenda-Views.html][org agenda]].
#+begin_quote
To get an overview of open action items, or of events that are important for a particular date, this information must be collected, sorted and displayed in an organized way.
#+end_quote
#+begin_src emacs-lisp :noweb yes
(use-package org-agenda
  :elpaca nil
  :hook (org-agenda-finalize . my-org-agenda-mode-hook)
  :bind (:map ergoemacs-override-keymap ("C-c a" . org-agenda))
  (:map org-agenda-mode-map ("q" . org-agenda-exit))
  :config
  <<general-settings>>
  <<agenda-formatting>>
  <<org-tags>>
  )
#+end_src


#+NAME: general-settings
#+begin_src emacs-lisp :tangle no
(setq org-agenda-files '("~/Documents/org-files/agenda")
      org-inbox (concat (file-name-as-directory (car org-agenda-files)) "inbox.org")
      org-archive-location (concat
                            (file-name-as-directory (car org-agenda-files))
                            "archive.org::datetree/")
      org-calendar (concat (file-name-as-directory (car org-agenda-files)) "calendar.org")
      org-agenda-include-diary nil        ; We do not use the diary
      org-agenda-skip-scheduled-if-done t ; Don't show scheduled meetings that are done
      org-agenda-skip-deadline-if-done t  ; Don't show deadlines when the item is done
      org-agenda-include-deadlines t      ; Include deadlines
      org-agenda-compact-blocks t         ; more compact blocks
      org-agenda-start-day nil            ; start today today
      org-agenda-span 3                   ; number of days to include in overview
      org-agenda-start-on-weekday nil     ; start on current day
      org-agenda-window-setup 'current-window ; Show agenda in the current window
      org-agenda-restore-windows-after-quit t ; Restore window configuration
      org-agenda-show-all-dates t         ; All dates in the specified timespan are shown
      org-agenda-show-current-time-in-grid t  ; Show the current time in the agenda view
      org-agenda-block-separator nil      ; No speparators
      org-agenda-category-icon-alist nil  ; No category icons in agenda views
      org-agenda-start-with-log-mode t    ; Activate log mode
      org-log-done 'time                  ; Log the time a task is marked as done
      org-log-into-drawer t               ; Insert time stamps into a drawer.
      org-read-date-prefer-future 'time   ; We schedule tasks in the future.
      org-agenda-remove-tags t)           ;TODO: We remove tags in the agenda (for now)

#+end_src

#+NAME: agenda-formatting
#+begin_src emacs-lisp :tangle no
(setq org-agenda-sorting-strategy
      '((agenda deadline-down scheduled-down todo-state-up time-up
                habit-down priority-down category-keep)
        (todo   priority-down category-keep)
        (tags   timestamp-up priority-down category-keep)
        (search category-keep)))

(setq org-agenda-deadline-faces
      '((1.0 . org-warning)              ; due yesterday or before
        (0.0 . org-upcoming-deadline)))  ; due today or later

(setq org-agenda-current-time-string "󰁔 now"
      org-agenda-time-grid
      '((daily today require-timed)
        ()
        "──" "──")
      org-agenda-prefix-format
      '((agenda . "%i %?-12t%s")
        (todo .   "%i")
        (tags .   "%i")
        (search . "%i")))

(setq org-agenda-format-date (lambda (date) (org-agenda-format-date-aligned date)))
(setq org-cycle-separator-lines 2) ;Number of empty lines needed to keep an empty line between collapsed trees.

(setq org-agenda-current-time-string "─now─")
(setq org-agenda-tags-column 'auto)

(defun my-org-agenda-mode-hook ()
  (hl-line-mode t)
  ;;(face-remap-add-relative 'hl-line :inherit 'nano-subtle)
  (set-window-fringes nil 0 1) ; One pixel right fringe to avoid ellipsis
  (setq cursor-type nil))
#+end_src

#+NAME: org-tags
#+begin_src emacs-lisp :tangle no
;;  Auto-update tags whenever the state is changed
(setq org-tag-alist
      '((:startgroup)
        ("mandatory"   . ?a)
        ("dispensable" . ?d)   ; Put mutually exclusive tags here
        (:endgroup)
        ("bureaucracy" . ?b)
        ("leisure"     . ?l)
        ("music"       . ?m)
        ("orga"        . ?o)
        ("progn"       . ?p)
        ("research"    . ?r)
        ("sports"      . ?s)
        ("teaching"    . ?t)
        (""            . ?x)
        ))

#+end_src

**** TODO Org habit
*** org-gtd
We organise our tasks using[[https://github.com/Trevoke/org-gtd.el][ org-gtd]], a org-based implementation of the GTD workflow.
It is summarised in the following pictogram, taken from the org-gtd manual:

#+begin_example
                                    ╭───────╮
                                    │"STUFF"│
                                    ╰───┬───╯
                                        │
                                    ╭───v───╮
                                    │ INBOX │
                                    ╰───┬───╯
                                        │              Eliminate  ╭───────────╮
                                        │            ╭───────────>│  Trash    │
                                 ╭──────v──────╮     │            ╰───────────╯
                                 │ What is it? │     │
                                 ╰──────+──────╯     │            ╭───────────╮
                                        │            │ Incubate   │  Someday/ │
                                        │            ├───────────>│   Maybe   │
╭──────────╮  YES (multi─step)   ╭──────v──────╮  NO │            ╰───────────╯
│ Projects │<────────────────────┤    Is it    ├─────┤
╰─┬────^───╯                     │ Actionable? │     │ File       ╭───────────╮
  │    │                         ╰──────┬──────╯     ╰───────────>│ Reference │
  │    ├────────────────────╮           │                         ╰───────────╯
  │    │        Review for  │           │
╭─v────+───╮      Actions   ╰──────────>│ YES
│ Planning │                            │
╰──────────╯                     ╭──────v──────╮     Less than
                       Delegate  │ What's the  │     2 minutes    ╭───────────╮
                     ╭───────────┤    NEXT     ├─────────────────>│   DO IT   │
                     │           │   Action?   │                  ╰───────────╯
                     │           ╰──────┬──────╯
                     │                  │
                     │                  │ FOR ME:
                     │                  │         Specific Date or Time
                     │                  ├───────────────────────────────╮
                     │              ASAP│                               │
               ╭─────v─────╮      ╭─────v─────╮                   ╭─────v─────╮
               │           │      │           │                   │           │
               │           │      │           │                   │           │
               │           │      │           │                   │           │
               │           │      │           │                   │           │
               │           │      │           │                   │           │
               ╰───────────╯      ╰───────────╯                   ╰───────────╯
                Waiting For        Next Actions                      Calendar
#+end_example


#+begin_src emacs-lisp :noweb yes
(use-package org-gtd
  :elpaca (:type git :host github :repo "Trevoke/org-gtd.el")
  :demand t
  :init
  (setq org-gtd-update-ack "3.0.0")
  :custom
  (org-edna-use-inheritance t)
  (org-gtd-organize-hooks '(org-gtd-set-area-of-focus org-set-tags-command))
  :config
  (setq org-gtd-directory (car org-agenda-files))
  (setq org-gtd-canceled "CANCELED")
  (setq org-gtd-inbox (concat (file-name-as-directory org-gtd-directory) "inbox"))
  (setq org-gtd-archive-location '(lambda() (concat
                                             (file-name-as-directory org-gtd-directory)
                                             "archive.org::datetree/")))
  <<org-gtd-capture-templates>>
  (org-edna-mode)
  (org-gtd-mode 1)
  :bind
  (("C-c c"   . org-capture)
   ("C-c d e" . org-gtd-engage)
   ("C-c d p" . org-gtd-process-inbox)
   :map org-gtd-clarify-map
   ("C-c C-w" . org-gtd-organize))
  :custom-face
  (org-agenda-done ((t :strike-through nil)))
  (org-done  ((t :strike-through nil)))
  )
#+end_src

#+NAME: org-gtd-capture-templates
#+begin_src emacs-lisp :tangle no
(setq org-capture-templates
      `(("i" "Inbox" entry  (file+headline ,org-inbox "Miscellaneous")
         ,(concat "* %?\n"
                  "/Entered on/ %U"))
        ("m" "Meeting" entry  (file+datetree ,org-inbox)
         ,(concat "* Metting with %?\n at <%<%Y-%m-%d %a %^{Time}>>\n"
                  "/Entered on/ %U")
         :time-prompt t)
        ("l" "Inbox with link" entry (file+headline ,org-inbox "Miscellaneous")
         ,(concat "* %?\n %a"
                  "/Entered on/ %U"
                  "%i")
                  :kill-buffer t)
        ("@" "Inbox [mu4e]" entry (file+headline ,org-calendar "Mails")
         ,(concat "*  Reply to \"%a\" %?\n"
                  "/Entered on/ %U"))))
(setq org-gtd-capture-templates org-capture-templates)
#+end_src
*** org-timeblocks

We use [[https://github.com/ichernyshovvv/org-timeblock][org-timeblocks]] in order to have a timetable view of the weekly tasks.
#+begin_quote
Emacs package that provides interactive multiple-day timeblock view for orgmode tasks.
#+end_quote

The column width is computed wrongly. Currently, we have a hard-coded solution to make them approx. 30 pixel smaller.

#+begin_src emacs-lisp
(use-package org-timeblock
  :elpaca (org-timeblock :type git
                           :host github
                           :repo "ichernyshovvv/org-timeblock")
  :bind (:map ergoemacs-override-keymap ("C-c t" . org-timeblock))
        (:map org-timeblock-mode-map    ("q"     . org-timeblock-quit))
  :after (org-agenda)
  :demand t
  :custom
  (org-timeblock-scale-options '(7 . 21))
  (org-timeblock-span 7)
  )
#+end_src
*** TODO nano-calendar :INACTIVE:

At a later stage, we should incorporate[[https://github.com/rougier/nano-calendar][ nano-calendar]]. Since the package is dependent on nano-theme various strong modifications are required.
#+begin_src emacs-lisp
(use-package nano-calendar
  :elpaca (:type git :host github :repo "rougier/nano-calendar")
  :bind (:map ergoemacs-override-keymap ("C-c d" . nano-calendar)))
#+end_src
*** nano-agenda
We use the [[https://github.com/rougier/nano-agenda][nano-agenda]] for a small mini-buffer style agenda overview.
#+begin_src emacs-lisp
(use-package nano-agenda
  :elpaca (:type git :host github :repo "rougier/nano-agenda")
  :bind (:map ergoemacs-override-keymap ("C-c n" . nano-agenda)))
#+end_src
** TODO Caldav
We want to sync the agenda/calendar over multiple devices. Since we're lazy we will use gcal.

#+begin_src emacs-lisp
(use-package org-gcal
  :init
  (setq org-gcal-client-id         "609704434601-f52c59f8oo68jg4nfkkrbhfrf3senhbl.apps.googleusercontent.com"
        org-gcal-client-secret     "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"
        org-gcal-fetch-file-alist '(("sebastianhalbig77@googlemail.com" .
                                     "~/Documents/org-files/agenda/calendar.org"))
        plstore-cache-passphrase-for-symmetric-encryption t)
  :config
  (org-gcal-reload-client-id-secret))
#+end_src
* Mu4e
 We use [[https://www.djcbsoftware.nl/code/mu/][mu4e]] for dealing with emails.
 #+begin_quote
 With the enormous amounts of e-mail many people gather and the importance of e-mail message in our work-flows, it’s essential to quickly deal with all that mail - in particular, to instantly find that one important e-mail you need right now, and quickly file away message for later use.

 mu is a tool for dealing with e-mail messages stored in the Maildir-format. mu’s purpose in life is to help you to quickly find the messages you need; in addition, it allows you to view messages, extract attachments, create new maildirs, and so on.

 After indexing your messages into a Xapian-database, you can search them using a custom query language. You can use various message fields or words in the body text to find the right messages.
 #+end_quote

 Since our variant of mu4e is heavily modified we will start slow.

 Remark: Using mu is like a deal with the devil. It has amazing features at the price of changing its internals constantly. As our customisations rely on the internals, the following will be in the eternal "work in progress"-stage. By the way, as a feature, they sometimes kill variables without mentioning that in the news file, e.g. ~mu4e-view-html-plaintext-ratio-heuristic~.

 #+begin_src emacs-lisp :noweb yes
 (use-package mu4e
   :elpaca `(mu4e :host github :files ("mu4e/*.el"
                                       "build/mu4e/mu4e-meta.el"
                                       "build/mu4e/mu4e-config.el"
                                       "build/mu4e/mu4e.info")
                  :repo "djcb/mu"
                  :main "mu4e/mu4e.el"
                  :pre-build (("./autogen.sh")
                              ("ninja" "-C" "build")
                              (make-symbolic-link (expand-file-name "./build/mu/mu")
                                                  (expand-file-name "/bin/mu")
                                                  t)
                              )
                  :build (:not elpaca--compile-info)
                  :post-build (("mu" "init" "--quiet" "--maildir" ,
                                (concat (file-name-as-directory (getenv "HOME"))
                                        "Documents/.mails")
                                "--my-address=" ,"SebastianHalbig@gmx.de"
                                "--my-address=" ,"Sebastian.Halbig@uni-marburg.de"
                                "--my-address=" ,"halbigs@mathematik.uni-marburg.de"
                                "--my-address=" ,"xolotl.spam@web.de")
                               ("mu" "--quiet" "index")))
   :after relative-date
   :commands (mu4e mu4e-update-index)
   :bind (:map ergoemacs-override-keymap
               ("C-c m" . mu4e)
          :map mu4e-main-mode-map
               ("z" . (lambda ()
                        (interactive)
                        (let ((current-prefix-arg 1))
                          (call-interactively #'mu4e-quit))))
         :map mu4e-headers-mode-map
               ("g"       . mu4e-headers-mark-for-tag)
               ("<right>" . mu4e-headers-next-unread)
               ("<left>"  . mu4e-headers-prev-unread)
               ("x" . (lambda ()
                        (interactive)
                        (let ((current-prefix-arg 1))
                          (call-interactively #'mu4e-mark-execute-all)))))
   :hook ((mu4e-main-mode . (lambda ()(setq-local cursor-type nil)))
          (mu4e-headers-mode . (lambda ()(setq-local cursor-type nil))))
   :custom
   <<mu4e-custom>>
   :config
   ;;General configs
   <<mu4e-config>>
   ;;Composition settings
   <<mu4e-composition-settings>>
   ;; Bookmarks (shortkeys for the dashboard)
   <<mu4e-bookmarks>>
   ;;Mail contexts
   <<mu4e-web-de>>
   <<mu4e-dresden>>
   <<mu4e-gmx>>
   <<mu4e-marburg-internal>>
   <<mu4e-marburg>>
   ;;The headers view
   <<mu4e-headers>>
   ;;Autotagging and semi-smart tagging of messages
   <<mu4e-tags>>
   <<mu4e-tag-read>>
   ;; Some helpers for better refiling and spam handling
   <<mu4e-refile>>
   <<my-mu4e-spam-folder>>
   (setq mu4e-spam-folder 'my-mu4e-spam-folder)
   )
 #+end_src
** The :custom settings


#+NAME: mu4e-custom
#+begin_src emacs-lisp :tangle no
(mu4e-update-interval 300             "Update every five minutes")
(mu4e-get-mail-command "/usr/bin/offlineimap")
(mail-user-agent 'mu4e-user-agent     "Use mu4e as default email program")
(mu4e-maildir (expand-file-name       "~/Documents/.mails/"))
(mu4e-confirm-quit nil               "No confirmation needed to shutdown mu")

(mu4e-contexts nil)                   ; We set up the contexts later
(mu4e-context-policy 'pick-first)
(mu4e-drafts-folder nil)              ; The draft folders depend on the contexts, see there
(mu4e-sent-folder nil)                ; The draft folders depend on the contexts, see there
(mu4e-trash-folder nil)               ; The draft folders depend on the contexts, see there
(mu4e-attachment-dir                  "~/Downloads")
(message-signature nil)              ; The mail signature depends on the context.

(mu4e-sent-messages-behavior 'sent)
(mu4e-compose-context-policy 'ask-if-none "ask if there is no context, otherwise do nothing")

(mu4e-search-include-related t       "Also return messages related to search")
(mu4e-search-skip-duplicates t       "Don't show duplicates")

(mu4e-index-cleanup t                "Cleanup after indexing")
(mu4e-index-update-error-warning t   "Warnings during update")
(mu4e-hide-index-messages t          "Hide indexing messages")
(mu4e-index-update-in-background t   "Background update")
(mu4e-index-lazy-check nil           "Don't be lazy, index everything")

(mu4e-headers-auto-update t          "avoid to type `g' to update")
(mu4e-headers-date-format            "%d-%m") ; Fall-back option. See later configs.
(mu4e-headers-time-format            "%H:%M") ; Fall-back option. See later configs.
(mu4e-headers-from-or-to-prefix      '("" . "To "))

(mu4e-org-support t                   "org support in mu4e")
(mu4e-completing-read-function 'completing-read "We use the standard completing read")
(mu4e-use-fancy-chars t              "allow fancy icons for mail threads")

#+end_src
** Early :config settings

#+NAME: mu4e-config
#+begin_src emacs-lisp :noweb yes :tangle no
;; User name
(setq user-full-name "Sebastian Halbig")

;; Main user mail address
(setq user-mail-address "SebastianHalbig@gmx.de")

(setq professional-mail-signature (concat
                      "Sebastian Halbig — https://sebastianhalbig.github.io/main.html\n"
                      "Philipps-Universität Marburg — Research Group Algebraic Lie Theory\n"
                      "Hans-Meerwein-Straße 6 Room 04C35, 35043 Marburg\n"
                      "BBB home room: https://webconf.hrz.uni-marburg.de/d/seb-omn-wqu-r6k"))

#+end_src

** Contexts
We define the various mail contexts.
*** Web
#+NAME: mu4e-web-de
#+begin_src emacs-lisp :tangle no
(add-to-list 'mu4e-contexts
             (make-mu4e-context
              :name "Spam"
              :enter-func (lambda () (mu4e-message "Entering Spam context"))
              :leave-func (lambda () (mu4e-message "Leaving Spam context"))
              :match-func (lambda (msg)
                            (when msg
                              (mu4e-message-contact-field-matches
                               msg :to "xolotl.spam@web.de")))
              :vars `((user-mail-address . "xolotl.spam@web.de"  )
                      (user-full-name . "Sebastian Halbig" )
                      (mu4e-compose-signature . nil)
                      (mu4e-sent-folder . "/Web/sent")
                      (mu4e-trash-folder . "/Web/trash")
                      (mu4e-drafts-folder . "/Web/drafts")
                      (mu4e-maildir-shortcuts . (("/Web/inbox" . ?i)
                                                 ("/Web/archive" . ?a)
                                                 ("/Web/sent" . ?s)))
                      (smtpmail-smtp-server . "smtp.staff.uni-marburg.de")
                      (smtpmail-stream-type . starttls)
                      (smtpmail-smtp-service . 587))))
#+end_src

*** Dresden(deprecated)
#+NAME: mu4e-dresden
#+begin_src emacs-lisp :tangle no
(add-to-list 'mu4e-contexts
             (make-mu4e-context
              :name "TUDresden"
              :enter-func (lambda () (mu4e-message "Entering Dresden(deprecated) context"))
              :leave-func (lambda () (mu4e-message "Leaving Dresden(deprecated) context"))
              :match-func (lambda (msg)
                            (when msg
                              (mu4e-message-contact-field-matches
                               msg :to "sebastian.halbig@tu-dresden.de")))
              :vars `((user-mail-address . "Sebastian.Halbig@uni-marburg.de")
                      (user-full-name . "Sebastian Halbig" )
                      (message-signature . nil)
                      (mu4e-sent-folder . "/TUD/sent")
                      (mu4e-trash-folder . "/TUD/trash")
                      (mu4e-drafts-folder . "/TUD/drafts")
                      (mu4e-maildir-shortcuts . (("/TUD/inbox" . ?i)
                                                 ("/TUD/archive" . ?a)
                                                 ("/TUD/sent" . ?s)))
                      (smtpmail-smtp-server . "smtp.uni-marburg.de")
                      (smtpmail-stream-type . starttls)
                      (smtpmail-smtp-service . 587))))
#+end_src

*** Gmx

#+NAME: mu4e-gmx
#+begin_src emacs-lisp :tangle no
(add-to-list 'mu4e-contexts
             (make-mu4e-context
              :name "GMX"
              :enter-func (lambda () (mu4e-message "Entering GMX context"))
              :leave-func (lambda () (mu4e-message "Leaving GMX context"))
              :match-func (lambda (msg)
                            (when msg (mu4e-message-contact-field-matches
                                       msg :to "sebastianhalbig@gmx.de")))
              :vars `((user-mail-address . "SebastianHalbig@gmx.de"  )
                      (user-full-name . "Sebastian Halbig" )
                      (message-signature . nil)
                      (mu4e-sent-folder . "/GMX/sent")
                      (mu4e-trash-folder . "/GMX/trash")
                      (mu4e-drafts-folder . "/GMX/drafts")
                      (mu4e-maildir-shortcuts . (("/GMX/inbox" . ?i)
                                                 ("/GMX/archive" . ?a)
                                                 ("/GMX/sent" . ?s)))
                      (smtpmail-smtp-server . "mail.gmx.net")
                      (smtpmail-stream-type . starttls)
                      (smtpmail-smtp-service . 587))))
#+end_src
*** TODO Marburg-Internal
Currently we reroute the mail to the main account to avoid a bug of the mail server.

#+NAME: mu4e-marburg-internal
#+begin_src emacs-lisp :tangle no
(add-to-list 'mu4e-contexts
             (make-mu4e-context
              :name "Internal-Marburg"
              :enter-func (lambda () (mu4e-message "Entering Marburg(general) context"))
              :leave-func (lambda () (mu4e-message "Leaving Marburg(general) context"))
              :match-func (lambda (msg)
                            (when msg (mu4e-message-contact-field-matches
                                       msg :to "halbigs@mathematik.uni-marburg.de")))
              :vars `((user-mail-address . "Sebastian.Halbig@uni-marburg.de") ;;"halbigs@mathematik.uni-marburg.de"
                      (user-full-name . "Sebastian Halbig")
                      (message-signature . ,professional-mail-signature)
                      (mu4e-sent-folder . "/MarburgInternal/sent")
                      (mu4e-trash-folder . "/MarburgInternal/trash")
                      (mu4e-drafts-folder . "/MarburgInternal/drafts")
                      (mu4e-maildir-shortcuts . (("/MarburgInternal/inbox" . ?i)
                                                 ("/MarburgInternal/archive" . ?a)
                                                 ("/MarburgInternal/sent" . ?s)))
                      (smtpmail-smtp-server . "smtp.uni-marburg.de") ;; "smtp.mathematik.uni-marburg.de"
                      (smtpmail-stream-type . starttls)
                      (smtpmail-smtp-service . 587))))
#+end_src
*** Marburg

#+NAME: mu4e-marburg
#+begin_src emacs-lisp :tangle no
(add-to-list 'mu4e-contexts
             (make-mu4e-context
              :name "Marburg"
              :enter-func (lambda () (mu4e-message "Entering Marburg(general) context"))
              :leave-func (lambda () (mu4e-message "Leaving Marburg(general) context"))
              :match-func (lambda (msg)
                            (when msg (mu4e-message-contact-field-matches
                                       msg :to "Sebastian.Halbig@uni-marburg.de")))
              :vars `((user-mail-address . "Sebastian.Halbig@uni-marburg.de")
                      (user-full-name . "Sebastian Halbig")
                      (message-signature . ,professional-mail-signature)
                      (mu4e-sent-folder . "/Marburg/sent")
                      (mu4e-trash-folder . "/Marburg/trash")
                      (mu4e-drafts-folder . "/Marburg/drafts")
                      (mu4e-maildir-shortcuts . (("/Marburg/inbox" . ?i)
                                                 ("/Marburg/archive" . ?a)
                                                 ("/Marburg/sent" . ?s)))
                      (smtpmail-smtp-server . "smtp.uni-marburg.de")
                      (smtpmail-stream-type . starttls)
                      (smtpmail-smtp-service . 587))))
#+end_src
** Encryption

See https://www.djcbsoftware.nl/code/mu/mu4e/Reading-messages.html

#+begin_src emacs-lisp
(use-package epg-config
  :elpaca nil
  :config
  (setq epg-gpg-program "/usr/bin/gpg"        ; What gpg program to use
        epg-user-id "Sebastian Halbig <Sebastian.Halbig@uni-marburg.de>"
                                              ; GnuPG ID of your default identity
        mml2015-use 'epg                      ; The package used for PGP/MIME.
        mml2015-encrypt-to-self t             ; Add our own key ID to recipient list
        mml2015-sign-with-sender t)           ; Use message sender to find a key to sign with.

  (require 'epa-file)
  (epa-file-enable)
  (setq epa-file-select-keys nil)
  (setq epa-pinentry-mode 'loopback)
  )
#+end_src
** Message composition

See www.gnu.org/software/emacs/manual/html_node/message/Insertion-Variables.html
We try to sign all mails. Encryption should also be managed automatically

#+NAME: mu4e-composition-settings
#+begin_src emacs-lisp :tangle no

(setq message-send-mail-function 'smtpmail-send-it    ; We use smptmail
      smtpmail-servers-requiring-authorization '".*"  ; All servers require authorisation
      message-cite-reply-position 'below
      message-citation-line-format "%N [%Y-%m-%d at %R] wrote:" ;
      message-citation-line-function 'message-insert-formatted-citation-line
      message-yank-prefix       "> " ; Mails are quoted by preprending a ">" character
      message-yank-cited-prefix "> " ; Mails are quoted by preprending a ">" character
      message-yank-empty-prefix "> " ; Mails are quoted by preprending a ">" character
      message-indentation-spaces 1
      message-kill-buffer-on-exit t  ; We kill the message buffer after sending.

      mu4e-compose-format-flowed t   ; Sent messages as format=flowed.
      mu4e-compose-complete-only-personal t  ; Less autocompletion see description.
      ;; mu4e-compose-complete-only-after "2021-01-01" ; Limit address auto-completion

      mu4e-compose-crypto-policy '(encrypt-encrypted-replies sign-all-messages))
     ;; We only encrypt messages replies to encrypted messages but sign all messages.

(defun my-mu4e-compose-hook ()
  "Settings for message composition."
  (auto-save-mode -1)
  (delete-other-windows))

(add-hook 'mu4e-compose-mode-hook #'my-mu4e-compose-hook)

#+end_src

** Org-msg integration :INACTIVE:
FOR NOW NO ORG-MSG
#+begin_src emacs-lisp :tangle no
(use-package org-msg
  :elpaca (:type git
           :host github
           :repo "jeremy-compostella/org-msg"
           :branch "mu-1.12-support-with-backward-compatibility")
  :preface
  (defun org-msg-no-temp-buffer (orig-fun &rest args)
    "Advice to set `org-export-show-temporary-export-buffer' to `nil'."
    (let ((org-export-show-temporary-export-buffer nil))
      (apply orig-fun args)))
  :after mu4e
  :hook (mu4e-main-mode . org-msg-mode)
  :config
  (setq org-msg-startup "content"
        org-msg-options "toc:nil author:nil email:nil \\n:t broken-links:t"
        org-msg-greeting-fmt "\nHi%s,\n\n"
        org-msg-greeting-name-limit 3
        org-msg-default-alternatives '((new        . (utf-8))
                                       (reply-to-html . (utf-8))
                                       (reply-to-text . (utf-8)))
        org-msg-convert-citation t
        org-msg-signature "" )
  (advice-add 'org-msg-preview :around #'org-msg-no-temp-buffer)
  (advice-add 'org-msg-ctrl-c-ctrl-c :around #'org-msg-no-temp-buffer)
  (add-hook 'message-sent-hook
            (lambda ()
              (interactive)
              (switch-to-buffer "*mu4e-article*")
              (mu4e-view-quit)
              (kill-buffer "*Org ASCII Export*")))
(add-to-list 'message-send-actions #' (lambda () (interactive)(kill-buffer '"*Org ASCII Export*"))))


#+end_src
** TODO Mailcap

[[https://www.gnu.org/software/emacs/manual/html_node/emacs-mime/mailcap.html][Mailcap.el]] is a part of emacs amd responsible for mime handling.
#+begin_quote
Provides configuration of MIME media types from directly from Lisp and via the usual mailcap mechanism (RFC 1524). Deals with mime.types similarly.
#+end_quote
See also the [[https://www.gnu.org/software/emacs/manual/html_node/emacs-mime/index.html][Emacs MIME wiki.]]

** Bookmarks
These are the standard mu4e-header-view targets.
#+NAME: mu4e-bookmarks
#+begin_src emacs-lisp :tangle no
(setq mu4e-bookmarks
      '((:name "Unread"
               :key ?u
               :show-unread t
               :query "flag:unread AND (m:/GMX/inbox or m:/TUD/inbox or m:/Marburg/inbox or m:/MarburgInternal/inbox or m:/Web/inbox) AND NOT flag:trashed")

        (:name "Inbox"
               :key ?i
               :show-unread t
               :query "m:/GMX/inbox or m:/TUD/inbox or m:/Marburg/inbox or m:/MarburgInternal/inbox or m:/Web/inbox")

        (:name "Sent"
               :key ?s
               :show-unread nil
               :query "from:Sebastian.Halbig or from:halbigs or from: SebastianHalbig")

        (:name "Drafts"
               :key ?d
               :hide-unread t
               :query "flag:draft")
        ))
#+end_src
** Layout for mu4e
*** Headers

#+NAME: mu4e-headers
#+begin_src emacs-lisp :noweb yes :tangle no
;; Helper functions for our customisation of the header fields
<<my-mu4e-get-sender>>
<<my-mu4e-get-mailbox>>
<<my-mu4e-get-maildir>>
<<my-mu4e-get-account>>

<<mu4e-my-date>>
<<mu4e-my-from>>
<<mu4e-my-flags>>
<<mu4e-my-tags>>
<<mu4e-my-subject>>

(setq mu4e-headers-fields
      '((:my-flags   . 2)
        (:my-from    . 25)
        (:my-subject . 70)
        (:my-tags    . 10)
        (:my-date    . nil)
        ))

(plist-put (cdr (assq 'tag      mu4e-marks)) :char "󰓼")
(plist-put (cdr (assq 'archive  mu4e-marks)) :char "󱈎")
(plist-put (cdr (assq 'refile   mu4e-marks)) :char "󱈎")
(plist-put (cdr (assq 'delete   mu4e-marks)) :char "󰮉")
(plist-put (cdr (assq 'flag     mu4e-marks)) :char "󰓒")
(plist-put (cdr (assq 'move     mu4e-marks)) :char "󰧂")
(plist-put (cdr (assq 'read     mu4e-marks)) :char "󰴃")
(plist-put (cdr (assq 'trash    mu4e-marks)) :char "󰧧")
(plist-put (cdr (assq 'unflag   mu4e-marks)) :char "󱣯")
(plist-put (cdr (assq 'untrash  mu4e-marks)) :char "󰜉")
(plist-put (cdr (assq 'unread   mu4e-marks)) :char "󰮒")
(plist-put (cdr (assq 'unmark   mu4e-marks)) :char "󱣯")
(plist-put (cdr (assq 'action   mu4e-marks)) :char "󰢻")
#+end_src

***** Date (custom info)

We use the [[https://github.com/rougier/relative-date][relative-date]] package for displaying when we got an email.
#+begin_quote
This package allows to format the difference between two dates according to the value of their difference (expressed in seconds) or a symbolic relationship between the two dates (e.g. ‘today). The main entry points for the library are the relative-date function and the relative-date-formats variable.
#+end_quote

#+begin_src emacs-lisp
(use-package relative-date
  :elpaca (:type git :host github :repo "rougier/relative-date")
  :demand t)
#+end_src
#+NAME: mu4e-my-date
#+begin_src emacs-lisp :tangle no
(require 'relative-date)

(defun my-mu4e-headers-date (msg)
  (let* ((date (mu4e-message-field msg :date)))
    (format "%12s" (relative-date date))))

(add-to-list 'mu4e-header-info-custom
             '(:my-date . (:name "my-date"
                                 :shortname "D"
                                 :function my-mu4e-headers-date)))
#+end_src

***** From (custom info)

#+NAME: mu4e-my-from
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-headers-from (msg)
  (let* ((from        (my-mu4e-get-sender msg))
         (meta        (when msg (mu4e-message-field msg :meta)))
         (root        (when meta (plist-get meta :root)))
         (orphan      (when meta (plist-get meta :orphan)))
         (first-child (when meta (plist-get meta :first-child)))
         (has-child   (when meta (plist-get meta :has-child)))
         (from        (cond ((and root has-child)       (concat " " from))
                            ((and orphan first-child)   (concat " " from))
                            ((and root (not has-child)) (concat "" from))
                            (t                          (concat "│ " from)))))
     from ))

(add-to-list 'mu4e-header-info-custom
             '(:my-from . (:name "my-from"
                                 :shortname "F"
                                 :function my-mu4e-headers-from)))

#+end_src

***** Flags (custom info)

#+NAME: mu4e-my-flags
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-headers-flags (msg)
  (let* ((size (mu4e-message-field msg :size))
         (flags (cond ((memq 'flagged   (mu4e-message-field msg :flags)) "󰓒")
                      ((and (> size 256000) (memq 'attach (mu4e-message-field msg :flags))) "󰁦")
                      ((memq 'replied   (mu4e-message-field msg :flags)) "󰼠")
                      ((memq 'draft     (mu4e-message-field msg :flags)) "󰣕")
                      ((memq 'trashed   (mu4e-message-field msg :flags)) "󰩺")
                      ((memq 'encrypted (mu4e-message-field msg :flags)) "󰍁")
                      ((memq 'signed    (mu4e-message-field msg :flags)) "󱝀")
                      (t ""))))
     flags ))

(add-to-list 'mu4e-header-info-custom
             '(:my-flags . (:name "my-flags"
                                  :shortname "F"
                                  :function my-mu4e-headers-flags)))

#+end_src

***** Tags (custom info)

We want pretty tags to get a good overview what an email is about.
This is managed by the ~my-prettify-tag-alist~. Using ~my-prettify-tag~, we replace tags by their symbols

#+NAME: mu4e-my-tags
#+begin_src emacs-lisp :tangle no

(defvar my-prettify-tag-alist
  '(("RESEARCH"       . "󰺿")
    ("INVOICE"        . "󰺀")
    ("TEACHING"       . "󱆀")
    ("INFO"           . "󰋽")
    ("ORGANISATIONAL" . "󰡆")))

(defun my-prettify-tag (tag)
  "Replaces any given tag by the corresponding symbol as specified in my-prettify-tag-alist"
  (let* ((local-tag tag)
         (prettified-tag (car (split-string local-tag ","))))
    (dolist (sym-pair my-prettify-tag-alist)
      (when (string= prettified-tag (car sym-pair))
        (setq prettified-tag (cdr sym-pair)))
      )
    prettified-tag
    ))


(defface mu4e-tag-face
  '((t :inherit (lambda-focus)))
  "Face for message tags"
  :group 'mu4e-faces)

(defun my-mu4e-headers-tags (msg)
  "Reads of the tags of msg. If part of a thread and not endowed with a tag,
  automatically tags the message at point with the tag of the parent message.
  Finally, tags are prettified."
  (let ((tags (mu4e-message-field msg :tags)))
    (when (and (not (mu4e-thread-is-root msg)) (not tags))
      (let* ((old-point (point))
             (root-pos (goto-char (mu4e-thread-root)))
             (root (mu4e-message-at-point))
             (root-tag (mu4e-message-field root :tags)))
        (when root-tag
          (goto-char old-point)
          (setq tags root-tag)
          (mu4e-action-retag-message msg (concat "+" (mapconcat #'identity root-tag  ",+")))
          )
      ))
    (if tags
        (propertize (format "%s" (mapconcat #'my-prettify-tag tags " "))
                    'face 'mu4e-tag-face)
      "  ")))
(add-to-list 'mu4e-header-info-custom
             '(:my-tags . (:name "my-tags"
                                 :shortname "T"
                                 :function my-mu4e-headers-tags)))

#+end_src

***** Subject (custom info)

#+NAME: mu4e-my-subject
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-headers-subject (msg)
  (let* ((subject (mu4e-message-field msg :subject)))
    subject))

(add-to-list 'mu4e-header-info-custom
             '(:my-subject . (:name "my-subject"
                                    :shortname "S"
                                    :function my-mu4e-headers-subject)))

#+end_src

** mu4e-helper functions
*** Account and maildir information extraction

#+NAME: my-mu4e-get-account
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-get-account (msg)
  "Get MSG related account."

  (let* ((maildir (mu4e-message-field msg :maildir))
         (maildir (substring maildir 1)))
    (nth 0 (split-string maildir "/"))))

#+end_src

#+NAME: my-mu4e-get-maildir
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-get-maildir (msg)
  "Get MSG related maildir."

  (let* ((maildir (mu4e-message-field msg :maildir))
         (maildir (substring maildir 1)))
    (nth 0 (reverse (split-string maildir "/")))))

#+end_src

#+NAME: my-mu4e-get-mailbox
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-get-mailbox (msg)
  "Get MSG related mailbox as 'account - maildir' "

  (format "%s - %s" (mu4e-get-account msg) (mu4e-get-maildir msg)))

#+end_src

#+NAME: my-mu4e-get-sender
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-get-sender (msg)
  "Get MSG sender."

  (let ((addr (cdr-safe (car-safe (mu4e-message-field msg :from)))))
    (mu4e~headers-contact-str (mu4e-message-field msg :from))))

#+end_src

Move emails to the relative spam folder.

#+NAME: my-mu4e-spam-folder
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-spam-folder (msg)
  "Contextual spam handling"

  (let ((maildir (mu4e-message-field msg :maildir)))
    (concat "/" (nth 1 (split-string maildir "/")) "/spam")))

#+end_src

*** Tags

We define a quick tagging function to endow messages with one of the tags defined in ~mu4e-tagging-tags~.

#+NAME: mu4e-tag-read
#+begin_src emacs-lisp :tangle no
(defvar mu4e-tagging-tags '("RESEARCH" "TEACHING" "ORGANISATIONAL" "INFO" "INVOICE")
  "Predefined tags for the quick tagging function ~mu4e-tag-read~.")

(defun mu4e-tag-read (target msg)
    "Ask for tags to be added and/or removed."
    (let* ((tags nil)
           (old-tags (mu4e-message-field msg :tags))
           (new-tags (completing-read
                      "TAGS: "
                      mu4e-tagging-tags
                      nil
                      t
                      (mapconcat #'identity old-tags ",")
                      )))
      (dolist (tag old-tags)
        (let ((tag (string-trim tag)))
          (if (and (> (length tag) 0)
                   (not (string= tag new-tags)))
              (push (concat "-" tag) tags))))
         (let ((new-tags (string-trim new-tags)))
          (if (and (> (length new-tags) 0)
                   (not (member new-tags old-tags)))
              (progn
                (push (concat "+" new-tags) tags))))
      (mapconcat #'identity tags ",")))

;; Add the mark to mu4e. If the action does nothing, the header is marked anyway.
;; I Did not find a way to cancel the marks
(add-to-list 'mu4e-marks
             '(tag
               :char       "g"
               :prompt     "gtag"
               :dyn-target mu4e-tag-read
               :action      (lambda (docid msg target)
                              (when (> (length target) 0)
                                (mu4e-action-retag-message msg target)))))

;; Tell mu4e about the new mark
;; See https://www.djcbsoftware.nl/code/mu/mu4e/Adding-a-new-kind-of-mark.html
(mu4e~headers-defun-mark-for tag)

#+end_src

*** TODO Context dependent refile

Refile depending on the context (expressed by message tags).
Message will be move to MAILDIR/archive/tag-dependent-folder.

#+NAME: mu4e-refile
#+begin_src emacs-lisp :tangle no

(defun my-mu4e-refile-folder (msg)
  "Contextual refile."

  (let (
        (maildir (mu4e-message-field msg :maildir))
        (tags (mu4e-message-field msg :tags))
        (subfolder "saved")
        )
    (cond
     ((member "ORGANISATIONAL" tags) (setq subfolder "organisational"))
     ((member "INFO" tags) (setq subfolder "info"))
     ((member "TEACHING" tags) (setq subfolder "teaching"))
     ((member "RESEARCH" tags) (setq subfolder "research"))
     ((member "INVOICE" tags) (setq subfolder "invoice"))
     )
    (concat "/" (nth 1 (split-string maildir "/")) "/archive/" subfolder)
    ))

(setq mu4e-refile-folder 'my-mu4e-refile-folder)

(add-to-list 'mu4e-marks
             '(archive
               :char       "r"
               :prompt     "Archive"
               :dyn-target (lambda (target msg) (my-mu4e-refile-folder msg))
               :action      (lambda (docid msg target)
                              (mu4e--server-move docid (my-mu4e-refile-folder msg) "+S-u-N")
                              )))


(mu4e~headers-defun-mark-for archive)
(define-key mu4e-headers-mode-map (kbd "r") 'mu4e-headers-mark-for-archive)

#+end_src

* Math-mode
Writing long LaTeX documents is painful. In the following, we make set up some functionalities to make our life easier.
We begin with some basic latex default settings.

#+begin_src emacs-lisp
(use-package tex
  :defer t
  :elpaca nil
  :ensure auctex
  :config
  (setq TeX-auto-save t                      ; We automatically save style information when saving the buffer.
        TeX-parse-self t                       ; Parse the file after loading it if no style hook is found.
        ;; TeX-PDF-mode t                      ; We use PDFTeX mode
        TeX-source-correlate-mode t            ; Correlate (La-)TeX files with their PDF output.
        TeX-source-correlate-start-server nil) ; We do start a server for correlation.
  (setq-default TeX-master nil)              ; We do not specify the master files globally.

  (setq ispell-dictionary "british")         ; The default language is British English.

  (visual-line-mode)                         ; Only visual line wrapping.

  (setq TeX-open-quote "`")                  ; We use single quotation marks.
  (setq TeX-close-quote "'")                 ; We use single quotation marks.
  (setq font-latex-fontify-sectioning 1.0)   ; We set section hights to 1.

  (advice-add
   'TeX-source-correlate-sync-source
   :after
   (lambda (&rest r) (recenter)))
  )

#+end_src

** Compilation and PDF output

We compile LaTeX files using latexmk and view the resulting pdf in evince.

#+begin_src emacs-lisp

(use-package auctex-latexmk
  :ensure auctex
  :init
  (add-to-list 'TeX-command-list '("LatexMk"
                                   "latexmk %(-PDF)%S%(mode) -pv -view=pdf  -interaction=nonstopmode -synctex=1 %(file-line-error) %(extraopts) %t"
                                   TeX-run-latexmk
                                   nil
                                   (plain-tex-mode latex-mode doctex-mode)
                                   :help "Run LatexMk")) ; We compile latex documents with latexmk
  :preface
  (defun my-latex-compile ()
    "Compile latex files with latexmk"
    (interactive)
    (save-buffer)
    (TeX-command "LatexMk" 'TeX-master-file)
    )
  :hook
  ((latex-mode  LaTeX-mode) . auctex-latexmk-setup)
  (TeX-after-TeX-LaTeX-command-finished-hook . TeX-view)
  (TeX-after-compilation-finished-functions . TeX-view)
  (TeX-after-compilation-finished-functions . TeX-revert-document-buffer) ; refreshes the pdf output if PDF Tools is used
  :config
  (setq TeX-view-program-selection '((output-pdf "Evince"))) ; We use Evince as standard pdf-viewer. An alternative is PDF Tools.
  :bind (:map LaTeX-mode-map
              ("<f5>" . my-latex-compile))
  ;; :hook (TeX-after-compilation-finished-functions . TeX-revert-document-buffer) ; refreshes the pdf output if PDF Tools is used
  )

#+end_src

* Remaining latex :INACTIVE:DEFER:MODE:BINDING:
** Bibliography
We use reftex for handling the bibliography.
Our setup follows Tony Zorman.

#+begin_src emacs-lisp

(use-package reftex
  :hook (LaTeX-mode . turn-on-reftex)
  :config (reftex-set-cite-format "\\cite[][]{%l}")
  :custom
  (reftex-plug-into-AUCTeX t)               ; Integrate reftex into auctex.
  (reftex-toc-split-windows-horizontally t) ; Show reftex TOC on the left.
  (reftex-ref-macro-prompt nil)             ; No unnecessary prompts
  (reftex-label-alist              ; Tell reftex about some environments.
   '(("section"     ?s "sec:"  "~\\ref{%s}" t (regexp "[Ss]ection\\(s\\)?"       ))
     ("definition"  ?d "def:"  "~\\ref{%s}" t (regexp "[Dd]efinition\\(s\\)?"    ))
     ("example"     ?x "ex:"   "~\\ref{%s}" t (regexp "[Ee]xample\\(s\\)?"       ))
     ("lemma"       ?l "lem:"  "~\\ref{%s}" t (regexp "[Ll]emma\\(s\\|ta\\)?"    ))
     ("proposition" ?p "prop:" "~\\ref{%s}" t (regexp "[Pp]roposition\\(s\\)?"   ))
     ("theorem"     ?h "thm:"  "~\\ref{%s}" t (regexp "[Tt]heorem\\(s\\)?"       ))
     ("remark"      ?r "rem:"  "~\\ref{%s}" t (regexp "[Rr]emark\\(s\\)?"        ))
     ("corollary"   ?c "cor:"  "~\\ref{%s}" t (regexp "[Cc]orollar\\(y\\|ies\\)?")))))

#+end_src

** Editing and Autocompletion

CdLaTeX makes a lot of editing work easier.
We initialise it here and sprinkle it with a few of our own features.


#+begin_src emacs-lisp

(use-package cdlatex
  :hook
  (LaTeX-mode . turn-on-cdlatex    ) ; with AUCTeX LaTeX mode
  (org-mode   . turn-on-org-cdlatex) ; Use subset of cdlatex for org mode
  :custom
  (cdlatex-paired-parens nil) ; We will use aas to pair parentheses.
  ;; Custom bindings for the math modify list, accessed with '
  (cdlatex-math-modify-alist
   '(;;  MATHCMD      TEXTCMD    ARG RMDOT IT
     (?b "\\mathbb"   "\\textbf" t   nil   nil)
     (?f "\\mathbf"   "\\textsf" t   nil   nil)
     (?l "\\ld"       "\\textsl" t   nil   nil)
     (?k "\\mathfrak" nil        t   nil   nil)
     (?t "\\text"     nil        t   nil   nil)
     (?u "\\lld"      ""         t   nil   nil)
     ))
  ;; Custom bindings for the symbol list, accessed with `.  You may add
  ;; additional layers here.  Also, some of these are user-defined
  ;; commands.
  (cdlatex-math-symbol-alist
   '(;;    LAYER 1        LAYER 2      LAYER 3
     (?c  ("\\circ"           ""           "\\cos"   ))
     (?C  ("\\coprod"     ""           "\\arccos"))
     (?e  ("\\varepsilon"           "\\epsilon"         "\\exp"   ))
     (?f  ("\\varphi"          "\\phi"          ""        ))
     (?F  ("\\Phi"           ""           ""        ))
     (?R  ("\\real"          "\\Re"        ""        ))
     (?N  ("\\nat"       "\\nabla"          "\\exp"   ))
     (?Z  ("\\integer"    ""           ""        ))
     (?Q  ("\\rat"        "\\Theta"         ""        ))
     (?0  ("\\varnothing" ""           ""        ))
     (?{  ("\\subseteq"   "\\subset"         ""        ))
     (?}  ("\\supseteq"   "\\supset"         ""        ))
     (?.  ("\\cdot"           "\\dots"          ""        ))
     (?^  ("\\otimes"          ""            ""        ))
     (?ö  ("\\odot"           ""            ""        ))
     ))
  :config
  (setq cdlatex-tab-hook '(yas-expand indent-for-tab-command)))

#+end_src

We set try to be clever about our uses of <return> and <$>.

#+begin_src emacs-lisp
(use-package smart-keys-for-latex
  :ensure reftex
  :after cdlatex
  :config (setup-smart-keys)
  :bind (:map cdlatex-mode-map
              ("$" . cycle-texmath)
              :map TeX-mode-map
              ("RET" . smart-return)
              )
  )
#+end_src

Some latex-commands that are auto-expanded by aas.

#+begin_src emacs-lisp
(use-package aas
  :after dash
  :init
  (yas-minor-mode 1)
  (laas-mode 1)
  :hook ((LaTeX-mode org-mode) . aas-activate-for-major-mode)
  :config
  (--each '(latex-mode) ;; TODO integrate qorg-mode
    (aas-set-snippets it
                      :cond #'(lambda()(and (texmathp) (car texmathp-why)))
                      " :"      "\\from "
                      " **"     "\\star"
                      " mm"     "\\mid "
                      " ->"     "\\to "
                      " mt"     "\\mapsto "
                      " =>"     "\\implies "
                      " in"     "\\in"
                      " ..."    "\\dots"
                      " blank"  "\\blank"
                      " def"    "\\defeq"
                      " ~"      "\\sim"
                      " =="     "\\cong"
                      " ot"     "\\otimes"
                      " bn"     "\\mathbb{N}"
                      " bz"     "\\mathbb{Z}"
                      " bq"     "\\mathbb{Q}"
                      " br"     "\\mathbb{R}"
                      " bc"     "\\mathbb{C}"
                      " bf"     "\\mathbb{F}"
                      " bp"     "\\mathbb{P}"
                      " fg"     "\\mathfrak{g}"
                      " fh"     "\\mathfrak{h}"
                      " cc"     "\\cat{C}"
                      " cd"     "\\cat{D}"
                      " cm"     "\\cat{M}"
                      " zc"     "\\ZCat{C}"
                      " subset" "\\subset"
                      " supset" "\\supset"
                      " angled"    (lambda () (interactive)
                                     (yas-expand-snippet "\\langle $0 \\rangle"))
                      " adj"   (lambda () (interactive)
                                 (yas-expand-snippet "\\adj{${1:F}}{${2:U}}{${3:\\cc}}{${4:\\mm}} $0"))
                      " hom"  (lambda () (interactive)
                                (yas-expand-snippet "${1:\\cc}(${2:s}, ${3:t})"))
                      " coend" (lambda () (interactive)
                                 (yas-expand-snippet "\\int^{${2:C \\in \\cc}}"))
                      " end"   (lambda () (interactive)
                                 (yas-expand-snippet "\\int_{${2:C \\in \\cc}}"))
                      " set"   (lambda () (interactive)
                                 (yas-expand-snippet "\\\\{$0\\\\}"))
                      " sum"   (lambda () (interactive)
                                 (yas-expand-snippet "\\sum_{${1:i=1}}^{${2:n}}$0"))
                      ;;" gl"    (lambda () (interactive)
                      ;;          (yas-expand-snippet "\\mathfrak{gl}_{${1:n}}$0"))
                      ;;" //"    (lambda () (interactive)
                      ;;          (yas-expand-snippet "\\frac{$1}{$2}$0"))
                      " cat"   (lambda () (interactive)
                                 (yas-expand-snippet "\\cat{$1}$0")))))

#+end_src

** TODO Visuals

It just makes more fun to write latex if it already looks nice while writing.
As a preventive measure to eye-cancer we change most of the auctex defaults to something humans can bare.

#+begin_src emacs-lisp
(defun my-LaTeX-better-fonts()
  (set-face-attribute 'font-latex-bold-face nil
                      :foreground 'unspecified
                      :weight 'bold
                      :inherit 'unspecified)

  (set-face-attribute 'font-latex-italic-face nil
                      :family "Victor Mono"
                      :foreground 'unspecified
                      :slant 'oblique
                      :inherit 'unspecified)

  (set-face-attribute 'font-latex-math-face nil
                      :height 'unspecified
                      :foreground 'unspecified
                      :weight 'semilight
                      :inherit 'nano-strong)

  (set-face-attribute 'font-latex-script-char-face nil
                      :foreground 'unspecified)

  (set-face-attribute 'font-latex-warning-face nil
                      :foreground 'unspecified
                      :inherit 'nano-faded)

  (set-face-attribute 'font-latex-sectioning-0-face nil
                      :height 'unspecified
                      :weight 'bold
                      :foreground 'unspecified
                      :underline t
                      :inherit 'nano-salient)

  (set-face-attribute 'font-latex-sectioning-1-face nil
                      :height 'unspecified
                      :foreground 'unspecified
                      :inherit 'font-latex-sectioning-0-face)

  (set-face-attribute 'font-latex-sectioning-2-face nil
                      :height 'unspecified
                      :foreground 'unspecified
                      :inherit 'font-latex-sectioning-1-face)

  (set-face-attribute 'font-latex-sectioning-3-face nil
                      :height 'unspecified
                      :foreground 'unspecified
                      :inherit 'font-latex-sectioning-2-face)

  (set-face-attribute 'font-latex-sectioning-4-face nil
                      :weight 'normal
                      :height 'unspecified
                      :foreground 'unspecified
                      :underline nil
                      :inherit 'font-latex-sectioning-3-face)

  (set-face-attribute 'font-latex-sectioning-5-face nil
                      :weight 'normal
                      :height 'unspecified
                      :foreground 'unspecified
                      :inherit 'font-latex-sectioning-4-face)

  (set-face-attribute 'font-latex-slide-title-face nil
                      :height 'unspecified
                      :inherit 'font-latex-sectioning-0-face)

  (set-face-attribute 'font-latex-underline-face nil
                      :height 'unspecified
                      :foreground 'unspecified
                      :underline t)

  (set-face-attribute 'font-lock-keyword-face nil
                      :inherit 'nano-faded)

  (set-face-attribute 'font-lock-constant-face nil
                      :inherit 'nano-faded)

  (set-face-attribute 'font-lock-comment-face nil
                      :inherit 'nano-subtle)
  )

(use-package font-latex
  :hook (LaTeX-mode . my-LaTeX-better-fonts)
  :config
  )

#+end_src
First, we fold away annoying parts like comments or commuting diagrams.
The code for this function is due to Tony Zorman.

#+begin_src emacs-lisp

(defun my-LaTeX-fold-annoyances ()
  "Fold annoyances.
Everything that makes the LaTeX file worse to look at—things like
commutative diagrams, as well as comments."
  (interactive)
  (TeX-fold-mode)
  (TeX-fold-region-comment (point-min) (point-max))
  (setq-local TeX-fold-env-spec-list-internal
              '(("≪commutative diagram≫" ("tikzcd"))
                ("≪tikz picture≫" ("tikzpicture"))))
  (TeX-fold-region-macro-or-env (point-min) (point-max) 'env))

#+end_src

Some symbols we want to display differently. Font-locking allows us to do so.

#+begin_src emacs-lisp
(defun latex-regexp-prettify ()
  "We use an unobtrusive font for certain latex-internal formating rules such as `{...}'"
  (highlight-regexp "{" 'custom-comment)
  (highlight-regexp "}" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\quad[[:space:]]*" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\qquad[[:space:]]*" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\,[[:space:]]*" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\;[[:space:]]*" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\enspace[[:space:]]*" 'custom-comment)
  (highlight-regexp "[[:space:]]*\\\\emspace[[:space:]]*" 'custom-comment)
  )

(add-hook 'LaTeX-mode-hook 'latex-regexp-prettify)
#+end_src

In order to prettify symbols, we use fira code and a long list of symbols which are replaced.

#+begin_src emacs-lisp
(defun my-LaTeX-fira-pitch ()
  (set-face-attribute 'font-latex-math-face nil
                      :family "Fira Code"
                      :weight 'semilight
                      :height 140)
  )

(defun latex-symbols-prettify ()
  "A long list of symbols to display nicely in latex-mode"
  (mapc (lambda (pair) (add-to-list 'prettify-symbols-alist pair))
        ;; ARROWS
        '(("\\to"                  32 (Br . Bl) 32 (Br . Br) 57620)
          ("\\rightarrow"          32 (Br . Bl) 32 (Br . Br) 57620)
          ("\\mapsto"              8870 (cr  cl 16 0) 57620)
          ("\\longmapsto"          32 (Br . Bl)  8866 (cr . cl) 32 (Br . Bl)  32 (Br . Br)  57619)
          ("\\inj"                 5308 (tl  tl 20 0) 32 (tr  tl 0 -5) 57620)
          ("\\emb"                 5308 (tl  tl 20 0) 32 (tr  tl 0 5) 57620)
          ("\\hookrightarrow"      5354 (tl . tl) 32 (tr . tl) 57620)
          ("\\surj"                32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57621)
          ("\\proj"                32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57621)
          ("\\twoheadrightarrow"   32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57621)
          ("\\twoheadleftarrow"    32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57693)
          ("\\longrightarrow"      32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57619)
          ("\\rightsquigarrow"     32 (Br . Bl) 32 (Br . Br) 57703)
          ("\\leftarrow"           32 (Br . Bl) 32 (Br . Br) 57682)
          ("\\longleftarrow"       32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57683)
          ("\\leftrightarrow"      32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57684)
          ("\\leftsquigarrow"      32 (Br . Bl) 32 (Br . Br) 57696)
          ("\\Rightarrow"          32 (Br . Bl) 32 (Br . Br) 57663)
          ("\\Longrightarrow"      32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57662)
          ("\\implies"             32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57662)
          ("\\Leftarrow"           32 (Br . Bl) 32 (Br . Br) 57688)
          ("\\Longleftarrow"       32 (Br . Bl) 32 (Br . Br) 57688)
          ("\\impliedby"           32 (Br . Bl) 32 (Br . Br) 57688)
          ("\\Leftrightarrow"      32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57689)
          ("\\upharpoonleft"       ?↿)
          ("\\upharpoonright"      ?↾)
          ("\\downharpoonleft"     ?⇃)
          ("\\downharpoonright"    ?⇂)
          ("\\hookleftarrow"       ?↩)
          ("\\looparrowleft"       ?↫)
          ("\\looparrowright"      ?↬)
          ("\\leftrightsquigarrow" ?↭)
          ("\\leftleftarrows"      ?⇇)
          ("\\rightrightarrows"    ?⇉)
          ("\\leftrightarrows"     ?⇆)
          ("\\rightleftarrows"     ?⇄)
          ("\\Lleftarrow"         ?⇚)
          ("\\Rrightarrow"        ?⇛)
          ;; ENVIRONMENTS
          ("\\part"                ?#)
          ("\\section"             32 (Br . Bl) 32 (Br . Br) 57627)
          ("\\subsection"          32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57628)
          ("\\subsubsection"       32 (Br . Bl) 32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57629)
          ("\\begin"               32 (Br . Bl) 32 (Br . Br) 57653)
          ("\\end"                 32 (Br . Bl) 32 (Br . Br) 57677)
          ("\\item"                32 (Br . Bl) 32 (Br . Bl) 32 (Br . Br) 57686)
          ;; SPACING
          ("\\,"                  8194 (Bc . Bc) 8231)
          ("\\:"                  8194 (Bc . Bc) 8231)
          ("\\;"                  8194 (Bc . Bc) 8231)
          ("\\enspace"            8194 (Bc . Bc) 8231)
          ("\\emspace"            8195 (Bc . Bc) 8231)
          ("\\quad"               8231 (Bc . Bc) 8195 (Br . Bl) 8231 (Bc . Bc) 8195)
          ("\\qquad"              8231 (Bc . Bc) 8195 (Br . Bl) 8231 (Bc . Bc) 8195 (Br . Bl) 8231 (Bc . Bc) 8195 (Br . Bl) 8231 (Bc . Bc) 8195)
          ;; SETS
          ("\\mathbb{N}"           ?\u2115)
          ("\\mathbb{R}"           ?\u211D)
          ("\\mathbb{C}"           8450)
          ("\\mathbb{P}"           8473)
          ("\\mathcal{C}"          120018)
          ("\\cat{C}"              120018)
          ("\\mathcal{D}"          120019)
          ("\\cat{D}"              120019)
          ("\\cat{E}"              120020)
          ("\\cat{M}"              120028)
          ("\\cat{N}"              120029)
          ("\\mathfrak{C}"         120174)
          ("\\mathfrak{D}"         120175)
          ("\\ZCat"                120041)
          ;; OPERATORS
          ("\\defeq"               32 (Br . Bl) 32 (Br . Br) 57612)
          ("\\eq"                  ?=)
          ("\\neq"                 32 (Br . Bl) 32 (Br . Br) 57614)
          ("\\blank"               8212)
          ("\\from"                32 (Br . Br) 57708)
          ("\\colon"               32 (Br . Br) 57708)
          ("\\lact"                9655)
          ("\\blact"               9654)
          ("\\ract"                9665)
          ("\\bract"               9664)
          ("\\unlhd"               ?⊴)
          ("\\unrhd"               ?⊵)
          ("\\cdot "               8226)
          (" \\cdot "              8226)
          ("\\times "              215)
          (" \\times "             215)
          ("\\parallel"            ?∥)
          ("\\notni"               8260 (cc . cc) ?∋)
          ("\\sqcup"               ?⊔)
          ("\\bigsqcup"            ?⊔)
          ("\\sqcap"               ?⊓)
          ("\\bigsqcap"            ?⊓)
          ("\\biguplus"            ?⨄)
          ("\\land"                ?∧)
          ("\\lor"                 ?∨)
          ("\\odot"                ?⊙)
          ("\\bigodot"             ?⊙)
          ("\\otimes"              ?⊗)
          ("\\bigotimes"           ?⊗)
          ("\\oplus"               ?⊕)
          ("\\bigoplus"            ?⊕)
          ("\\sqrt"                ?√)
          ("\\iint"                ?∬)
          ("\\iiint"               ?∭)
          ("\\iiiint"              ?⨌)
          ("\\oiint"               ?∯)
          ("\\oiiint"              ?∰)
          ("\\ointclockwise"       ?∲)
          ("\\ointctrclockwise"    ?∳)
          ;; BETTER SUB AND SUPERSCRIPTS
          ("^0"                    8304)
          ("^1"                    185)
          ("^2"                    178)
          ("^3"                    179)
          ("^4"                    8308)
          ("^5"                    8309)
          ("^6"                    8310)
          ("^7"                    8311)
          ("^8"                    8312)
          ("^9"                    8313)
          ("^l"                    ?\u02E1)
          ("^r"                    ?\u02B3)
          ("^T"                    ?\u1d40)
          ("_0"                    8320)
          ("_1"                    8321)
          ("_2"                    8322)
          ("_3"                    8323)
          ("_4"                    8324)
          ("_5"                    8325)
          ("_6"                    8326)
          ("_7"                    8327)
          ("_8"                    8328)
          ("_9"                    8329)
          ;; GREEK UPPER CASES
          ("\\Alpha"               ?Α)
          ("\\Beta"                ?Β)
          ("\\Gamma"               ?Γ)
          ("\\Delta"               ?Δ)
          ("\\Epsilon"             ?Ε)
          ("\\Zeta"                ?Ζ)
          ("\\Eta"                 ?Η)
          ("\\Theta"               ?Θ)
          ("\\Iota"                ?Ι)
          ("\\Kappa"               ?Κ)
          ("\\Lambda"              ?Λ)
          ("\\Mu"                  ?Μ)
          ("\\Nu"                  ?Ν)
          ("\\Xi"                  ?Ξ)
          ("\\Omicron"             ?Ο)
          ("\\Pi"                  ?Π)
          ("\\Rho"                 ?Ρ)
          ("\\Sigma"               ?Σ)
          ("\\Tau"                 ?Τ)
          ("\\Upsilon"             ?Υ)
          ("\\Phi"                 ?Φ)
          ("\\Chi"                 ?Χ)
          ("\\Psi"                 ?Ψ)
          ("\\Omega"               ?Ω)
          ;; SPECIAL SYMBOLS
          ("\\ss"                  ?ß)
          ("\\aa"                  ?å)
          ("\\AA"                  ?Å)
          ("\\ae"                  ?æ)
          ("\\oe"                  ?œ)
          ("\\AE"                  ?Æ)
          ("\\OE"                  ?Œ)
          ("\\o"                   ?ø)
          ("\\O"                   ?Ø)
          ("\\l"                   ?ł)
          ("\\L"                   ?Ł)
          ("\\S"                   ?§)
          ;; ESCAPED SYMBOLS
          ("\\$"                   ?＄)
          ("\\%"                   ?％)
          ("\\#"                   ?＃)
          ("\\_"                   ?＿)
          ("\\&"                   ?& (Bc . Bc) ?|)
          ;;REFERECING
          ("\\ref"                 ?☞)
          ("\\eqref"               ?☞)
          ("\\cite"                ?†)
          ("\\footnote"            ?‡)
          ("\\label"               43 (cc . cc) ?‡)
          ("\\TeX"                 ?T (cr cl -20 -45) ?E (cr cl -20 24) ?X)
          ("\\LaTeX"               ?L (cr cl -60 35) ?A (cr cl -18 -20) ?T (cr cl -18 -60) ?E (cr cl -20 5) ?X)
          ;; PARENTHESES
          ("{"                     ?⎨)
          ("}"                     ?⎬)
          ("\\{"                   ?{)
          ("\\}"                   ?})
          ("\\lbrace"              ?{)
          ("\\rbrace"              ?})
          ("\\{"                   ?{)
          ("\\}"                   ?})
          ("\\|"                   ?║)
          ;; Misc
          ("\\dots"                ?…)
          ("\\blank"       . ?—)
          ("\\eqdef"       . ?≝)
          ("\\defeq"       . (?: (cr cl -20 -8) ?=))
          ("\\textbackslash"       ?＼)
          ("\\backslash"           ?＼)
          ("\\qed"                 ?□)
          ("\\lightning"           ?Ϟ)
          ("\\copyright"           ?©)
          ("\\texistregistered"    ?®)
          ("\\texttrademark"       ?™)
          ("\\euro"                8364)
          ("\\pounds"              ?£)
          ("\\lvert"               ?|)
          ("\\rvert"               ?|)
          ("\\lVert"               ?ǁ)
          ("\\rVert"               ?ǁ)
          )))

(use-package fira-code-mode
  :custom (fira-code-mode-disabled-ligatures '("[]" "#{" "#(" "#_" "#_(" "x" "{-" "-}" )) ;; List of ligatures to turn off
  :hook
  (LaTeX-mode . my-LaTeX-fira-pitch)
  (LaTeX-mode . fira-code-mode)
  :config
  (latex-symbols-prettify)
  )

(use-package emacs
  :custom (prettify-symbols-unprettify-at-point 'right-edge)
  )

#+end_src

** Benchmark

#+begin_src emacs-lisp  :prologue "" :epilogue ""

(my-report-time "LaTeX")

#+end_src




** TODO Python :DEFER:MODE:

This is only a rough setup to be able to write python code in emacs.

#+begin_src emacs-lisp

(use-package elpy
  :defer t
  :init
  (advice-add 'python-mode :before 'elpy-enable))

#+end_src

#+RESULTS:

** TODO Bibliography
** Titlecase

#+begin_src emacs-lisp
(use-package titlecase
  :straight (titlecase
             :host codeberg
             :repo "acdw/titlecase.el")
  :after embark
  :bind (:map embark-region-map
              ("T" . titlecase-dwim)))

#+end_src
** Biblio

We will use biblio for handling/downloading papers.

#+begin_src emacs-lisp
(use-package biblio
  :config
  (setq biblio-bibtex-use-autokey t)
  (setopt biblio-cleanup-bibtex-function #'bibtex-clean-entry)
  )
#+end_src

#+begin_src emacs-lisp
(use-package biblio-zbmath
  :straight (biblio-zbmath :local-repo "biblio-zbmath")
  :load-path "~/.emacs.d/straight/repos/biblio-zbmath"
  )
#+end_src
** Zotra


#+begin_src emacs-lisp
(defun zotra-download-attachment-for-current-entry ()
  (interactive)
  (save-excursion
    (bibtex-beginning-of-entry)
    (let* ((entry (bibtex-parse-entry t))
           (key (cdr (assoc "=key=" entry)))
           (url (cdr (assoc "url" entry)))
           (filename (concat (regularlise-file-name key) ".pdf"))
           (filename (when entry
                       (zotra-download-attachment
                        url nil filename))))
      (when filename
        (bibtex-make-field (list "File" nil filename) t)))))


(defun finalise-entry ()
  (interactive)
  (progn
    (save-excursion
      (bibtex-beginning-of-entry)
      (let* ((entry (bibtex-parse-entry t))
             (year (cdr (assoc "year" entry)))
             (date (cdr (assoc "date" entry)))
             (journaltitle (cdr (assoc "journaltitle" entry)))
             (journal (cdr (assoc "journal" entry))))
        (unless year
          (bibtex-make-field (list "year" nil (number-to-string
                                               (nth 5 (parse-time-string date))))))
        (unless journal
          (bibtex-make-field (list "journal" nil journaltitle))))
      (bibtex-clean-entry t nil)
      )))




(use-package zotra
  :straight (zotra
             :host github
             :repo "mpedramfar/zotra")
  :demand t
  :config
  (setq zotra-use-curl nil)
  (setq zotra-url-retrieve-timeout 10)
  (setq zotra-default-bibliography org-cite-global-bibliography)
  (setq zotra-default-entry-format "biblatex")
  (setq zotra-download-attachment-default-directory "~/Documents/mathematics/literature/pdfs/")
  (setq zotra-backend 'zotra-server)
  (setq zotra-local-server-directory "~/.emacs.d/zotra-server/")
  (setq zotra-after-get-bibtex-entry-hook '(finalise-entry
                                            ;; zotra-download-attachment-for-current-entry
                                            bibtex-fill-entry))
  )

#+end_src
** Ebib

#+begin_src emacs-lisp
(defun regularlise-file-name (name)
  (string-inflection-underscore-function
   (replace-regexp-in-string "\\(:\\| \\|-\\)" "_" name))
  )

(defun string-inflection-underscore-function (str)
  "FooBar => foo_bar"
  (let ((case-fold-search nil))
    (setq str (replace-regexp-in-string "\\([a-z0-9]\\)\\([A-Z]\\)" "\\1_\\2" str))
    (setq str (replace-regexp-in-string "\\([A-Z]+\\)\\([A-Z][a-z]\\)" "\\1_\\2" str))
    (setq str (replace-regexp-in-string "-" "_" str)) ; FOO-BAR => FOO_BAR
    (setq str (replace-regexp-in-string "_+" "_" str))
    (downcase str)))

(use-package ebib
  :straight (ebib
             :host github
             :repo "joostkremers/ebib")
  :demand t
  :bind
  (:map LaTeX-mode-map ("C-c e" . #'ebib))
  :config
  (setq ebib-preload-bib-files
        '("~/Documents/mathematics/literature/literature.bib"))
  (setq ebib-file-search-dirs
        '("~/Documents/mathematics/literature/pdfs/"))
  (setq ebib-file-associations '(("pdf" . "evince") ("ps" . "okular")))
  (setq bibtex-autokey-names 3)
  (setq bibtex-autokey-name-separator '"-")
  (setq bibtex-autokey-additional-names '"-et-al")
  (setq bibtex-autokey-year-length 4)
  (setq bibtex-autokey-titleword-case-convert-function 'capitalize)
  (setq bibtex-autokey-titleword-separator '"")
  (setq bibtex-autokey-titleword-length 'infty)
  (setq bibtex-autokey-titlewords 2)
  (setq bibtex-autokey-name-year-separator '"")
  (setq bibtex-autokey-year-title-separator ":")
  (setq bibtex-autokey-edit-before-use t)
  (setq ebib-name-transform-function 'regularlise-file-name)
  )

#+end_src

** Citar

#+begin_src emacs-lisp
(use-package citar
  :custom
  (org-cite-global-bibliography '("~/Documents/mathematics/literature/literature.bib"))
  (citar-library-paths '("~/Documents/mathematics/literature/pdfs/"))
  (org-cite-insert-processor 'citar)
  (org-cite-follow-processor 'citar)
  (org-cite-activate-processor 'citar)
  (citar-bibliography org-cite-global-bibliography)
  (citar-indicators
   (list citar-indicator-files-icons
         citar-indicator-links-icons
         citar-indicator-notes-icons
         citar-indicator-cited-icons))
  (citar-file-open-functions '(("html" . citar-file-open-external) ("pdf" . citar-file-open-external) (t . find-file)))
  (citar-templates
   '((main . "${author editor:20%sn}  ${date year issued:4}  ${title:40}")
     (suffix . " ${=key= id:10}  ${tags keywords:*}")
     (preview . "${author editor:%etal} (${year issued date}) ${title}, ${journal journaltitle publisher container-title collection-title}.\n")
     (note . "Notes on ${author editor:%etal}, ${title}")))
  :hook
  (LaTeX-mode . citar-capf-setup)
  (org-mode . citar-capf-setup)
  :bind
  (:map org-mode-map :package org ("C-c b" . #'org-cite-insert))
  (:map LaTeX-mode-map ("C-c b" . #'citar-insert-citation))
  )

(use-package citar-embark
  :after citar embark
  :no-require
  :config (citar-embark-mode))
#+end_src

** Bibtex :INACTIVE:

Settings for bibtex

#+begin_src emacs-lisp
(setq bibtex-autokey-titleword-length 0
      bibtex-autokey-name-year-separator ":"
      bibtex-autokey-name-case-convert-function 'capitalize
      bibtex-autokey-year-length 4
      bibtex-autokey-names 1
      bibtex-autokey-titleword-separator ""
      bibtex-autokey-year-title-separator ""
      bibtex-autokey-edit-before-use nil
      imenu-list-position 'left
      imenu-list-size 100
      org-imenu-depth 2
      org-image-actual-width `( ,(truncate (* (frame-pixel-width) 0.85)))
      org-startup-with-inline-images t)
#+end_src

** Org bib mode :HOOK:

Dedicated header line for org-bib-mode

#+begin_src emacs-lisp

(defun my-org-bib-mode-hook ()

  (with-current-buffer "*Ilist*"
    (setq header-line-format
          '(:eval
            (nano-modeline-render nil
                                  (buffer-name imenu-list--displayed-buffer)
                                  (format "(view mode: %s, filter: %s)"
                                          (if (eq org-bib--view-mode-current 'none)
                                              "-"
                                            org-bib--view-mode-current)
                                          (if (eq org-imenu-filter-string "*")
                                              "-"
                                            org-imenu-filter-string))
                                  "")))
    (face-remap-add-relative 'hl-line :inherit 'nano-strong-i)))

(add-hook 'org-bib-mode-hook #'my-org-bib-mode-hook)

#+end_src

A shortcut to edit bibliography

#+begin_src emacs-lisp :prologue "" :epilogue ""
(defun my-biblio ()
  "Create a new frame for editing bibliography"

  (interactive)
  (require 'org-bib)
  (setq imenu-list-position 'left
        imenu-list-size 100
        org-imenu-depth 2)

  (select-frame (make-frame '((name . "my-biblio")
                              (width . 180)
                              (height . 45))))
  (find-file "~/Documents/mathematics/research/literature.org")
  (org-bib-mode))

#+end_src

An autoload function for my-config (that will load org mode).

#+begin_src emacs-lisp :prologue "" :epilogue ""

(autoload 'my-biblio
  (expand-file-name "init.el" user-emacs-directory)
  "Autoloaded my-config command."
  t)

#+end_src



* Version control

We use [[https://magit.vc/][magit]] in combination with git for version control.

#+begin_quote
Magit is a complete text-based user interface to Git. It fills the glaring gap between the Git command-line interface and various GUIs, letting you perform trivial as well as elaborate version control tasks with just a couple of mnemonic key presses. Magit looks like a prettified version of what you get after running a few Git commands but in Magit every bit of visible information is also actionable to an extent that goes far beyond what any Git GUI provides and it takes care of automatically refreshing this output when it becomes outdated. In the background Magit just runs Git commands and if you wish you can see what exactly is being run, making it possible for you to learn the git command-line.
#+end_quote
** Magit

#+NAME: magit-add-remove-face-font-lock
#+begin_src emacs-lisp :tangle no
(defun my-magit-add-remove-face-font-lock ()
  "We use  font-locking to replace  `+' or `-' characters at the start of a line with red or green lines."
  (add-to-list 'font-lock-extra-managed-props 'display)
  (font-lock-add-keywords 'nil
                          '(("\\(^-\\)" 1 '(face nil display
                                                 #("│" 0 1 (face (:inherit lambda-red)))))))
  (font-lock-add-keywords 'nil
                          '(("\\(^ \\)" 1 '(face nil display
                                                 #("│" 0 1 (face (:inherit lambda-meek)))))))
  (font-lock-add-keywords nil
                          '(("\\(^+\\)" 1 '(face nil display
                                                 #("│" 0 1 (face (:inherit lambda-green)))))))
  )

#+end_src

#+begin_src emacs-lisp :noweb yes
(use-package magit
  :elpaca (:type git
                 :host github
                 :repo "magit/magit")
  :config
  (setq magit-display-buffer-function 'magit-display-buffer-fullframe-status-v1)
  (setq magit-diff-refine-hunk 'all)
  <<magit-add-remove-face-font-lock>>
  :hook (magit-mode . my-magit-add-remove-face-font-lock)
  :custom-face
  (magit-section-heading ((t (:height 1.0 :weight  unspecified :foreground unspecified :inherit lambda-strong))))
  (magit-header-line ((t (:foreground unspecified :background unspecified))))
  (magit-diff-removed  ((t (:foreground unspecified
                                        :background unspecified
                                        :inherit lambda-meek))))
  (magit-diff-removed-highlight ((t (:foreground unspecified
                                                 :background unspecified
                                                 :inherit lambda-red))))
  (magit-diff-added    ((t (:foreground unspecified
                                        :background unspecified
                                        :inherit lambda-meek))))
  (magit-diff-added-highlight   ((t (:foreground unspecified
                                                 :background unspecified
                                                 :inherit (lambda-green)))))
  )
#+end_src
** Abridge
In order to handles long lines in diffs, which happens in LaTeX-documents quite freqently, we use visual clues about actual changes.

#+begin_quote
A simple Emacs package for abridging refined diff hunks (for example in magit). Why abridge a diff hunk? Most diffs are line based. If you are working on files with very long lines, for example LaTeX files, or text files with full paragraphs per line (often using visual-line-mode), line-based diffs can be very challenging to read, even with "hunk refining" enabled (highlighting the words which changed).
#+end_quote

#+begin_src emacs-lisp
(use-package abridge-diff
  :after magit ;; optional, if you'd like to use with magit
  :init (abridge-diff-mode 1)
  :custom-face
  (diff-refine-added   ((t (:foreground unspecified
                                        :weight bold
                                        :inherit lambda-green))))
  (diff-refine-removed ((t (:foreground "#bf616a" :weight bold :strike-through nil :inherit lambda-red))))
  (diff-refine-changed ((t (:foreground unspecified
                                        :weight bold
                                        :inherit lambda-yellow))))
  )
#+end_src
** hl-todo
We use the hl-todo package for an emacs-wide integration of todo-like keywords.

#+begin_quote
Highlight TODO and similar keywords in comments and strings
#+end_quote


First we define a consisted set of faces for todo keywords. This is incorporated into the emacs default settings.

#+NAME: todo-faces
#+begin_src emacs-lisp :tangle no
(defface todo-face '((t (:foreground "#fdf096"
                                     :background "#494f67"
                                     :weight semibold :inverse-video t)))
  "A consistent emacs-wide TODO face") ;;straw-yellow and blackish-grey
(defface next-face '((t (:foreground "#d65848"
                                     :background "#494f67"
                                     :weight semibold
                                     :inverse-video t)))
  "A consistent emacs-wide NEXT face") ;;aurora-red and blackish-grey
(defface done-face '((t (:foreground "#97b578"
                                     :background "#494f67"
                                     :weight semibold
                                     :inverse-video t)))
  "A consistent emacs-wide DONE face") ;;emerald-green and blackish-grey
(defface wait-face '((t (:foreground "#fdf096"
                                       :background "#494f67"
                                       :weight semibold
                                       :inverse-video t)))
  "A consistent emacs-wide WAIT face") ;;straw-yellow and blackish-grey
(defface canceled-face '((t (:foreground "#edf0f2"
                                         :background "#494f67"
                                         :weight semibold
                                         :inverse-video t)))
  "A consistent emacs-wide CANCELED face") ;;skimmed-milk-white and blackish-grey
#+end_src

#+begin_src emacs-lisp
(use-package hl-todo
  :elpaca (:type git :host github :repo "tarsius/hl-todo")
  :config
  (setq hl-todo-exclude-modes nil)
  (setq hl-todo-keyword-faces
      '(("TODO"     . todo-face)
        ("NEXT"     . next-face)
        ("DONE"     . done-face)
        ("WAIT"     . wait-face)
        ("CANCELED" . canceled-face)))
  (global-hl-todo-mode 1)
  )
#+end_src
* Other visuals
** TODO Nerd icons

[[https://github.com/rainstormstudio/nerd-icons.el][Nerd icons]] allows us to use nerd fonts for icons.

#+begin_quote
Nerd-icons.el is a library for easily using Nerd Font icons inside Emacs, an alternative to all-the-icons.

It works on both GUI and terminal! You only need a Nerd Font installed on your system.

It is inspired by all-the-icons, icons-in-terminal, vim-devicons, and nvim-web-devicons.
#+end_quote

#+begin_src emacs-lisp
(use-package nerd-icons
  :custom
  (nerd-icons-font-family "Roboto Mono Nerd Font")
  )
#+end_src

There is an integration into the completion framework, called [[https://github.com/rainstormstudio/nerd-icons-completion][nerd icons completion]].

#+begin_src emacs-lisp
(use-package nerd-icons-completion
  :elpaca (:type git :host github :repo "rainstormstudio/nerd-icons-completion")
  :after marginalia
  :hook (marginalia-mode . nerd-icons-completion-marginalia-setup)
  :config
  (nerd-icons-completion-mode))
#+end_src
** Visual fill column and visual line mode

We activate [[help:visual-line-mode][visual-line-mode]] globally.
Additionally, we use the package "[[https://codeberg.org/joostkremers/visual-fill-column][visual fill column]]" to vastly increase readability in /org/ and /LaTeX/ buffers.

#+begin_quote
visual-fill-column-mode is a small Emacs minor mode that mimics the effect of fill-column in visual-line-mode. Instead of wrapping lines at the window edge, which is the standard behaviour of visual-line-mode, it wraps lines at fill-column (or visual-fill-column-width, if set). That is, it turns the view on the left into the view on the right, without changing the contents of the file.
#+end_quote

#+begin_src emacs-lisp
(use-package adaptive-wrap
  :elpaca ( :repo "git://git.sv.gnu.org/emacs/elpa" :local-repo "adaptive-wrap" :branch "externals/adaptive-wrap" :files ("*" (:exclude ".git")))
  :hook  ((latex-mode LaTeX-mode) . adaptive-wrap-prefix-mode))
#+end_src

#+begin_src emacs-lisp
(use-package visual-fill-column
  :after adaptive-wrap
  :init (global-visual-line-mode)
  :custom (visual-fill-column-center-text t)
  (visual-fill-column-enable-sensible-window-split t)
  :hook  ((( latex-mode LaTeX-mode org-mode) . visual-fill-column-mode)
          ((latex-mode LaTeX-mode) . adaptive-wrap-prefix-mode)
          )
  )
#+end_src
Changing the symbol for truncation (…) and wrap (↩).



* OLD :INACTIVE:noexport:

** Stuff maybe not needed?
*** String related

A set of functions to join two strings such as to fit a given width. This will be used for displaying elfeed posts, privileging the right part (tag and feed).

#+name: my-string-pad-right
#+begin_src emacs-lisp

(defun my-string-pad-right (len s)
  "If S is shorter than LEN, pad it on the right,
   if S is longer than LEN, truncate it on the right."

  (if (> (length s) len)
      (concat (substring s 0 (- len 1)) "…")
    (concat s (make-string (max 0 (- len (length s))) ?\ ))))

#+end_src

#+name: my-string-pad-left
#+begin_src emacs-lisp

(defun my-string-pad-left (len s)
  "If S is shorter than LEN, pad it on the left,
   if S is longer than LEN, truncate it on the left."

  (if (> (length s) len)
      (concat  "…" (substring s (- (length s) len -1)))
    (concat (make-string (max 0 (- len (length s))) ?\ ) s)))

#+end_src

#+name: my-string-join
#+begin_src emacs-lisp

(defun my-string-join (len left right &optional spacing)
  "Join LEFT and RIGHT strings to fit LEN characters with at least SPACING characters
between them. If len is negative, it is retrieved from current window width."

  (let* ((spacing (or spacing 3))
         (len (or len (window-body-width)))
         (len (if (< len 0)
                  (+ (window-body-width) len)
                len)))
    (cond ((> (length right) len)
           (my-string-pad-left len right))

          ((> (length right) (- len spacing))
           (my-string-pad-left len (concat (make-string spacing ?\ )
                                           right)))

          ((> (length left) (- len spacing (length right)))
           (concat (my-string-pad-right (- len spacing (length right)) left)
                   (concat (make-string spacing ?\ )
                           right)))
          (t
           (concat left
                   (make-string (- len (length right) (length left)) ?\ )
                   right)))))

#+end_src

Unwords seems to be undefined we remodel it here


#+begin_src emacs-lisp

(defun unwords (&rest words)        ;; unwords seems to be missing this function takes care of it.
  (mapconcat #'identity words " ")) ;; it joins a list of strings with a blank space as seperator.

#+end_src

*** Date related

A set of date related functions, mostly used for mail display.

#+name: my-date-day
#+begin_src emacs-lisp

(defun my-date-day (date)
  "Return DATE day of month (1-31)."

  (nth 3 (decode-time date)))

#+end_src

#+name: my-date-month
#+begin_src emacs-lisp

(defun my-date-month (date)
  "Return DATE month number (1-12)."

  (nth 4 (decode-time date)))

#+end_src

#+name: my-date-year
#+begin_src emacs-lisp

(defun my-date-year (date)
  "Return DATE year."

  (nth 5 (decode-time date)))

#+end_src

#+name: my-date-equal
#+begin_src emacs-lisp

(defun my-date-equal (date1 date2)
  "Check if DATE1 is equal to DATE2."

  (and (eq (my-date-day date1)
           (my-date-day date2))
       (eq (my-date-month date1)
           (my-date-month date2))
       (eq (my-date-year date1)
           (my-date-year date2))))

#+end_src

#+name: my-date-inc
#+begin_src emacs-lisp

(defun my-date-inc (date &optional days months years)
  "Return DATE + DAYS day & MONTH months & YEARS years"

  (let ((days (or days 0))
        (months (or months 0))
        (years (or years 0))
        (day (my-date-day date))
        (month (my-date-month date))
        (year (my-date-year date)))
    (encode-time 0 0 0 (+ day days) (+ month months) (+ year years))))

#+end_src

#+name: my-date-dec
#+begin_src emacs-lisp

(defun my-date-dec (date &optional days months years)
  "Return DATE - DAYS day & MONTH months & YEARS years"

  (let ((days (or days 0))
        (months (or months 0))
        (years (or years 0)))
    (my-date-inc date (- days) (- months) (- years))))

#+end_src

#+name: my-date-today
#+begin_src emacs-lisp

(defun my-date-today ()
  "Return today date."

  (current-time))

#+end_src

#+name: my-date-is-today
#+begin_src emacs-lisp

(defun my-date-is-today (date)
  "Check if DATE is today."

  (my-date-equal (current-time) date))

#+end_src

#+name: my-date-is-yesterday
#+begin_src emacs-lisp

(defun my-date-is-yesterday (date)
  "Check if DATE is yesterday."

  (my-date-equal (my-date-dec (my-date-today) 1) date))

#+end_src

#+name: my-date-relative
#+begin_src emacs-lisp

(defun my-date-relative (date)
  "Return a string with a relative date format."

  (let* ((now (current-time))
         (delta (float-time (time-subtract now date)))
         (days (ceiling (/ (float-time (time-subtract now date)) (* 60 60 24)))))
    (cond ((< delta (*       3 60))     "now")
          ((< delta (*      60 60))     (format "%d minutes ago" (/ delta   60)))
          ;;  ((< delta (*    6 60 60))     (format "%d hours ago"   (/ delta 3600)))
          ((my-date-is-today date)      (format-time-string "%H:%M" date))
          ((my-date-is-yesterday date)  (format "Yesterday"))
          ((< delta (* 4 24 60 60))     (format "%d days ago" (+ days 1)))
          (t                            (format-time-string "%d %b %Y" date)))))

#+end_src

*** Mini frame

A set of functions to create a mini-frame over the header line.

#+begin_src emacs-lisp

(defun my-mini-frame (&optional height foreground background border)
  "Create a child frame positioned over the header line whose
width corresponds to the width of the current selected window.

The HEIGHT in lines can be specified, as well as the BACKGROUND
color of the frame. BORDER width (pixels) and color (FOREGROUND)
can be also specified."

  (interactive)
  (let* ((foreground (or foreground
                         (face-foreground 'font-lock-comment-face nil t)))
         (background (or background (face-background 'highlight nil t)))
         (border (or border 1))
         (height (round (* (or height 8) (window-font-height))))
         (edges (window-pixel-edges))
         (body-edges (window-body-pixel-edges))
         (top (nth 1 edges))
         (bottom (nth 3 body-edges))
         (left (- (nth 0 edges) (or left-fringe-width 0)))
         (right (+ (nth 2 edges) (or right-fringe-width 0)))
         (width (- right left))

         ;; Window divider mode
         (width (- width (if (and (bound-and-true-p window-divider-mode)
                                  (or (eq window-divider-default-places 'right-only)
                                      (eq window-divider-default-places t))
                                  (window-in-direction 'right (selected-window)))
                             window-divider-default-right-width
                           0)))
         (y (- top border))
         (child-frame-border (face-attribute 'child-frame-border :background)))
    (set-face-attribute 'child-frame-border t :background foreground)
    (let ((frame (make-frame
                  `((parent-frame . ,(window-frame))
                    (delete-before . ,(window-frame))
                    (minibuffer . nil)
                    (modeline . nil)
                    (left . ,(- left border))
                    (top . ,y)
                    (width . (text-pixels . ,width))
                    (height . (text-pixels . ,height))
                    ;; (height . ,height)
                    (child-frame-border-width . ,border)
                    (internal-border-width . ,border)
                    (background-color . ,background)
                    (horizontal-scroll-bars . nil)
                    (menu-bar-lines . 0)
                    (tool-bar-lines . 0)
                    (desktop-dont-save . t)
                    (unsplittable . nil)
                    (no-other-frame . t)
                    (undecorated . t)
                    (pixelwise . t)
                    (visibility . t)))))
      (set-face-attribute 'child-frame-border t :background child-frame-border)
      frame)))

#+end_src

#+begin_src emacs-lisp

(defun my-mini-frame-reset (frame)
  "Reset FRAME size and position.

  Move frame at the top of parent frame and resize it
  horizontally to fit the width of current selected window."

  (interactive)
  (let* ((border (frame-parameter frame 'internal-border-width))
         (height (frame-parameter frame 'height)))
    (with-selected-frame (frame-parent frame)
      (let* ((edges (window-pixel-edges))
             (body-edges (window-body-pixel-edges))
             (top (nth 1 edges))
             (bottom (nth 3 body-edges))
             (left (- (nth 0 edges) (or left-fringe-width 0)))
             (right (+ (nth 2 edges) (or right-fringe-width 0)))
             (width (- right left))
             (y (- top border)))
        (set-frame-width frame width nil t)
        (set-frame-height frame height)
        (set-frame-position frame (- left border) y)))))

#+end_src

#+begin_src emacs-lisp

(defun my-mini-frame-shrink (frame &optional delta)
  "Make the FRAME DELTA lines smaller.

  If no argument is given, make the frame one line smaller. If
  DELTA is negative, enlarge frame by -DELTA lines."

  (interactive)
  (let ((delta (or delta -1)))
    (when (and (framep frame)
               (frame-live-p frame)
               (frame-visible-p frame))
      (set-frame-parameter frame 'height
                           (+ (frame-parameter frame 'height) delta)))))

#+end_src

*** Mu4e related

A set of mail (mu4e) related functions.


** TODO Configuration :BINDING:HOOK:DEFER:
# :PROPERTIES:
# :header-args:emacs-lisp: :prologue "(with-eval-after-load 'org" :epilogue ")"
# :END:

*** General

This section is meant to ease the writing of the configuration file using a dedicated minor mode (~my-config-mode~) with a few key bindings:

=C-`=       : Toggle navigation sidebar
=C-c C-p=   : Go to previous subsection
=C-c C-n=   : Go to next subsection
=C-c C-S-p= : Go to previous section
=C-c C-S-n= : Go to next section
=C-c t=     : Fold code blocks
=C-c f=     : Filter block visibility (sidebar)
=C-c C-v t= : Export (tangle) code
=C-c C-v s= : Execute current subsection

Before being able to use it, you need to execute the whole subtree using [[help:org-babel-execute-subtree][org-babel-execute-subtree]] (generally bound to =C-c C-v s=).

*** Sidebar :INACTIVE:BINDING:

This defines an org sidebar using imenu-list.

#+name: my-org-sidebar
#+begin_src emacs-lisp

(require 'imenu)
(require 'imenu-list)

(defun my-org-tree-to-indirect-buffer ()
  "Create indirect buffer, narrow it to current subtree and unfold blocks"

  (org-tree-to-indirect-buffer)
  (org-show-block-all)
  (setq-local my-org-blocks-hidden nil))

(defun my-org-sidebar ()
  "Open an imenu list on the left that allow navigation."

  (interactive)
  (setq imenu-list-after-jump-hook #'my-org-tree-to-indirect-buffer
        imenu-list-position 'left
        imenu-list-size 36
        imenu-list-focus-after-activation t)

  (let ((heading (substring-no-properties (or (org-get-heading t t t t) ""))))
    (when (buffer-base-buffer)
      (switch-to-buffer (buffer-base-buffer)))
    (imenu-list-minor-mode)
    (imenu-list-stop-timer)
    (hl-line-mode)
    (face-remap-add-relative 'hl-line :inherit 'nano-subtle)
    (setq header-line-format
          '(:eval
            (nano-modeline-render nil
                                  (buffer-name imenu-list--displayed-buffer)
                                  "(outline)"
                                  "")))
    (setq-local cursor-type nil)
    (when (> (length heading) 0)
      (goto-char (point-min))
      (search-forward heading)
      (imenu-list-display-dwim))))

#+end_src

#+RESULTS: my-org-sidebar
: my-org-sidebar

This toggles the org-sidebar.

#+name: org-sidebar-toggle
#+begin_src emacs-lisp

(defun my-org-sidebar-toggle ()
  "Toggle the org-sidebar"

  (interactive)
  (if (get-buffer-window "*Ilist*")
      (progn
        (quit-window nil (get-buffer-window "*Ilist*"))
        (switch-to-buffer (buffer-base-buffer)))
    (my-org-sidebar)))

#+end_src

#+RESULTS: org-sidebar-toggle
: my-org-sidebar-toggle

Make sure tangle is applied to the base buffer and not the subtree.

#+name: my-org-babel-tangle
#+begin_src emacs-lisp

(defun my-org-babel-tangle ()
  "Write code blocks to source-specific files from the base buffer."

  (interactive)
  (with-current-buffer (or (buffer-base-buffer)
                           (current-buffer))
    (org-babel-tangle)))

#+end_src

#+RESULTS: my-org-babel-tangle
: my-org-babel-tangle


Toggle code blocks folding, starting folded.

#+name: my-org-toggle-blocks
#+begin_src emacs-lisp

(defvar my-org-blocks-hidden nil)

(defun my-org-toggle-blocks ()
  "Toggle code blocks folding."

  (interactive)
  (if my-org-blocks-hidden
      (org-show-block-all)
    (org-hide-block-all))
  (setq-local my-org-blocks-hidden (not my-org-blocks-hidden)))

(add-hook 'config-mode-hook #'my-org-toggle-blocks)

#+end_src



#+begin_src emacs-lisp

(defvar my-imenu-list-folding-status t
  "Folding status of the imenu-list")

(defun my-imenu-list-toggle-folding ()
  "Toggle top level nodes of the imenu-list buffer"

  (interactive)
  (with-current-buffer "*Ilist*"
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward "^\\+ " nil t)
        (if my-imenu-list-folding-status
            (hs-hide-block)
          (hs-show-block)))
      (setq my-imenu-list-folding-status (not my-imenu-list-folding-status)))))

(bind-key "S-<tab>" #'my-imenu-list-toggle-folding imenu-list-major-mode-map)

#+end_src

#+RESULTS:
: my-imenu-list-toggle-folding

Some information for when a top node is closed

#+begin_src emacs-lisp

(defun my-display-code-line-counts (ov)
  (when (eq 'code (overlay-get ov 'hs))
    (overlay-put ov 'display
                 (propertize
                  (format " [%d sections] … "
                          (- (count-lines (overlay-start ov)
                                          (overlay-end ov)) 1))
                  'face 'nano-faded))))

(setq hs-set-up-overlay #'my-display-code-line-counts)

#+end_src

#+RESULTS:
: my-display-code-line-counts

#+begin_src emacs-lisp

(defun my-imenu-list-display-dwim ()
  "Display or toggle the entry at `point'."
  (interactive)
  (save-selected-window
    (save-excursion
      (my-imenu-list-ret-dwim))))

(defun my-imenu-list-ret-dwim ()
  "Jump to or toggle the entry at `point'."
  (interactive)
  (save-excursion
    (let ((entry (imenu-list--find-entry)))
      (when (imenu--subalist-p entry)
        (setq entry (cons
                     (car entry)
                     (get-text-property 0 'marker (car entry)))))
      (imenu-list--goto-entry entry))))

(bind-key "<SPC>" #'my-imenu-list-display-dwim imenu-list-major-mode-map)
(bind-key "<return>" #'my-imenu-list-ret-dwim imenu-list-major-mode-map)

#+end_src

#+RESULTS:
: my-imenu-list-ret-dwim


*** Filter :INACTIVE:BINDING:

This provide the ~my-org-imenu-filter~ that allow to filter sidebar entries using the specified expression (e.g. "+HOOK +DEFER").

#+begin_src emacs-lisp

(bind-key "C-c f" #'my-org-imenu-filter)
(bind-key "f" #'my-org-imenu-filter imenu-list-major-mode-map)
(bind-key "U" #'imenu-list-refresh imenu-list-major-mode-map)

#+end_src

#+RESULTS:
: imenu-list-refresh

3 levels for org-imenu

#+begin_src emacs-lisp

(setq org-imenu-depth 3)

#+end_src

#+RESULTS:
: 3


#+begin_src emacs-lisp
(require 'org)
(require 'svg-tag-mode)

(defvar my-org-imenu-filter-history
  '("BINDING" "HOOK" "ADVICE" "FACE" "MODE" "DEFER"
    "PERSONAL" "INACTIVE" "BUGFIX" "OTHER" "TIMER" "OS")
  "Filter history list.")

(with-eval-after-load 'org
  (defvar my-org-imenu-filter-function
    (cdr (org-make-tags-matcher "*"))
    "Filter function to decide if a headline is kept"))

(defun my-org-imenu-filter ()
  "Define and apply a new filter"

  (interactive)
  (let* ((match (completing-read-multiple
                 "FILTER: "
                 my-org-imenu-filter-history
                 nil nil nil
                 'my-org-imenu-filter-history))
         (match (mapconcat #'identity match " ")))
    (when (string= "" match)
      (setq match "*"))
    (setq my-org-imenu-filter-function
          (cdr (org-make-tags-matcher match)))
    (imenu-list-refresh)))


(defun my-org-imenu-filter-tree (&optional bound parent-match)
  "Build a imenu list using current filter function"

  (let* ((headlines '()))
    (save-excursion
      (org-with-wide-buffer
       (unless bound
         (setq bound (point-max))
         (goto-char (point-min)))
       (while (re-search-forward org-heading-regexp bound t)
         (let* ((element (org-element-at-point))
                (begin (org-element-property :begin element))
                (end (org-element-property :end element))
                (marker (copy-marker begin))
                (level (org-element-property :level element))
                (tags (save-excursion
                        (goto-char begin)
                        (org-get-tags)))
                (match (save-excursion
                         (goto-char begin)
                         (funcall my-org-imenu-filter-function
                                  nil (org-get-tags) level)))

                (title (org-element-property :raw-value element))
                (title (org-link-display-format
                        (substring-no-properties title)))
                (title (propertize title 'org-imenu-marker marker
                                   'org-imenu t))
                (title (if (member "INACTIVE" tags)
                           (propertize title 'face 'nano-faded)
                         title))
                (svg-tags (mapconcat #'(lambda (tag)
                                         (propertize tag 'display (svg-tag-make tag :face 'nano-faded)))
                                     tags " "))
                (title (if tags (format "%s %s" title svg-tags) title))
                (title (propertize title 'marker marker))
                (children (my-org-imenu-filter-tree end match)))
           (goto-char end)

           (cond ((> level org-imenu-depth)
                  nil)
                 ((> (length children) 0)
                  (add-to-list 'headlines (append (list title) children) t))
                 ((or match parent-match)
                  (add-to-list 'headlines (cons title marker) t)))))))
    headlines))

(advice-add #'org-imenu-get-tree :override #'my-org-imenu-filter-tree)

#+end_src

#+RESULTS:

*** Configuration mode :INACTIVE:

This section defines the ~my-config-mode~ to ease navigating and interacting with the configuration file.

Navigation commands using the ilist menu.

#+begin_src emacs-lisp

(defun my-config-mode-prev-header ()
  "Move to previous header"

  (interactive)
  (with-current-buffer "*Ilist*"
    (search-backward-regexp "^  ")
    (imenu-list-display-dwim)))

(defun my-config-mode-next-header ()
  "Move to next header"

  (interactive)
  (with-current-buffer "*Ilist*"
    (forward-line)
    (search-forward-regexp "^  ")
    (imenu-list-display-dwim)))

(defun my-config-mode-prev-section ()
  "Move to previous section"

  (interactive)
  (with-current-buffer "*Ilist*"
    (search-backward-regexp "\\+ " nil nil 2)
    (forward-line)
    (imenu-list-display-dwim)))

(defun my-config-mode-next-section ()
  "Move to next section"

  (interactive)
  (with-current-buffer "*Ilist*"
    (previous-line)
    (search-forward-regexp "\\+ ")
    (forward-line)
    (imenu-list-display-dwim)))

#+end_src

#+RESULTS:
: my-config-mode-next-section

A minor mode for configuration

#+name: config-mode
#+begin_src emacs-lisp

(define-minor-mode my-config-mode
  "Configuration mode"

  :init-value nil
  :global nil
  :keymap (let* ((map (make-sparse-keymap)))
            (bind-key "C-c C-p"   #'my-config-mode-prev-header map)
            (bind-key "C-c C-n"   #'my-config-mode-next-header map)
            (bind-key "C-c C-S-p" #'my-config-mode-prev-section map)
            (bind-key "C-c C-S-n" #'my-config-mode-next-section map)
            (bind-key "C-`"       #'my-org-sidebar-toggle map)
            (bind-key "C-c C-v t" #'my-org-babel-tangle map)
            (bind-key "C-c t"     #'my-org-toggle-blocks map)
            map)

  (require 'org)
  (if my-config-mode
      (my-org-sidebar)))


#+end_src



A shortcut to edit configuration

#+begin_src emacs-lisp :prologue "" :epilogue ""
(defun my-config ()
  "Create a new for editing configuration"

  (interactive)
  (select-frame (make-frame '((name . "my-config")
                              (width . 150)
                              (height . 45))))
  (find-file "~/Documents/GitHub/dotemacs/dotemacs.org")
  (my-config-mode))

#+end_src


An autoload function for my-config (that will load org mode).

#+begin_src emacs-lisp :prologue "" :epilogue ""

(autoload 'my-config
  (expand-file-name "init.el" user-emacs-directory)
  "Autoloaded my-config command."
  t)

#+end_src

#+RESULTS:

*** Bugfix :BUGFIX:

*Temporary bugfix* for babel emacs-lisp that does not take into account prologue/epilogue.
See https://list.orgmode.org/CA+G3_PNrdhx0Ejzw8UO7DgZ+ju1B7Ar_eTch5MMViEpKGwqq3w@mail.gmail.com/T/
(November 2020)

#+name: org-babel-expand-body:emacs-lisp
#+begin_src emacs-lisp

(defun my-org-babel-expand-body:emacs-lisp (orig-fun body params)
  "Expand BODY according to PARAMS and call original function with new body"

  (let* ((pro (or (cdr (assq :prologue params)) ""))
         (epi (or (cdr (assq :epilogue params)) ""))
         (body (concat pro body epi)))
    (apply orig-fun `(,body ,params))))

(advice-add 'org-babel-expand-body:emacs-lisp
            :around
            #'my-org-babel-expand-body:emacs-lisp)

#+end_src

#+RESULTS: org-babel-expand-body:emacs-lisp


Some compat tools do not work as expected:

#+begin_src emacs-lisp

(defun compat-executable-find (command &optional remote)
  "Search for COMMAND in `exec-path' and return the absolute file name.
Return nil if COMMAND is not found anywhere in `exec-path'.  If
REMOTE is non-nil, search on the remote host indicated by
`default-directory' instead."
  (if (and remote (file-remote-p default-directory))
      (let ((res (locate-file
                  command
                  (mapcar
                   (lambda (x) (concat (file-remote-p default-directory) x))
                   (exec-path))
                  exec-suffixes 'file-executable-p)))
        (when (stringp res) (file-local-name res)))
    ;; Use 1 rather than file-executable-p to better match the
    ;; behavior of call-process.
    (let ((default-directory (file-name-quote default-directory 'top)))
      (locate-file command exec-path exec-suffixes 1))))

#+end_src

Flyspell causes some problems. We try to fix them here


#+begin_src emacs-lisp

(defun flyspell() (flyspell-mode))

#+end_src

*** Auto-tangle

Automatically tangle org-mode files with the option #+auto_tangle: t

#+begin_src emacs-lisp

;;(add-hook 'org-mode-hook 'org-auto-tangle-mode)

#+end_src

** Benchmark

#+begin_src emacs-lisp

(my-report-time "Personal library")

#+end_src


** Interface

#+begin_src emacs-lisp

(setq my-section-start-time (current-time))

#+end_src

** TODO Frame :BINDING:

A [[help:make-frame][make-frame]] rewrite that creates the frame and switch to the ~*scratch*~ buffer.

#+name: my-new-frame
#+begin_src emacs-lisp

(defun my-make-frame ()
  "Create a new frame and switch to *scratch* buffer."

  (interactive)
  (select-frame (make-frame))
  (switch-to-buffer "*scratch*"))

#+end_src

A function that close the current frame and kill emacs if it was the last frame.

#+name: my-kill-emacs
#+begin_src emacs-lisp

(defun my-kill-emacs ()
  "Delete frame or kill Emacs if there is only one frame."

  (interactive)
  (condition-case nil
      (delete-frame)
    (error (save-buffers-kill-terminal))))

#+end_src

Default frame geometry (large margin: 24 pixels).

#+begin_src emacs-lisp

(require 'frame)

;; Default frame settings
(setq default-frame-alist '((min-height . 1)  '(height . 45)
                            (min-width  . 1)  '(width  . 81)
                            (vertical-scroll-bars . nil)
                            (internal-border-width . 24)
                            (left-fringe . 0)
                            (right-fringe . 0)
                            (tool-bar-lines . 0)
                            (menu-bar-lines . 0)))

;; Default frame settings
(setq initial-frame-alist default-frame-alist)


#+end_src

Frame related binding (self explanatory).

#+begin_src emacs-lisp


(bind-key "M-n"        #'my-make-frame `ergoemacs-override-keymap)
(bind-key "C-x C-c"    #'my-kill-emacs `ergoemacs-override-keymap)
(bind-key "M-`"        #'other-frame `ergoemacs-override-keymap)
;; (bind-key "<M-return>" #'toggle-frame-maximize `ergoemacs-override-keymap)

#+end_src

For frame maximisation, we have to make a specific case for [[help:org-mode][org-mode]].

#+begin_src emacs-lisp

(with-eval-after-load 'org
  (bind-key "<M-return>" #'toggle-frame-maximized 'org-mode-map))

#+end_src

** Window :BINDING:MODE:

#+name: my-delete-window
#+begin_src emacs-lisp
(defvar my-kill-buffer-by-regexp "^\*.+\*" "Buffers whose name matches this regular expression are killed upon closing their window")

(defun my-delete-window()
  (interactive)
  "Close the active window. If the buffer-name matches the my-kill-buffer-by-regexp variable, close the buffer first."
  (let ((currently-active-windows (count-windows)))
    (when (or (eq currently-active-windows 1)
              (string-match my-kill-buffer-by-regexp (buffer-name)))
      (ergoemacs-close-current-buffer))
    (unless (eq currently-active-windows 1) (delete-window))))

(bind-key "C-w" #'my-delete-window `ergoemacs-override-keymap)
(bind-key "M-w" #'ergoemacs-close-current-buffer `ergoemacs-override-keymap)
#+end_src

** Buffer :BINDING:

Size of temporary buffers

#+begin_src emacs-lisp

(temp-buffer-resize-mode)
(setq temp-buffer-max-height 8)

#+end_src

Unique buffer names

#+begin_src emacs-lisp

(require 'uniquify)

(setq uniquify-buffer-name-style 'reverse
      uniquify-separator " • "
      uniquify-after-kill-buffer-p t
      uniquify-ignore-buffers-re "^\\*")

#+end_src

No question after killing a buffer (kill-buffer asks you which buffer to switch to)

#+begin_src emacs-lisp

(bind-key "C-x k" #'kill-current-buffer `ergoemacs-override-keymap)

#+end_src
** TODO Files :BINDING:PERSONAL:

We first set some settings for dired,

#+begin_src emacs-lisp

(use-package dired
  :bind
  (nil
   :map dired-mode-map
   ("c"      . dired-do-copy)
   ("/"      . dired-goto-file)
   ("+"      . dired-create-empty-file)
   ("n"      . dired-create-directory)
   ("p"      . dired-insert-subdir)
   ("d"      . dired-kill-subdir)
   ("f"      . dired-find-file-other-window)
   ("<up>"   . (lambda () (interactive) (dired-next-line -1)))
   ("<down>" . dired-next-line)
   ("<left>" . dired-up-directory)
   ("x"      . dired-do-delete)
   ("X"      . dired-do-flagged-delete))
  :config
  (setq dired-mouse-drag-files t) ; added in Emacs 29
  (setq mouse-drag-and-drop-region-cross-program t) ; added in Emacs 29
  (setq dired-kill-when-opening-new-dired-buffer t) ; added in Emacs 28
  (setq dired-recursive-copies 'always)
  (setq dired-recursive-deletes 'always)
  (setq delete-by-moving-to-trash t)
  (setq dired-dwim-target t)
  (setq dired-listing-switches
        "-g --almost-all --human-readable --time-style=long-iso --group-directories-first --no-group"))

#+end_src

We define some standard directories.

#+begin_src emacs-lisp

(use-package files
  :config
  ;; (setq my-files-dir-alist
  ;;       '(((title . "  Research")     (path . "~/Documents/mathematics/research"))
  ;;         ((title . "  Teaching")     (path . "~/Documents/mathematics/research"))
  ;;         ((title . "  Literature")   (path . "~/Documents/mathematics/literature"))
  ;;         ((title . "  Notes")        (path . "~/Documents/org-files"))
  ;;         ((title . "  Photos")       (path . "~/Documents/Pictures"))
  ;;         ((title . "ﱘ  Music")        (path . "~/Documents/Music"))
  ;;         ((title . "  Downloads")    (path . "~/Downloads"))))
  (setq large-file-warning-threshold (* 16 1024 1024))
  )

#+end_src


Thanks to dirvish, navigating through files is now like dancing.

#+begin_src emacs-lisp

(use-package dirvish
  :hook ((dirvish-setup . dirvish-emerge-mode))
  :bind
  (:map ergoemacs-override-keymap
        ("C-x d" . dirvish)
        ("C-x D" . dirvish-side)
        ("C-x a" . dirvish-quick-access)
        :map dirvish-mode-map
        ("SPC"      . consult-buffer)
        ("C-<up>"   . dirvish-history-go-forward)
        ("C-<down>" . dirvish-history-go-backward)
        ("TAB"      . dirvish-subtree-toggle)
        ("a"        . dirvish-quick-access)
        ("p"        . dirvish-move)
        ("P"        . dirvish-yank-menu)
        ("f"        . dirvish-file-info-menu)
        ("*"        . dirvish-mark-menu)
        ("M-e"      . dirvish-emerge-menu)
        ([remap dired-sort-toggle-or-edit] . dirvish-quicksort)
        ([remap dired-do-redisplay] . dirvish-ls-switches-menu)
        ([remap dired-do-copy] . dirvish-yank-menu))
  :config
  (dirvish-override-dired-mode)
  (dirvish-define-preview exa (file)
                          "Use `exa' to generate directory preview."
                          :require ("exa")
                          (when (file-directory-p file)
                            `(shell . ("exa" "--color=always" "-al" "--group-directories-first" ,file))))
  (add-to-list 'dirvish-preview-dispatchers 'exa)
  ;; (add-to-list 'nano-modeline-mode-formats '(dirvish-mode
  ;;                                            :mode-p my-nano-modeline-dirvish-list-mode-p
  ;;                                            :format my-nano-modeline-dirvish-list-mode
  ;;                                            :icon "") t)
  (setq dirvish-quick-access-entries
        '(("h" "~/"                                " Home")
          ("e" "~/.emacs.d/    "                   " Emacs cache")
          ("r" "~/Documents/mathematics/research"  " Research")
          ("t" "~/Documents/mathematics/teaching"  " Teaching")
          ("d" "~/Documents/organisation"          " Organisation")
          ;; ("o" "fd -e org"   "All org files in ~/Documents") TODO
          ("t" "~/.local/share/Trash/files/" "Trash")))
  (setq dirvish-emerge-groups '(("Research documents"
                                 (extensions "tex" "bib")
                                 nil nil)
                                ("Plaintext documents"
                                 (extensions "pdf" "epub" "org" "txt")
                                 nil nil)
                                ("Recent files"
                                 (predicate . recent-files-today)
                                 nil nil)
                                ("Directories"
                                 (predicate . directories)
                                 nil nil)
                                ("Pictures"
                                 (extensions "jpg" "png" "svg" "gif")
                                 t t)
                                ("Video"
                                 (extensions "mp4" "mkv" "webm")
                                 t t)
                                ("Audio"
                                 (extensions "mp3" "flac" "wav" "ape" "aac")
                                 t t)
                                ("Archives"
                                 (extensions "gz" "rar" "zip")
                                 t t)
                                ("Auxiliary files"
                                 (extensions "aux" "auxlock" "bbl" "blg" "fls" "log" "out" "latexmkrc")
                                 t t)
                                ("other files"
                                 (regex . ".*")
                                 t t)
                                ))
  (setq dirvish-open-with-programs
        `((,dirvish-video-exts . ("tdrop" "-h" "25%" "-w" "25%" "-x" "1000" "-y" "1000" "mpv" "%f"))
          (,dirvish-audio-exts . ("tdrop" "-h" "25%" "-w" "25%" "-x" "1000" "-y" "1000" "mpv" "%f"))))
  (setq dirvish-attributes '(vc-state file-size git-msg subtree-state all-the-icons collapse))
  (setq dirvish-all-the-icons-height 0.8)
  (setq dirvish-side-attributes dirvish-attributes)
  (setq dirvish-side-preview-dispatchers (append '(vc-diff) dirvish-preview-dispatchers))
  (setq dirvish-side-display-alist '((side . left) (slot . -1) (window-width . 0.2)))
  (setq dirvish-side-header-line-format '(:left (project) :right (vc-info)))
  (setq dirvish-side-mode-line-format '(:left (sort omit) :right (index)))
  )

#+end_src

Follow symlinks without prompt

#+begin_src emacs-lisp

(setq vc-follow-symlinks t)

#+end_src

** Dialogues :OS:

Emacs can use a large number of dialogs and popups. Here we get rid of them.

#+begin_src emacs-lisp

(setq-default show-help-function nil    ; No help text
              use-file-dialog nil       ; No file dialog
              use-dialog-box nil        ; No dialog box
              pop-up-windows nil)       ; No popup windows

#+end_src

** Keyboard :MODE:

The mode displays the key bindings following your currently entered incomplete command (a ;; prefix) in a popup.

#+begin_src emacs-lisp

(require 'which-key)

(which-key-mode)

#+end_src

** Cursor :MODE:

We set the appearance of the cursor: vertical line, 3 pixels thick, no blinking

#+begin_src emacs-lisp

(setq-default cursor-in-non-selected-windows nil ; Hide the cursor in inactive windows
              cursor-type '(bar . 3)             ; Vertical cursor
              cursor-intangible-mode t           ; Enforce cursor intangibility
              x-stretch-cursor nil)
                                        ; Don't stretch cursor to the glyph width

(blink-cursor-mode 0)                            ; Blinking cursor

#+end_src

** Text :BINDING:

Pretty self-explanatory

#+begin_src emacs-lisp

(setq-default use-short-answers t ; Replace yes/no prompts with y/n
              confirm-nonexistent-file-or-buffer nil ; Ok to visit non existent files
              words-include-escapes nil) ; Don't treat escape chars as part of words

#+end_src

Replace region when inserting text

#+begin_src emacs-lisp

(delete-selection-mode 1)

#+end_src

A smarter fill/unfill command

#+begin_src emacs-lisp

(defun my-fill-unfill ()
  "Like `fill-paragraph', but unfill if used twice."

  (interactive)
  (let ((fill-column
         (if (eq last-command #'my-fill-unfill)
             (progn (setq this-command nil)
                    (point-max))
           fill-column)))
    (call-interactively #'fill-paragraph)))

(bind-key "M-q"  #'my-fill-unfill)
;; (bind-key [remap fill-paragraph]  #'my-fill-unfill)

#+end_src

** Sound

Disable the bell (auditory or visual).

#+begin_src emacs-lisp

(setq-default visible-bell nil             ; No visual bell
              ring-bell-function 'ignore)  ; No bell

#+end_src

** Mouse :MODE:

Mouse behavior can be finely controlled using the [[help:mouse-avoidance-mode][mouse-avoidance-mode]].

#+begin_src emacs-lisp

(setq-default mouse-yank-at-point t) ; Yank at point rather than pointer
(mouse-avoidance-mode 'exile)        ; Avoid collision of mouse with point

#+end_src

Mouse active in tty mode.

#+begin_src emacs-lisp

(unless (display-graphic-p)
  (xterm-mouse-mode 1)
  (global-set-key (kbd "<mouse-4>") #'scroll-down-line)
  (global-set-key (kbd "<mouse-5>") #'scroll-up-line))

#+end_src

** Scroll

Smoother scrolling.

#+begin_src emacs-lisp

(setq-default scroll-conservatively 101       ; Avoid recentering when scrolling far
              scroll-margin 2                 ; Add a margin when scrolling vertically
              recenter-positions '(5 bottom)) ; Set re-centering positions

#+end_src

** Clipboard :OS:

Allows system and Emacs clipboard to communicate smoothly (both ways)

#+begin_src emacs-lisp

(setq-default select-enable-clipboard t) ; Merge system's and Emacs' clipboard

#+end_src

Make sure clipboard works properly in tty mode on OSX.

#+begin_src emacs-lisp

(defun my-paste-from-osx ()
  (shell-command-to-string "pbpaste"))

(defun my-copy-to-osx (text &optional push)
  (let ((process-connection-type nil))
    (let ((proc (start-process "pbcopy" "*Messages*" "pbcopy")))
      (process-send-string proc text)
      (process-send-eof proc))))

(when (and (not (display-graphic-p))
           (eq system-type 'darwin))
  (setq interprogram-cut-function   #'my-copy-to-osx
        interprogram-paste-function #'my-paste-from-osx))

#+end_src

** Help :BINDING:

[[https://github.com/Wilfred/helpful][Helpful]] is an alternative to the built-in Emacs help that provides much more contextual information.
It is a bit slow to load so we do need load it explicitely.

#+begin_src emacs-lisp

(setq help-window-select t)             ; Focus new help windows when opened

(bind-key "C-h f"   #'helpful-callable) ; Look up callable
(bind-key "C-h v"   #'helpful-variable) ; Look up variable
(bind-key "C-h k"   #'helpful-key)      ; Look up key
(bind-key "C-c C-d" #'helpful-at-point) ; Look up the current symbol at point
(bind-key "C-h F"   #'helpful-function) ; Look up *F*unctions (excludes macros).
(bind-key "C-h C"   #'helpful-command)  ; Look up *C*ommands.

#+end_src

** Benchmark

#+begin_src emacs-lisp

(my-report-time "Interface")

#+end_src


** Visual


#+begin_src emacs-lisp

(setq my-section-start-time (current-time))

#+end_src

** TODO Colours :MODE:TIMER:

A consistent theme for GNU Emacs. The light theme is based on Material colors and the dark theme is based on Nord colors. The theme is based on a set of six faces (only).

#+begin_src emacs-lisp

(require 'nano-theme)
(setq nano-fonts-use t) ; Use theme font stack
;;(nano-mode)             ; Recommended settings


(defun my-set-face (face style)
  "Reset FACE and make it inherit STYLE."
  (set-face-attribute face nil
                      :foreground 'unspecified :background 'unspecified
                      :family     'unspecified :slant      'unspecified
                      :weight     'unspecified :height     'unspecified
                      :underline  'unspecified :overline   'unspecified
                      :box        'unspecified :inherit    style))
(my-set-face 'italic 'nano-faded)

#+end_src

We define a set of colours as defined by Paul Tol in his blog [[https://personal.sron.nl/~pault/][]].

#+begin_src emacs-lisp

(setq bright-blue   '"#4477AA"
      bright-cyan   '"#66CCEE"
      bright-green  '"#228833"
      bright-yellow '"#CCBB44"
      bright-red    '"#EE6677"
      bright-purple '"#AA3377"
      bright-grey   '"#BBBBBB")

(setq high-contrast-white  '"#FFFFFF"
      high-contrast-yellow '"#DDAA33"
      high-contrast-red    '"#BB5566"
      high-contrast-blue   '"#004488"
      high-contrast-black  '"#000000")

(setq vibrant-blue    '"#0077BB"
      vibrant-cyan    '"#33BBEE"
      vibrant-teal    '"#009988"
      vibrant-orange  '"#EE7733"
      vibrant-red     '"#CC3311"
      vibrant-magenta '"#EE3377"
      vibrant-gray    '"#BBBBBB")

(setq muted-indigo '"#332288"
      muted-cyan   '"#88CCEE"
      muted-teal   '"#44AA99"
      muted-green  '"#117733"
      muted-olive  '"#999933"
      muted-sand   '"#DDCC77"
      muted-rose   '"#CC6677"
      muted-wine   '"#882255"
      muted-purple '"#AA4499"
      muted-gray   '"#DDDDDD")

(setq medium-contrast-white        '"#FFFFFF"
      medium-contrast-light-yellow '"#EECC66"
      medium-contrast-light-red    '"#EE99AA"
      medium-contrast-light-blue   '"#6699CC"
      medium-contrast-dark-yellow  '"#997700"
      medium-contrast-dark-red     '"#994455"
      medium-contrast-dark-blue    '"#004488"
      medium-contrast-black        '"#000000")

(setq pale-blue   '"#BBCCEE"
      pale-cyan   '"#CCEEFF"
      pale-green  '"#CCDDAA"
      pale-yellow '"#EEEEBB"
      pale-red    '"#FFCCCC"
      pale-gray   '"#DDDDDD")

(setq dark-blue   '"#222255"
      dark-cyan   '"#225555"
      dark-green  '"#225522"
      dark-yellow '"#666633"
      dark-red    '"#663333"
      dark-gray   '"#555555")

(setq light-black  '"#454545"
      light-blue   '"#77AADD"
      light-cyan   '"#99DDFF"
      light-mint   '"#44BB99"
      light-pear   '"#BBCC33"
      light-olive  '"#AAAA00"
      light-yellow '"#EEDD88"
      light-orange '"#EE8866"
      light-pink   '"#FFAABB"
      light-gray   '"#DDDDDD")

(setq almost-black '"#111A1A"
      almost-white '"#FBFAFC"
      almost-blue  '"#4F5565"
      almost-gray  '"#F1F1F1")

#+end_src

#+begin_src emacs-lisp

(defun my-nano-light-muted ()
  (nano-light)
  (my-thin-modeline)
  (set-face-attribute 'nano-critical   nil :foreground muted-rose)
  (set-face-attribute 'nano-critical-i nil :background muted-rose)
  (set-face-attribute 'nano-popout     nil :foreground vibrant-red)
  (set-face-attribute 'nano-popout-i   nil :background vibrant-red)
  (set-face-attribute 'nano-strong     nil :foreground almost-black)
  (set-face-attribute 'nano-strong-i   nil :background almost-black)
  (set-face-attribute 'nano-salient    nil :foreground medium-contrast-light-blue)
  (set-face-attribute 'nano-salient-i  nil :background bright-blue)
  (set-face-attribute 'nano-faded      nil :foreground dark-gray)
  (set-face-attribute 'nano-faded-i    nil :background dark-gray)
  (set-face-attribute 'nano-subtle     nil :foreground light-black)
  (set-face-attribute 'nano-subtle     nil :background almost-gray)
  (set-face-attribute 'nano-subtle-i   nil :foreground almost-gray)
  (set-face-attribute 'nano-subtle-i   nil :background light-black)
  (set-face-attribute 'nano-modeline-active nil :foreground almost-gray)
  (set-face-attribute 'nano-modeline-active nil :background almost-blue)
  (setopt nano-modeline-faces '((header-active nano-modeline-active)
                                (header-inactive nano-modeline-inactive)
                                (footer-active nano-modeline-active)
                                (footer-inactive nano-modeline-inactive)
                                (status-RW-active nano-modeline-status)
                                (status-RO-active nano-modeline-status)
                                (status-**-active nano-modeline-status nano-popout-i)
                                (name-active bold)
                                (primary-active)
                                (secondary-active nano-modeline-active)))
  )

(defun my-nano-dark-muted ()
  (nano-dark)
  (my-thin-modeline)
  (set-face-attribute 'nano-critical   nil :foreground muted-rose)
  (set-face-attribute 'nano-critical-i nil :background muted-rose)
  (set-face-attribute 'nano-popout     nil :foreground vibrant-red)
  (set-face-attribute 'nano-popout-i   nil :background vibrant-red)
  (set-face-attribute 'nano-strong     nil :foreground almost-white)
  (set-face-attribute 'nano-strong-i   nil :background almost-white)
  (set-face-attribute 'nano-salient    nil :foreground pale-cyan)
  (set-face-attribute 'nano-salient-i  nil :background pale-cyan)
  (set-face-attribute 'nano-faded      nil :foreground pale-blue)
  (set-face-attribute 'nano-faded-i    nil :background pale-blue)
  (set-face-attribute 'nano-subtle     nil :foreground almost-white)
  (set-face-attribute 'nano-subtle     nil :background almost-blue)
  (set-face-attribute 'nano-subtle-i   nil :foreground almost-blue)
  (set-face-attribute 'nano-subtle-i   nil :background almost-white)
  (set-face-attribute 'nano-modeline-active nil :background almost-blue)
  (set-face-attribute 'nano-modeline-active nil :foreground almost-gray)
  (setopt nano-modeline-faces '((header-active nano-modeline-active)
                                (header-inactive nano-modeline-inactive)
                                (footer-active nano-modeline-active)
                                (footer-inactive nano-modeline-inactive)
                                (status-RW-active nano-modeline-status)
                                (status-RO-active nano-modeline-status)
                                (status-**-active nano-modeline-status nano-popout-i)
                                (name-active bold)
                                (primary-active)
                                (secondary-active nano-modeline-active)))
  )

(setq my-current-theme-light t)

(defun my-toggle-theme ()
  (interactive)
  (if my-current-theme-light
      (progn (setq my-current-theme-light nil)
             (my-nano-dark-muted))
    (setq my-current-theme-light t)
    (my-nano-light-muted)))

(bind-key "<f6>" #'my-toggle-theme ergoemacs-override-keymap)

#+end_src

** TODO Fonts :BUGFIX:

This is the font stack we install:

- Default font:  Roboto Mono 14pt Light       [[https://fonts.google.com/specimen/Roboto+Mono][]]
- /Italic font/:   Victor Mono 14pt Semilight   [[https://github.com/rubjo/victor-mono][]]
- *Bold font*:     Roboto Mono 14pt Regular     [[https://fonts.google.com/specimen/Roboto+Mono][]]
- Unicode font:  Inconsolata 16pt Light       [[https://github.com/googlefonts/Inconsolata][]]  TODO: Switch to Fira Code?
- Icon font:     Roboto Mono Nerd 12pt Light  [[https://www.nerdfonts.com/][]]
- Serif font:
- math font:

Text excerpt using a /gorgeous/ and true italic font (Victor Mono),
chosen to really *stand out* from the default font (Roboto Mono).
┌─────────────────────────────────────────────────────────────────┐
│   The quick brown fox jumps over the lazy dog                  │
│   /The quick brown fox jumps over the lazy dog/                  ┼─ Victor Mono Italic
│   *The quick brown fox jumps over the lazy dog*                  ├─ Roboto Mono Nerd
└─┼─────────────────────────────────────┼─────────────────────────┘
Roboto Mono Nerd                     Roboto Mono

Note that the Victor Mono needs to be hacked such as to have the same line height as Roboto Mono. To do that, you can use the [[https://github.com/source-foundry/font-line][font-line]] utility (github.com/source-foundry/font-line): \copy all the italic faces from the Victor Mono ttf file into a directoy and type: =font-line percent 10 *.ttf=. This will create a new set of files that you can use to replace the Victor Mono italic faces on your system.


#+begin_src emacs-lisp
(set-face-attribute 'default nil
                    :family "Roboto Mono"
                    :weight 'light
                    :height 140)

(set-face-attribute 'bold nil
                    :family "Roboto Mono"
                    :weight 'regular)

(set-face-attribute 'italic nil
                    :family "Victor Mono"
                    :weight 'semilight
                    :slant 'italic
                    :height (lambda (x)
                              (cond ((< x 100) (+ x 5))
                                    ((and (>= x 100) (< x 110)) 110)
                                    ((and (>= x 110) (< x 120)) 132)
                                    ((and (>= x 120) (< x 130)) 132)
                                    ((and (>= x 130) (< x 140)) 140)
                                    ((and (>= x 140) (< x 150)) 150)
                                    ((and (>= x 150) (< x 160)) 170)
                                    ((and (>= x 160) (< x 170)) 180)
                                    ((and (>= x 170) (< x 180)) 190)
                                    ((and (>= x 180) (< x 190)) 200)
                                    ((>= x 190) (round(* x 1.1)))))
                    )


(set-fontset-font t 'unicode "Roboto Mono Nerd")

(set-fontset-font t '(#xe000 . #xffdd) "Roboto Mono Nerd")

(set-fontset-font t 'emoji "Roboto Mono Nerd")

#+end_src


** Typography and layout

#+begin_src emacs-lisp

(setq-default fill-column 100                         ; Default line width
              sentence-end-double-space nil           ; Use a single space after dots
              bidi-paragraph-direction 'left-to-right ; Faster
              truncate-string-ellipsis "…")           ; Nicer ellipsis

#+end_src


#+begin_src emacs-lisp

(use-package visual-fill-column
  :ensure adaptive-wrap
  :custom (visual-fill-column-center-text t)
  :hook  (((LaTeX-mode org-mode) . visual-fill-column-mode)
          ((LaTeX-mode) . adaptive-wrap-prefix-mode)
          )
  )

#+end_src
Changing the symbol for truncation (…) and wrap (↩).

#+begin_src emacs-lisp

(require 'nano-theme)

;; Nicer glyphs for continuation and wrap
(set-display-table-slot standard-display-table
                        'truncation (make-glyph-code ?… 'nano-faded))

(defface wrap-symbol-face
  '((t (:family "Fira Code"
                :inherit nano-faded)))
  "Specific face for wrap symbol")

(set-display-table-slot standard-display-table
                        'wrap (make-glyph-code ?↩ 'wrap-symbol-face))

#+end_src

Fix a bug on OSX in term mode & zsh (spurious "%" after each command)

#+begin_src emacs-lisp

(when (eq system-type 'darwin)
  (add-hook 'term-mode-hook
            (lambda ()
              (setq buffer-display-table (make-display-table)))))

#+end_src

Make sure underline is positioned at the very bottom.

#+begin_src emacs-lisp

(setq x-underline-at-descent-line nil
      x-use-underline-position-properties t
      underline-minimum-offset 10)

#+end_src
** Benchmark

#+begin_src emacs-lisp

(my-report-time "Visual")

#+end_src


** Editing

#+begin_src emacs-lisp

(setq my-section-start-time (current-time))

#+end_src

** Default mode :HOOK:MODE:

Default & initial mode is text.

#+begin_src emacs-lisp

(setq-default initial-major-mode 'text-mode   ; Initial mode is text
              default-major-mode 'text-mode)  ; Default mode is text

#+end_src

Visual line mode for prog and text modes

#+begin_src emacs-lisp

(add-hook 'text-mode-hook 'visual-line-mode)
(add-hook 'prog-mode-hook 'visual-line-mode)

#+end_src

** Tabulations

No tabulation, ever.

#+begin_src emacs-lisp

;; Let Emacs guess Python indent silently
(setq python-indent-guess-indent-offset t
      python-indent-guess-indent-offset-verbose nil)

#+end_src

** Parenthesis :MODE:

We enable paren mode for highlighting matching parenthesis and rainbow-delimiters in order to be able to visually distinguish delimiters of different depths.

#+begin_src emacs-lisp

(use-package emacs
  :init (show-paren-mode t); Matches parentheses and such in every mode
  )

(use-package rainbow-delimiters
  :hook ((prog-mode org-mode LaTeX-mode) . rainbow-delimiters-mode)
  )

#+end_src

We need a small helper to distinguish between words and special characters  which should be treated differently.


#+begin_src emacs-lisp

(defvar my-backward-special-characters '".,:;!?(){}[]~@#$%^&*<>_=-+\\\"' \n\t/`")


(defun my-backward-word ()
  " muW4e want to go back by words in a smart way"
  (interactive)
  (if (string-search (string (preceding-char)) my-backward-special-characters)
      (backward-char)
    (backward-word))
  )

#+end_src

#+begin_src emacs-lisp

(use-package puni
  :hook ((text-mode prog-mode LaTeX-mode org-mode eval-expression-minibuffer-setup haskell-interactive-mode) . puni-mode)
  :bind (:map puni-mode-map
              ("C-<right>" . puni-slurp-forward)
              ("C-<left>"  . puni-barf-forward)
              ("M-<left>"  . puni-slurp-backward)
              ("M-<right>" . puni-barf-backward)
              ("C-x C-d"   . puni-splice)
              ("M-i"       . puni-squeeze)
              ("C-<up>"    . my-puni-rewrap)
              ("<left>"    . my-backward-word)
              ))

(defun my-puni-rewrap ()
  (interactive)
  (let*((next-delimiters (completing-read
                          "Rewrap the sexp at point with: "
                          '("(...)" "{...}" "[...]" "\\langle...\\rangle" "\\|...\\|"  "<...>" "\\left(...\\right)" )
                          nil
                          t
                          ))
        (opening-del "A"))
    (puni-squeeze)
    (insert (car (split-string next-delimiters "\\.+" t)))
    (yank)
    (insert (car (cdr (split-string next-delimiters "\\.+" t))))))

#+end_src

** Spell-checking

We set up multi-language lazy flyspell checks in text modes.

Now we can set up flyspell and guess-language.

#+begin_src emacs-lisp

(use-package flyspell
  :hook (text-mode org-mode latex-mode mu4e-compose-mode)
  :config
  (setq ispell-program-name "aspell")
  (setq ispell-list-command "--list")
  (setq ispell-alternate-dictionary "/usr/share/dict/en_GB.txt")
  )

;; (use-package flyspell-lazy
;;   :after flyspell
;;   :hook (text-mode org-mode latex-mode mu4e-compose-mode))

(use-package flyspell-correct
  :after flyspell
  :bind (:map ergoemacs-override-keymap ("M-t" . flyspell-correct-wrapper)))

;; (use-package flyspell-correct-popup
;;   :after flyspell-correct)

(use-package guess-language
  :hook (mu4e-compose-mode . guess-language-mode)
  :config
  (setq guess-language-langcodes '((en . ("en_GB" "English"))
                                   (de . ("de_DE" "German")))
        guess-language-languages '(en de)
        guess-language-min-paragraph-length 45))

(use-package mu4e
  :after flyspell
  :init (setq flyspell-generic-check-word-predicate  'mail-mode-flyspell-verify))
#+end_src

We use powerthesaurus for fancy word juggling.
#+begin_src emacs-lisp

;; (use-package powerthesaurus
;;   :ensure jeison
;;   )
#+end_src

** Imenu list

Imenu setup

#+begin_src emacs-lisp

(require 'imenu-list)

(setq-default imenu-list-position 'left
              imenu-max-item-length 1000)

#+end_src
** Highlighting :MODE:INACTIVE:

Highlighting of the current line (native mode)

#+begin_src emacs-lisp

;; (require 'hl-line)

;; (global-hl-line-mode)

#+end_src

** PDF Tools

For retina display (OSX)

#+begin_src emacs-lisp
;; (require 'pdf-tools)

(add-hook 'doc-view-mode-hook 'pdf-tools-install)

(setq-default pdf-view-use-scaling t
              pdf-view-use-imagemagick nil)

#+end_src

** Benchmark

#+begin_src emacs-lisp

(my-report-time "Editing")

#+end_src


** Versioning

#+begin_src emacs-lisp :prologue "" :epilogue ""

(setq my-section-start-time (current-time))

#+end_src

** Magit :ADVICE:HOOK:

** News :DEFER:
:PROPERTIES:
:header-args:emacs-lisp: :prologue "(with-eval-after-load 'elfeed" :epilogue ")"
:END:

#+begin_src emacs-lisp  :prologue "" :epilogue ""

(setq my-section-start-time (current-time))

#+end_src

** Read :HOOK:BINDING:

We use [[https://github.com/skeeto/elfeed][elfeed]] to keep in touch with (relevant) preprints.

#+begin_src emacs-lisp
(use-package elfeed
  :bind (:map elfeed-search-mode-map
              ("U" . elfeed-update )) ; Bind "U" to update feeds on main screen
  :hook ((elfeed-search-mode-hook  .my-elfeed-search-mode-hook)
         (elfeed-show-mode-hook .my-elfeed-show-mode-hook))
  :config
  (setq elfeed-search-title-max-width 80    ; Maximum titles width
        elfeed-search-title-min-width 40    ; Minimum titles width
        elfeed-search-trailing-width 24     ; Space reserved for feed & tag
        elfeed-search-filter                ; Default filter
        "@1-weeks-ago +unread"
        elfeed-search-print-entry-function  ; Alternative print function
        #'my-elfeed-search-print-entry)
  )
#+end_src

We try to rank papers by using elfeed-score.

#+begin_src emacs-lisp
(use-package elfeed-score
  :after elfeed
  :hook (elfeed-search-update-hook  .elfeed-score-score-search)
  :config
  (setq elfeed-score-serde-score-file "~/.emacs.org/elfeed.score")
  (elfeed-score-load-score-file "~/.emacs.org/elfeed.score") ; See the elfeed-score documentation for the score file syntax
  (elfeed-score-enable)
  (define-key elfeed-search-mode-map "=" elfeed-score-map)
  )
#+end_src

We separate author by commas and have at most three.

#+begin_src emacs-lisp
(defun concatenate-authors (authors-list)
  "Given AUTHORS-LIST, list of plists; return string of all authors
concatenated."
  (if (>(length authors-list) 3)
      (let ((short-authors (seq-subseq authors-list 0 3)))
        (concat (mapconcat
                 (lambda (author) (plist-get author :name))
                 short-authors ", ") " et.al"))
    (mapconcat
     (lambda (author) (plist-get author :name))
     authors-list ", ")))
#+end_src

Next we shorten feed titles. At the moment this is hard-coded.

#+begin_src emacs-lisp
(defun short-feed-titles (feed-title)
  "Given a feed-title, we return its shortened version."
  (cond ((string= feed-title "Quantum groups, skein theories, operadic and diagrammatic algebra, quantum field theory") "math.QA")
        ((string= feed-title "Enriched categories, topoi, abelian categories, monoidal categories, homological algebra") "math.CT")
        ((string= feed-title "Homotopy theory, homological algebra, algebraic treatments of manifolds") "math.AT")
        ((string= feed-title "Non-commutative rings and algebras, non-associative algebras, universal algebra and lattice theory, linear algebra, semigroups") "math.RA")
        (t feed-title)))

#+end_src

We print entries very nicely
#+begin_src emacs-lisp
(defun my-elfeed-search-print-entry (entry)
  "Print ENTRY to the buffer."
  (let*
      ((date (elfeed-search-format-date (elfeed-entry-date entry)))
       (title (or (elfeed-meta entry :title)
                  (elfeed-entry-title entry) ""))
       (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
       (feed (elfeed-entry-feed entry))
       (feed-title (short-feed-titles (when feed
                                        (or (elfeed-meta feed :title) (elfeed-feed-title feed)))))
       (entry-authors (concatenate-authors
                       (elfeed-meta entry :authors)))
       (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
       (tags-str (mapconcat
                  (lambda (s) (propertize s 'face
                                          'elfeed-search-tag-face))
                  tags ","))
       (title-width (- (window-width) 10
                       elfeed-search-trailing-width))
       (title-column (elfeed-format-column
                      title (elfeed-clamp
                             elfeed-search-title-min-width
                             title-width
                             elfeed-search-title-max-width)
                      :left))
       (authors-width 80)
       (authors-column (elfeed-format-column
                        entry-authors (elfeed-clamp
                                       elfeed-search-title-min-width
                                       authors-width
                                       131)
                        :left)))

    (insert (propertize date 'face 'elfeed-search-date-face) " ")

    (insert (propertize title-column
                        'face title-faces 'kbd-help title) " ")

    (insert (propertize authors-column
                        'face 'elfeed-search-date-face
                        'kbd-help entry-authors) " ")

    (when entry-authors
      (insert (propertize feed-title
                          'face 'elfeed-search-feed-face) " "))

    )
  )

#+end_src


Hook on elfeed main screen (hl-line mode).

#+name: my-elfeed-search-mode-hook
#+begin_src emacs-lisp

(defun my-elfeed-search-mode-hook ()
  (hl-line-mode t)
  (face-remap-add-relative 'hl-line :inherit 'nano-subtle)
  (set-window-fringes nil 0 1) ; One pixel right fringe to avoid ellipsis
  (setq cursor-type nil))

#+end_src

Hook on elfeed post screen (visual mode).

#+name: my-elfeed-show-mode-hook
#+begin_src emacs-lisp

(defun my-elfeed-show-mode-hook ()
  (visual-line-mode)
  (setq truncate-lines t)

  (let ((inhibit-read-only t)
        (inhibit-modification-hooks t))
    (setq-local truncate-lines nil)
    (setq-local shr-width 79)
    (set-buffer-modified-p nil)))

#+end_src



** Bookmarks

Setup bookmarks ([[file:elfeed.org][elfeed.org]]) using [[https://github.com/remyhonig/elfeed-org][elfeed-org]]. It is important to load it after elfeed such as to not load org immediately.

#+begin_src emacs-lisp

(with-eval-after-load 'elfeed
  (require 'elfeed-org)
  (setq rmh-elfeed-org-files (list "~/.emacs.org/elfeed.org"))
  (elfeed-org))

#+end_src
** Elfeed-Dashboard

We give elfeed the mu4e looks and feel.

#+begin_src emacs-lisp
(use-package elfeed-dashboard
  :load-path "~/.emacs.d/lisp/elfeed-dashboard/"
  :config
  (setq elfeed-dashboard-file "~/.emacs.org/elfeed-dashboard.org")
  ;; update feed counts on elfeed-quit
  (advice-add 'elfeed-search-quit-window :after #'elfeed-dashboard-update-links))
#+end_src

** Benchmark

#+begin_src emacs-lisp  :prologue "" :epilogue ""

(my-report-time "News")

#+end_src


# * Notes (denote) :DEFER:
# :PROPERTIES:
# :header-args:emacs-lisp: :prologue "(with-eval-after-load 'denote" :epilogue ")"
# :END:

# #+begin_src emacs-lisp  :prologue "" :epilogue ""

# (setq my-section-start-time (current-time))

# #+end_src

# ** Configuration

# Samplet configuration from https://protesilaos.com/emacs/denote

# #+begin_src emacs-lisp

# (require 'denote)

# ;; Remember to check the doc strings of those variables.
# (setq denote-directory (expand-file-name "~/Documents/Denote/"))
# (setq denote-known-keywords
#       '("emacs" "research" "visualisation"))
# (setq denote-infer-keywords t)
# (setq denote-sort-keywords t)
# (setq denote-file-type nil) ; Org is the default, set others here

# ;; We allow multi-word keywords by default.  The author's personal
# ;; preference is for single-word keywords for a more rigid workflow.
# (setq denote-allow-multi-word-keywords t)

# (setq denote-front-matter-date-format nil) ; change this to `org-timestamp' or custom string

# ;; You will not need to `require' all those individually once the
# ;; package is available.
# (require 'denote-retrieve)
# (require 'denote-link)
# (require 'denote-dired)
# (setq denote-dired-rename-expert nil)

# ;; We use different ways to specify a path for demo purposes.
# (setq denote-dired-directories
#       (list denote-directory
#             (thread-last denote-directory (expand-file-name "attachments"))
#             (expand-file-name "~/Documents/vlog")))

# ;; Generic:
# ;; (add-hook 'dired-mode-hook #'denote-dired-mode)
# ;;
# ;; OR better:
# (add-hook 'dired-mode-hook #'denote-dired-mode-in-directories)

# ;; Here is a custom, user-level command from one of the examples we
# ;; showed in this manual.  We define it here and add it to a key binding
# ;; below.
# (defun my-denote-journal ()
#   "Create an entry tagged 'journal', while prompting for a title."
#   (interactive)
#   (denote
#    (denote--title-prompt)
#    "journal"))

# ;; Denote does not define any key bindings.  This is for the user to
# ;; decide.  For example:
# (let ((map global-map))
#   (define-key map (kbd "C-c n j") #'my-denote-journal) ; our custom command
#   (define-key map (kbd "C-c n n") #'denote)
#   (define-key map (kbd "C-c n N") #'denote-type)
#   (define-key map (kbd "C-c n d") #'denote-date)
#   ;; If you intend to use Denote with a variety of file types, it is
#   ;; easier to bind the link-related commands to the `global-map', as
#   ;; shown here.  Otherwise follow the same pattern for `org-mode-map',
#   ;; `markdown-mode-map', and/or `text-mode-map'.
#   (define-key map (kbd "C-c n i") #'denote-link) ; "insert" mnemonic
#   (define-key map (kbd "C-c n I") #'denote-link-add-links)
#   (define-key map (kbd "C-c n l") #'denote-link-find-file) ; "list" links
#   (define-key map (kbd "C-c n b") #'denote-link-backlinks)
#   ;; Note that `denote-dired-rename-file' can work from any context, not
#   ;; just Dired bufffers.  That is why we bind it here to the
#   ;; `global-map'.
#   (define-key map (kbd "C-c n r") #'denote-dired-rename-file))

# (with-eval-after-load 'org-capture
#   (require 'denote-org-capture)
#   (setq denote-org-capture-specifiers "%l\n%i\n%?")
#   (add-to-list 'org-capture-templates
#                '("n" "New note (with denote.el)" plain
#                  (file denote-last-path)
#                  #'denote-org-capture
#                  :no-save t
#                  :immediate-finish nil
#                  :kill-buffer t
#                  :jump-to-captured t)))

# #+end_src


# ** Benchmark

# #+begin_src emacs-lisp  :prologue "" :epilogue ""

# (my-report-time "Notes")

# #+end_src



# * Notes (deft) :DEFER:
# :PROPERTIES:
# :header-args:emacs-lisp: :prologue "(with-eval-after-load 'deft" :epilogue ")"
# :END:

# #+begin_src emacs-lisp  :prologue "" :epilogue ""

# (setq my-section-start-time (current-time))

# #+end_src

# ** Read :HOOK:BUGFIX:

# Deft setup

# #+begin_src emacs-lisp

# (setq deft-default-extension "org"
#       deft-extensions '("org")
#       deft-recursive nil
#       deft-use-filename-as-title nil
#       deft-use-filter-string-for-filename t
#       deft-file-naming-rules '((noslash . "-")
#                                (nospace . "-")
#                                (case-fn . downcase))
#       deft-separator " "
#       deft-time-format " %d %b %Y")

# #+end_src

# Rewrite the ~deft-print-header~ function to get rid of "Deft\n"

# #+begin_src emacs-lisp

# (defun deft-print-header ()
#   (force-mode-line-update))

# #+end_src

# Bug fix (see https://github.com/jrblevin/deft/issues/73)

# #+begin_src emacs-lisp

# (defun org-open-file-with-emacs (path)
#   (org-open-file path t))

# #+end_src

# A small bugfix for header that are too long by one character.

# #+begin_src emacs-lisp
# (defun deft-setup ()

#   (face-remap-add-relative 'hl-line :inherit 'nano-salient-i)
#   (set-window-fringes nil 0 1)
#   (set-default 'truncate-lines t))

# (add-hook 'deft-mode-hook #'deft-setup)

# #+end_src

# ** Keywords :ADVICE:

# #+begin_src emacs-lisp

# (defun my-deft-parse-summary (orig-fun contents title)
#   "Filter deft summary in order to extract the first dot
# terminated sentence and add tags if any."

#   (let ((summary (apply orig-fun (list contents title)))
#         (tags nil))
#     (when (and (stringp contents)
#                (string-match "#\\+TAGS:\\(.*\\)$" contents))
#       (setq tags (split-string (string-trim (match-string 1 contents))
#                                  "[ ,]")))
#     (if (and (stringp summary)
#              (string-match "\\(.*?\\)\\. " summary))
#         (concat
#          (when tags
#            (concat (propertize (car tags)
#                                'display (svg-tag-make (car tags)
#                                                       :face 'nano-popout
#                                                       :inverse t))
#                    " "))
#          (match-string 1 summary))
#       summary)))

# (advice-add 'deft-parse-summary :around #'my-deft-parse-summary)

# #+end_src


# #+begin_src emacs-lisp

# (defun deft-note-toggle-keywords ()
#   "Toggle visibility of all keywords."

#   (interactive)
#   (save-excursion
#     (goto-char (point-min))
#     (re-search-forward "^\\(#\\+.*\\)$" nil t)
#     (if (get-text-property (match-beginning 1) 'display)
#         (deft-note-show-keywords)
#       (deft-note-hide-keywords))))

# (defun deft-note-hide-keywords ()
#   "Hide all keywords."

#   (interactive)
#   (save-excursion
#     (goto-char (point-min))
#     (while (re-search-forward "^\\(#\\+.*\\)$" nil t)
#       ;; (message (format "Hiding keyword %s" (match-string 1)))
#       (put-text-property
#         (match-beginning 1) (+ (match-end 1) 1) 'display ""))))

# (defun deft-note-show-keywords ()
#   "Show all keywords."

#   (interactive)
#   (save-excursion
#     (goto-char (point-min))
#     (while (re-search-forward "^\\(#\\+.*\\)$" nil t)
#       ;; (message (format "Showing keyword %s" (match-string 1)))
#       (remove-text-properties
#         (match-beginning 1) (+ (match-end 1) 1) '(display)))))

# (defun deft-note-get-keyword (keyword)
#   "Get the value of a KEYWORD"

#   (interactive)
#   (let ((case-fold-search t)
#         (re (format "^#\\+%s:[ \t]+\\([^\t\n]+\\)" keyword)))
#     (if (save-excursion (or (re-search-forward re nil t)
#                             (re-search-backward re nil t)))
#         (substring-no-properties (match-string 1)))))

# (defun deft-note-set-keyword (keyword value)
#   "Set the VALUE of KEYWORD, creates it if absent."
#   (interactive)
#   (save-excursion
#     (goto-char (point-min))
#     (if (deft-note-get-keyword keyword)
#         (replace-match value t nil nil 1)
#       (insert (format "#+%s: %s\n" keyword value)))))

# #+end_src

# ** Write :HOOK:

# Setup note modes and ask for a title if the file does not exist

# #+begin_src emacs-lisp
# (defun my-deft-open-file ()
#   "Setup note modes and ask for a title if the file does not exist."

#   (when (= (buffer-size (current-buffer)) 0)
#     (setq title (read-from-minibuffer "Note title: "))
#     (deft-note-set-keyword "DATE" (format-time-string "[%Y-%m-%d %a]"))
#     (deft-note-set-keyword "TITLE" (if (> (length title) 0)
#                                        title
#                                      "New note"))
#     (org-mode)
#     (org-indent-mode)
#     (visual-line-mode)))

# (add-hook 'deft-open-file-hook 'my-deft-open-file)

# #+end_src

# ** Benchmark

# #+begin_src emacs-lisp  :prologue "" :epilogue ""

# (my-report-time "Notes")

# #+end_src


** System
#+begin_src emacs-lisp  :prologue "" :epilogue ""

(setq my-section-start-time (current-time))

#+end_src

** Term & shell :ADVICE:

Set default shell (zsh)

#+begin_src emacs-lisp

(setq-default shell-file-name          "/bin/zsh"
              explicit-shell-file-name "/bin/zsh"
              explicit-zsh-args '("--interactive" "--login"))

#+end_src

Make sure our environment variables are set properly

#+begin_src emacs-lisp

(require 'exec-path-from-shell)
(exec-path-from-shell-copy-envs '("LANG" "LC_ALL" "LC_CTYPES" "PATH"))

#+end_src


Kill term buffer when exiting.

#+begin_src emacs-lisp

(defun my-term-handle-exit (&optional proc msg)
  "Kill term buffer (advice)."

  (message "%s | %s" proc msg)
  (kill-buffer (current-buffer)))

(advice-add 'term-handle-exit :after 'my-term-handle-exit)

#+end_src

** OSX :OS:

Open an iterm (OSX) and go to the curent directory

#+begin_src emacs-lisp

(defun my-iterm-here ()
  (interactive)

  (shell-command "open -a iTerm $PWD" nil nil))

#+end_src

** Benchmark

#+begin_src emacs-lisp  :prologue "" :epilogue ""

(my-report-time "System")

#+end_src


** TODO Miscellaneous
For all the small additional goodies that make life a bit easier.
** Dashboard

Emacs-dashboard is used as the splash screen to show current tasks and projects
#+begin_src emacs-lisp
(use-package dashboard
  :straight (:type git :host github :repo "emacs-dashboard/emacs-dashboard")
  :ensure t
  :config
  (dashboard-setup-startup-hook)
  (setq dashboard-items '((recents  . 5)
                          (bookmarks . 5)
                          (projects . 5)
                          (agenda . 5)))
  )

#+end_src

** Spotify
We use smudge to control spotify from within emacs.

#+begin_src emacs-lisp
(use-package smudge
  :custom
  (setq smudge-oauth2-client-secret "307ee557e2724f4c966b76cb343403a5"
        smudge-oauth2-client-id "8af15fa300304341a0e1bcbe09165e27")
  :bind
  (("<f7>" . smudge-controller-toggle-play)
   ("<f8>" . smudge-controller-next-track)
   ;; :map smudge-command-map
   ;; ("RET" . smudge-track-select)
   )
  )
#+end_src

** Singular

Singular is a computer algebra program with an emacs shell. We load it here
#+begin_src emacs-lisp
(use-package singular)
#+end_src

** Finishing up
** TODO Some cosmetics
We use our customisation of the nano theme.
#+begin_src emacs-lisp

(my-nano-light-muted)
#+end_src
** Final report

#+begin_src emacs-lisp

(let ((init-time (float-time (time-subtract (current-time) my-init-start-time)))
      (total-time (string-to-number (emacs-init-time "%f"))))

  (message "---------------------------------------------------------------")
  (message "Initialisation time:                 %.2fs (+ %.2f system time)"
           init-time (- total-time init-time)))
(message "---------------------------------------------------------------")

#+end_src

** NOT YET INTEGRATED

** Maxima
See [[https://gitlab.com/sasanidas/maxima][maxima]]

#+begin_src emacs-lisp
(use-package maxima
  :straight (maxima :type git :flavor melpa :files ("maxima.el" "maxima-font-lock.el" ("keywords" "keywords/*") "maxima-pkg.el") :host gitlab :repo   "sasanidas/maxima")
  :bind (:map maxima-inferior-mode-map ("TAB" . maxima-complete))
  (:map maxima-mode-map          ("TAB" . maxima-complete))
  :init
  (setq org-format-latex-options (plist-put org-format-latex-options :scale 2.0)
        maxima-display-maxima-buffer nil)
  (add-to-list 'auto-mode-alist
               (cons "\\.mac\\'" 'maxima-mode))
  (add-to-list 'interpreter-mode-alist
               (cons "maxima" 'maxima-mode)))
#+end_src
** Visual regexp

#+begin_src emacs-lisp
(use-package visual-regexp
  :straight (:host github :repo "benma/visual-regexp.el")
  :bind (:map ergoemacs-override-keymap
              ("M-5" . vr/query-replace)
              ("M-%" . vr/query-replace)))
#+end_src
** TODO ChatGPT
#+begin_src emacs-lisp
;; CHATGPT

(use-package gptel
  :straight (:host github :repo "karthink/gptel"))

;; (use-package emacs
;;   :init (column-number-mode)
;;   )

;; (global-visual-line-mode 1); Proper line wrapping
;; (setq visible-bell t); Flashes on error

;; (savehist-mode 1)
;; (setq save-interprogram-paste-before-kill t ; clipboard text is saved to the kill-ring
;;       apropos-do-all t
;;       ediff-window-setup-function 'ediff-setup-windows-plain)

(define-key key-translation-map (kbd "<AltGr>") (kbd "<menu>")) ;; To allow for menu modifier on laptops
(bind-key (kbd "C-)") nil 'ergoemacs-override-keymap)
(bind-key (kbd "M-<right>") nil 'ergoemacs-override-keymap)
(bind-key (kbd "M-<left>") nil 'ergoemacs-override-keymap)

(require 'all-the-icons)      ;; Better handeling of icons
(require 'projectile)         ;; Projectile offers a 'project-based' logic

;; Where the projects are to be searched
(setq projectile-project-search-path '(("~/Documents/mathematics/research/" . 3)))


(let ((init-time (float-time (time-subtract (current-time) my-init-start-time)))
      (total-time (string-to-number (emacs-init-time "%f"))))

  (message "---------------------------------------------------------------")
  (message "Final initialisation time:             %.2fs (+ %.2f system time)"
           init-time (- total-time init-time)))
(message "---------------------------------------------------------------")
#+end_src
** TODO Org Timeblock

#+begin_src emacs-lisp
(use-package org-timeblock
  :straight (org-timeblock :type git
                           :host github
                           :repo "ichernyshovvv/org-timeblock")
  :bind (:map ergoemacs-override-keymap ("M-n" . org-timeblock))
  :custom
  (org-timeblock-scale-options '(7 . 21))
  (org-timeblock-span 7))
#+end_src
